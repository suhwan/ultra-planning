---
phase: 02-core-planning
plan: 07
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - .claude/commands/ultraplan-plan-phase.md
autonomous: true

must_haves:
  truths:
    - "User can run /ultraplan:plan-phase N to generate PLAN.md files"
    - "Command invokes planner in phase-planning mode"
    - "PLAN.md files are created in .planning/phases/{phase-name}/"
    - "Wave structure is pre-computed from task dependencies"
  artifacts:
    - path: ".claude/commands/ultraplan-plan-phase.md"
      provides: "Entry point command for phase-specific PLAN.md generation"
      contains: "ultraplan-planner"
      min_lines: 40
  key_links:
    - from: ".claude/commands/ultraplan-plan-phase.md"
      to: ".claude/agents/ultraplan-planner.md"
      via: "Task tool spawning planner in phase-planning mode"
      pattern: "Task.*ultraplan-planner"
---

<objective>
Create the /ultraplan:plan-phase command that invokes the Planner agent in phase-planning mode.

Purpose: Provide the user-facing entry point that triggers PLAN.md generation for a specific phase, satisfying success criterion 3 ("Planner agent generates PLAN.md with task breakdowns for each phase").

Output: `.claude/commands/ultraplan-plan-phase.md` command file
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-planning/02-RESEARCH.md
@.planning/phases/02-core-planning/02-03-SUMMARY.md
@.claude/skills/ultraplan/SKILL.md
@.claude/skills/ultraplan/templates/plan.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plan-phase Command</name>
  <files>.claude/commands/ultraplan-plan-phase.md</files>
  <action>
Create the command file with:

1. Frontmatter:
```yaml
---
name: ultraplan:plan-phase
description: Generate PLAN.md files for a specific phase by invoking the Planner agent in phase-planning mode
allowed-tools: Read, Write, Glob, Grep, Bash, Task
---
```

2. Command Logic:
```markdown
# /ultraplan:plan-phase

Generate detailed PLAN.md files for a specific phase.

## Usage

```
/ultraplan:plan-phase {phase_number}
/ultraplan:plan-phase 1
/ultraplan:plan-phase 2
```

## Behavior

When user runs `/ultraplan:plan-phase N`:

1. **Validate Prerequisites**
   - Check ROADMAP.md exists (error if not: "Run /ultraplan:new-project first")
   - Check phase N exists in ROADMAP.md
   - Check prior phases are planned (warn if gaps)

2. **Load Phase Context**
   - Read ROADMAP.md for phase goal and success criteria
   - Read PROJECT.md for constraints and scope
   - Read STATE.md for current progress
   - Check for existing PLAN.md files in phase directory

3. **Spawn Planner Agent**
   Use Task tool to invoke `ultraplan-planner` in phase-planning mode:

   ```
   Task(
     subagent_type="ultraplan-planner",
     model="opus",
     prompt="""
You are planning Phase {N}: {phase_name}.

## Mode
PHASE-PLANNING (not new-project)

## Phase Goal
{phase_goal_from_roadmap}

## Success Criteria
{success_criteria_from_roadmap}

## Project Context
@PROJECT.md
@ROADMAP.md

## Instructions
1. Break phase into 2-3 task groups (PLAN.md files)
2. Apply task decomposition (15-60 min per task)
3. Compute wave assignments from dependencies
4. Derive must_haves using goal-backward methodology
5. Write PLAN.md files to .planning/phases/{phase-name}/

Output: {N}-01-PLAN.md, {N}-02-PLAN.md, etc.
"""
   )
   ```

4. **Planner Generates Plans**
   - Planner decomposes phase into tasks
   - Planner groups tasks into plans (2-3 tasks each)
   - Planner assigns waves based on dependencies
   - Planner writes PLAN.md files

5. **Display Summary**
   After plan generation, show:
   ```
   ## Phase {N} Planning Complete

   **Plans Created:** {count}
   **Wave Structure:**
   - Wave 1: {plan-01}, {plan-02} (parallel)
   - Wave 2: {plan-03} (depends on Wave 1)

   **Next Steps:**
   - Execute: `/ultraplan:execute-phase {N}`
   - Review plans in .planning/phases/{phase-name}/
   ```

## Error Handling

| Error | Response |
|-------|----------|
| ROADMAP.md missing | "No project found. Run /ultraplan:new-project first." |
| Invalid phase number | "Phase {N} not found in ROADMAP.md" |
| Phase already planned | "Phase {N} already has plans. Re-plan? (yes/no)" |
| Agent spawn fails | "Failed to start planner. Try again or run manually." |
```
  </action>
  <verify>
cat .claude/commands/ultraplan-plan-phase.md | head -40
grep -c "ultraplan-planner" .claude/commands/ultraplan-plan-phase.md
grep -c "PHASE-PLANNING" .claude/commands/ultraplan-plan-phase.md
  </verify>
  <done>Command file created with phase-planning mode invocation and Task tool usage</done>
</task>

<task type="auto">
  <name>Task 2: Update SKILL.md Command Reference</name>
  <files>.claude/skills/ultraplan/SKILL.md</files>
  <action>
Update SKILL.md to include the plan-phase command:

1. Add to Commands table:
```markdown
| Command | Description |
|---------|-------------|
| `/ultraplan:new-project` | Initialize new project with PROJECT.md, ROADMAP.md |
| `/ultraplan:plan-phase N` | Generate PLAN.md files for phase N |
| `/ultraplan:status` | Show current project state and progress |
```

2. Update Quick Start workflow:
```markdown
## Quick Start

1. Run `/ultraplan:new-project` to initialize
2. Answer the planner's questions (one at a time)
3. Review generated PROJECT.md and ROADMAP.md
4. Approve to continue
5. **Run `/ultraplan:plan-phase 1` to create detailed plans**
6. Execute plans with `/ultraplan:execute-phase 1`
```

3. Add to directory structure:
```markdown
.claude/commands/
├── ultraplan-new-project.md   # Initialize project
└── ultraplan-plan-phase.md    # Generate phase plans
```
  </action>
  <verify>
grep -c "plan-phase" .claude/skills/ultraplan/SKILL.md
grep -c "Generate PLAN.md" .claude/skills/ultraplan/SKILL.md
  </verify>
  <done>SKILL.md updated with plan-phase command reference</done>
</task>

</tasks>

<verification>
1. Command file exists: `ls -la .claude/commands/ultraplan-plan-phase.md`
2. Command references planner: `grep "ultraplan-planner" .claude/commands/ultraplan-plan-phase.md`
3. Command uses Task tool: `grep "Task(" .claude/commands/ultraplan-plan-phase.md`
4. Phase-planning mode documented: `grep "PHASE-PLANNING" .claude/commands/ultraplan-plan-phase.md`
5. SKILL.md updated: `grep "plan-phase" .claude/skills/ultraplan/SKILL.md`
6. File length: `wc -l .claude/commands/ultraplan-plan-phase.md` (should be >= 40)
</verification>

<success_criteria>
- [ ] `ultraplan-plan-phase.md` command file created
- [ ] Command validates prerequisites (ROADMAP.md exists)
- [ ] Command spawns ultraplan-planner via Task tool
- [ ] Planner receives phase-planning mode context
- [ ] Phase goal and success criteria passed to planner
- [ ] Wave structure displayed after generation
- [ ] Error handling documented
- [ ] SKILL.md updated with command reference
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-planning/02-07-SUMMARY.md`
</output>
