---
phase: 02-core-planning
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - .claude/commands/ultraplan-new-project.md
autonomous: true

must_haves:
  truths:
    - "User sees interview begin after running /ultraplan:new-project"
    - "Planner asks ONE question at a time during interview"
    - "Planner has project context available (directory, existing code status)"
  artifacts:
    - path: ".claude/commands/ultraplan-new-project.md"
      provides: "Entry point command for new project initialization"
      contains: "ultraplan-planner"
      min_lines: 30
  key_links:
    - from: ".claude/commands/ultraplan-new-project.md"
      to: ".claude/agents/ultraplan-planner.md"
      via: "Task tool spawning planner agent"
      pattern: "ultraplan-planner"
---

<objective>
Create the /ultraplan:new-project command that invokes the Planner agent.

Purpose: Provide the user-facing entry point that starts the planning workflow by spawning the Planner agent with appropriate context.

Output: `.claude/commands/ultraplan-new-project.md` command file
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-planning/02-RESEARCH.md
@.planning/phases/02-core-planning/02-01-SUMMARY.md
@.claude/skills/ultraplan/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Command Directory Structure</name>
  <files>.claude/commands/</files>
  <action>
Create the commands directory if it doesn't exist:
1. Check if `.claude/commands/` exists
2. If not, create it
3. The directory will hold command entry points that can be invoked via `/ultraplan:*`

Note: Commands in Claude Code are Markdown files that instruct Claude how to respond when the user types a slash command.
  </action>
  <verify>
ls -la .claude/commands/ 2>/dev/null || echo "Directory needs creation"
  </verify>
  <done>Commands directory exists at .claude/commands/</done>
</task>

<task type="auto">
  <name>Task 2: Create new-project Command</name>
  <files>.claude/commands/ultraplan-new-project.md</files>
  <action>
Create the command file with:

1. Frontmatter:
```yaml
---
name: ultraplan:new-project
description: Initialize a new Ultra Planner project with PROJECT.md, ROADMAP.md, and STATE.md
allowed-tools: Read, Write, Glob, Grep, Bash, Task
---
```

2. Command Logic:
```markdown
# /ultraplan:new-project

Initialize a new project with Ultra Planner.

## Behavior

When user runs `/ultraplan:new-project`:

1. **Check Existing State**
   - If PROJECT.md exists: Ask "Project exists. Start fresh or continue?"
   - If .ultraplan/ exists with state: Offer to resume

2. **Spawn Planner Agent**
   Use the Task tool to invoke the ultraplan-planner agent:

   ```
   Task(
     subagent_type="ultraplan-planner",
     model="opus",
     prompt="""
You are helping the user start a new project.

## Mode
NEW-PROJECT (full interview flow)

## Project Hint
{user_description_or_directory_name}

## Environment
Current directory: {pwd}
Directory name: {basename of pwd}

## Existing Code
{If package.json/pyproject.toml/Cargo.toml exists: "Brownfield - existing codebase detected"}
{If no manifest files: "Greenfield - new project"}

## Instructions
1. Begin interview - ask ONE question at a time
2. Build on previous answers
3. After 5-7 questions or user says "make the plan", generate documents
4. Display summary and wait for explicit approval

Begin now with your first question.
"""
   )
   ```

3. **Planner Takes Over**
   - Planner conducts interview (one question at a time)
   - Planner generates PROJECT.md, ROADMAP.md, STATE.md
   - Planner displays summary and requests review

## Context Assembly

Before spawning planner, gather context:
```bash
# Get directory info
CURRENT_DIR=$(pwd)
DIR_NAME=$(basename "$CURRENT_DIR")

# Check for existing project
if [[ -f "PROJECT.md" ]]; then
  EXISTING="yes"
else
  EXISTING="no"
fi

# Check for existing codebase (brownfield detection)
if [[ -f "package.json" ]] || [[ -f "pyproject.toml" ]] || [[ -f "Cargo.toml" ]]; then
  CODEBASE="brownfield"
else
  CODEBASE="greenfield"
fi
```

## Exit Conditions

- User says "cancel" → Abort gracefully
- Planner generates documents → Show summary, wait for approval
- User approves → Offer "/ultraplan:plan-phase 1" next
```

3. Error Handling:
```markdown
## Error Handling

| Error | Response |
|-------|----------|
| No write permission | "Cannot create files. Check directory permissions." |
| Agent spawn fails | "Failed to start planner. Try again or run manually." |
| User cancels | "Project initialization cancelled." |
```
  </action>
  <verify>
cat .claude/commands/ultraplan-new-project.md | head -30
grep -c "ultraplan-planner" .claude/commands/ultraplan-new-project.md
  </verify>
  <done>Command file created with planner invocation logic and error handling</done>
</task>

<task type="auto">
  <name>Task 3: Update SKILL.md Command Reference</name>
  <files>.claude/skills/ultraplan/SKILL.md</files>
  <action>
Update SKILL.md to reference the command correctly:

1. Ensure the Commands table includes:
```markdown
| Command | Description |
|---------|-------------|
| `/ultraplan:new-project` | Initialize new project with PROJECT.md, ROADMAP.md |
| `/ultraplan:status` | Show current project state and progress |
```

2. Update Quick Start to reference command file:
```markdown
## Quick Start

1. Run `/ultraplan:new-project` to initialize
2. Answer the planner's questions (one at a time)
3. Review generated PROJECT.md and ROADMAP.md
4. Approve to continue, or request adjustments
```

3. Add reference to commands directory in structure:
```markdown
## Directory Structure

.claude/
├── agents/
│   └── ultraplan-planner.md  # Planning agent
├── commands/
│   └── ultraplan-new-project.md  # Entry command
└── skills/
    └── ultraplan/
        ├── SKILL.md
        ├── templates/
        └── references/
```
  </action>
  <verify>
grep -c "new-project" .claude/skills/ultraplan/SKILL.md
grep -c "commands/" .claude/skills/ultraplan/SKILL.md
  </verify>
  <done>SKILL.md updated with command reference and directory structure</done>
</task>

</tasks>

<verification>
1. Commands directory exists: `ls -la .claude/commands/`
2. Command file exists: `ls -la .claude/commands/ultraplan-new-project.md`
3. Command references planner: `grep "ultraplan-planner" .claude/commands/ultraplan-new-project.md`
4. SKILL.md updated: `grep "commands/" .claude/skills/ultraplan/SKILL.md`
5. File length: `wc -l .claude/commands/ultraplan-new-project.md` (should be >= 30)
</verification>

<success_criteria>
- [ ] `.claude/commands/` directory exists
- [ ] `ultraplan-new-project.md` command file created
- [ ] Command has correct frontmatter with name and tools
- [ ] Command checks for existing project state
- [ ] Command spawns ultraplan-planner agent via Task tool
- [ ] Context is passed to planner (description, environment, codebase)
- [ ] Error handling documented
- [ ] SKILL.md updated with command reference
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-planning/02-04-SUMMARY.md`
</output>
