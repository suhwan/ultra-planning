# Phase 2.5 Research: Claude Tasks API Spike

## Executive Summary

Claude Tasks API는 Claude Code 내에서 태스크 관리를 위한 내장 도구입니다. 실험 결과, **PLAN.md ↔ Claude Tasks 양방향 동기화가 기술적으로 가능**합니다.

**Go/No-Go Decision: GO** - Phase 4 진행 권장

---

## 1. Claude Tasks API 기능 분석

### 1.1 사용 가능한 도구

| 도구 | 기능 | 파라미터 |
|------|------|----------|
| `TaskCreate` | 새 태스크 생성 | subject, description, activeForm, metadata |
| `TaskList` | 모든 태스크 목록 조회 | (없음) |
| `TaskGet` | 특정 태스크 상세 조회 | taskId |
| `TaskUpdate` | 태스크 수정 | taskId, status, subject, description, addBlocks, addBlockedBy, metadata |

### 1.2 태스크 상태 모델

```
pending → in_progress → completed
```

- `pending`: 시작 전
- `in_progress`: 작업 중
- `completed`: 완료

### 1.3 의존성 지원

```
addBlockedBy: ["1", "2"]  // 이 태스크는 #1, #2가 완료될 때까지 blocked
addBlocks: ["3", "4"]     // 이 태스크가 #3, #4를 block함
```

TaskList 출력에서 blocked 상태가 명시적으로 표시됨:
```
#2 [pending] Task name [blocked by #1]
```

### 1.4 메타데이터 지원

`metadata` 필드로 임의의 key-value 데이터 저장 가능:
```javascript
TaskUpdate({
  taskId: "1",
  metadata: {
    "planFile": "02-01-PLAN.md",
    "wave": 1,
    "taskIndex": 0
  }
})
```

---

## 2. PLAN.md ↔ Claude Tasks 매핑

### 2.1 PLAN.md Task 구조

```xml
<task type="auto">
  <name>Task 1: Create PlannerId class</name>
  <files>src/domain/PlannerId.ts</files>
  <action>Implementation details...</action>
  <verify>npm test</verify>
  <done>Acceptance criteria</done>
</task>
```

### 2.2 Claude Task 매핑

| PLAN.md 필드 | Claude Task 필드 |
|--------------|------------------|
| `<name>` | `subject` |
| `<action>` + `<done>` | `description` |
| `<name>` (동사형) | `activeForm` |
| wave 번호 | `metadata.wave` |
| 파일 경로 | `metadata.planFile` |
| task index | `metadata.taskIndex` |

### 2.3 변환 예시

**PLAN.md:**
```xml
<task type="auto">
  <name>Task 1: Create PlannerId class</name>
  <files>src/domain/PlannerId.ts</files>
  <action>Create the class with id, createdAt, version properties.</action>
  <verify>npm test</verify>
  <done>PlannerId class exists with validation</done>
</task>
```

**Claude Task:**
```javascript
TaskCreate({
  subject: "Task 1: Create PlannerId class",
  description: "Create the class with id, createdAt, version properties.\n\nAcceptance: PlannerId class exists with validation",
  activeForm: "Creating PlannerId class",
  metadata: {
    planFile: "02-01-PLAN.md",
    wave: 1,
    taskIndex: 0,
    files: "src/domain/PlannerId.ts",
    verify: "npm test"
  }
})
```

---

## 3. 양방향 동기화 설계

### 3.1 PLAN.md → Claude Tasks (Plan Load)

**트리거**: 플랜 실행 시작 시

**프로세스**:
1. PLAN.md 파싱하여 `<task>` 요소 추출
2. 각 task를 TaskCreate로 등록
3. Wave 기반으로 의존성 설정 (addBlockedBy)
4. metadata에 원본 위치 정보 저장

**의존성 매핑**:
```
Wave 1 tasks: blockedBy = []
Wave 2 tasks: blockedBy = [모든 Wave 1 task IDs]
Wave 3 tasks: blockedBy = [모든 Wave 2 task IDs]
```

### 3.2 Claude Tasks → PLAN.md (Status Sync)

**트리거**: 태스크 완료 시

**프로세스**:
1. TaskUpdate로 status를 completed로 변경
2. metadata에서 planFile, taskIndex 읽기
3. PLAN.md 파일에서 해당 task의 체크박스 업데이트

**PLAN.md 상태 표현**:
```markdown
## Tasks

- [x] Task 1: Create PlannerId class (completed 2026-01-26)
- [ ] Task 2: Add validation logic
- [ ] Task 3: Create templates
```

또는 XML 속성으로:
```xml
<task type="auto" status="completed" completed_at="2026-01-26T10:30:00Z">
```

---

## 4. 제한사항 및 고려사항

### 4.1 확인된 제한사항

| 제한 | 설명 | 영향 |
|------|------|------|
| 세션 범위 | Claude Tasks는 세션 내에서만 유지됨 | 세션 종료 시 태스크 목록 초기화 |
| 파일 비연동 | Claude Tasks는 파일과 자동 연동 안됨 | 수동 동기화 로직 필요 |
| ID 형식 | 단순 증가 정수 (1, 2, 3...) | UUID 매핑 필요할 수 있음 |

### 4.2 세션 지속성 해결책

Claude Tasks는 세션 종료 시 사라지므로, PLAN.md가 **Source of Truth** 역할:

```
세션 시작 시:
1. PLAN.md 읽기
2. 미완료 태스크를 Claude Tasks로 로드
3. 완료된 태스크는 로드하지 않음

세션 중:
1. Claude Tasks로 진행 상황 관리
2. 태스크 완료 시 PLAN.md 즉시 업데이트

세션 종료 시:
1. Claude Tasks 자동 소멸
2. PLAN.md에 상태 보존됨
```

### 4.3 충돌 처리

**시나리오**: PLAN.md 수동 편집 vs Claude Tasks 상태 불일치

**해결책**:
- PLAN.md를 항상 Source of Truth로 취급
- 세션 시작 시 PLAN.md에서 재로드
- 충돌 감지 시 사용자에게 경고

---

## 5. PoC 검증 결과

### 5.1 테스트 수행

```
✓ TaskCreate - 태스크 생성 성공
✓ TaskList - 목록 조회 성공
✓ TaskGet - 상세 조회 성공
✓ TaskUpdate(status) - 상태 변경 성공
✓ TaskUpdate(blockedBy) - 의존성 설정 성공
✓ 의존성 표시 - blocked by 표시 확인
```

### 5.2 성공 기준 충족 여부

| 성공 기준 | 상태 | 비고 |
|-----------|------|------|
| Claude Tasks API 기능/제한 문서화 | ✅ 충족 | 이 문서 |
| PLAN.md → Claude Tasks 변환 PoC | ✅ 가능 | 매핑 설계 완료 |
| Claude Tasks → PLAN.md 동기화 PoC | ✅ 가능 | 프로세스 설계 완료 |
| API 제한사항 식별 | ✅ 충족 | 세션 범위, 파일 비연동 |
| Go/No-Go 결정 | ✅ GO | 기술적 실현 가능 |

---

## 6. Phase 4 아키텍처 권장사항

### 6.1 권장 아키텍처

```
┌─────────────────┐     ┌─────────────────┐
│    PLAN.md      │◄───►│  Claude Tasks   │
│ (Source of Truth)│     │ (Session View)  │
└────────┬────────┘     └────────┬────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│   Task Parser   │     │  Task Loader    │
│ (XML → Struct)  │     │ (Struct → API)  │
└─────────────────┘     └─────────────────┘
```

### 6.2 구현 순서 권장

1. **Task Parser**: PLAN.md XML 파싱 로직
2. **Task Loader**: 파싱된 태스크를 Claude Tasks로 로드
3. **Status Syncer**: 완료 상태를 PLAN.md에 반영
4. **Conflict Detector**: 불일치 감지 및 경고

### 6.3 Phase 4 플랜 제안

```
04-01: Task Parser 구현 (XML → 구조체)
04-02: Task Loader 구현 (구조체 → Claude Tasks)
04-03: Status Syncer 구현 (Claude Tasks → PLAN.md)
04-04: Dependency Graph 분석 (Wave 기반 blockedBy 설정)
04-05: Conflict Detection 및 Resolution
04-06: Integration Testing
```

---

## 7. 결론

**Go/No-Go: GO**

Claude Tasks API는 PLAN.md와의 양방향 동기화에 적합합니다. 세션 범위 제한이 있지만, PLAN.md를 Source of Truth로 사용하면 해결 가능합니다.

Phase 4 진행을 권장하며, 위 아키텍처와 구현 순서를 따를 것을 제안합니다.

---

*Research completed: 2026-01-26*
*Researcher: Claude (Phase 2.5 Spike)*
