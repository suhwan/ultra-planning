---
phase: 03-sequential-execution
plan: 08
type: execute
wave: 3
depends_on: ["03-04", "03-05"]
files_modified:
  - .claude/skills/ultraplan/references/commit-protocol.md
  - .claude/agents/ultraplan-executor.md
autonomous: true

must_haves:
  truths:
    - "Completed tasks trigger atomic git commit after verification gate passes"
    - "Commit message follows conventional format with task reference"
    - "Only committed after Architect approval (verification gate)"
    - "Rollback protocol exists for reverting failed tasks"
    - "STATE.md logs commit hash for each completed task"
  artifacts:
    - path: ".claude/skills/ultraplan/references/commit-protocol.md"
      provides: "Complete atomic commit protocol reference"
      contains: "Commit Trigger Conditions"
      min_lines: 150
  key_links:
    - from: ".claude/agents/ultraplan-executor.md"
      to: ".claude/skills/ultraplan/references/commit-protocol.md"
      via: "Post-verification commit trigger"
      pattern: "commit-protocol"
---

<objective>
Define the atomic commit protocol that triggers after each task passes verification.

Purpose: Each completed task must be committed immediately to create a clean audit trail, enable git bisect for debugging, and allow independent task rollback. This fulfills requirement EXEC-05 (atomic commit on task completion).

Output: `.claude/skills/ultraplan/references/commit-protocol.md` with complete protocol, plus executor agent integration
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/ARCHITECTURE.md (Pattern 5: Atomic Commits per Task)
@.planning/phases/03-sequential-execution/03-01-PLAN.md
@.planning/phases/03-sequential-execution/03-04-PLAN.md
@.planning/phases/03-sequential-execution/03-05-PLAN.md
@.claude/skills/ultraplan/references/state-protocol.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Commit Protocol Reference with Trigger Conditions</name>
  <files>.claude/skills/ultraplan/references/commit-protocol.md</files>
  <action>
Create the atomic commit protocol reference document:

1. File header with overview:
```markdown
# Atomic Commit Protocol

## Overview

Each completed task triggers an atomic git commit AFTER passing the verification gate. This creates:
- Clean audit trail for every change
- Task-level rollback capability
- Git bisect support for debugging
- Clear history for session resumption

**Requirement:** EXEC-05 (Atomic commit - each task completion triggers immediate commit)

## Commit Trigger Conditions

A commit is triggered when ALL of the following are true:

| Condition | Check |
|-----------|-------|
| Task executed | Executor reported completion |
| Verification passed | `<verify>` command returned exit code 0 |
| Architect approved | Verification gate passed |
| Files modified | At least one file in `<files>` was changed |

**CRITICAL:** Never commit before Architect approval. The verification gate is the commit trigger.

### Trigger Flow

```
Executor completes task
        │
        ▼
Runs <verify> command
        │
        ▼
  Exit code 0? ──NO──► Retry loop (no commit)
        │
       YES
        ▼
Architect verifies
        │
        ▼
  Approved? ──NO──► Retry with feedback (no commit)
        │
       YES
        ▼
  ┌─────────────────┐
  │ TRIGGER COMMIT  │
  └─────────────────┘
        │
        ▼
Update STATE.md with commit hash
```

### No-Commit Scenarios

Do NOT commit when:
- Task failed verification
- Architect rejected the work
- No files were actually modified
- Task was blocked (never executed)
- User explicitly disabled auto-commit in config
```
  </action>
  <verify>
cat .claude/skills/ultraplan/references/commit-protocol.md | head -60
grep -c "Commit Trigger Conditions" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Architect approved" .claude/skills/ultraplan/references/commit-protocol.md
  </verify>
  <done>Commit protocol reference created with trigger conditions and flow diagram</done>
</task>

<task type="auto">
  <name>Task 2: Define Commit Message Format</name>
  <files>.claude/skills/ultraplan/references/commit-protocol.md</files>
  <action>
Add commit message format section:

```markdown
## Commit Message Format

### Convention

Commit messages follow Conventional Commits format with Ultra Planner extensions:

```
<type>(<phase>-<plan>): <task-description>

<body>

Plan: <phase>/<plan-number>
Task: <task-number>
Files: <file-count> modified
```

### Components

| Component | Description | Example |
|-----------|-------------|---------|
| type | Change type | feat, fix, refactor, docs, test |
| phase | Phase identifier | 03 |
| plan | Plan number | 08 |
| task-description | Brief summary | implement commit protocol |
| body | Optional details | What was done and why |
| Plan | Full plan reference | 03-sequential-execution/03-08 |
| Task | Task number from PLAN.md | 2 |
| Files | Count of modified files | 3 modified |

### Type Selection

| Type | When to Use |
|------|-------------|
| `feat` | New functionality added |
| `fix` | Bug or error corrected |
| `refactor` | Code restructured without behavior change |
| `docs` | Documentation only changes |
| `test` | Test additions or modifications |
| `chore` | Maintenance tasks (deps, config) |

### Examples

**Feature task:**
```
feat(03-08): implement atomic commit protocol

Create commit-protocol.md with trigger conditions,
message format, and rollback procedures.

Plan: 03-sequential-execution/03-08
Task: 1
Files: 1 modified
```

**Bug fix task:**
```
fix(02-03): correct wave dependency calculation

Wave assignment was incorrectly counting self-references.
Fixed dependency graph traversal to skip self.

Plan: 02-core-planning/02-03
Task: 4
Files: 2 modified
```

**Refactoring task:**
```
refactor(03-01): simplify executor result parsing

Consolidated three parsing functions into single parser.
No behavior change, improved maintainability.

Plan: 03-sequential-execution/03-01
Task: 3
Files: 1 modified
```

### Message Generation

The commit message is generated from task context:

```
type = infer_from_action(task.action)
phase = current_phase.number
plan = current_plan.number
description = task.name.replace("Task N: ", "").lower()
files_count = len(task.files_modified)

message = f"{type}({phase}-{plan:02d}): {description}\n\n{body}\n\nPlan: {phase_name}/{plan_file}\nTask: {task.number}\nFiles: {files_count} modified"
```
```
  </action>
  <verify>
grep -c "Commit Message Format" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Conventional Commits" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Type Selection" .claude/skills/ultraplan/references/commit-protocol.md
  </verify>
  <done>Commit message format section added with convention, components, and examples</done>
</task>

<task type="auto">
  <name>Task 3: Add Git Commands for Atomic Commit</name>
  <files>.claude/skills/ultraplan/references/commit-protocol.md</files>
  <action>
Add the git command sequence section:

```markdown
## Git Commands

### Commit Sequence

After verification gate passes, execute this sequence:

```bash
# Step 1: Stage only the files from task <files>
git add path/to/file1.ts path/to/file2.ts

# Step 2: Verify staging is correct
git status --porcelain

# Step 3: Create commit with formatted message
git commit -m "$(cat <<'EOF'
feat(03-08): implement atomic commit protocol

Create commit-protocol.md with trigger conditions,
message format, and rollback procedures.

Plan: 03-sequential-execution/03-08
Task: 1
Files: 1 modified
EOF
)"

# Step 4: Capture commit hash for STATE.md
COMMIT_HASH=$(git rev-parse --short HEAD)
echo "Committed: $COMMIT_HASH"
```

### Staging Rules

| Rule | Rationale |
|------|-----------|
| Stage only task files | Prevent unrelated changes from sneaking in |
| No `git add -A` | Explicit file list prevents accidents |
| No `git add .` | Same as above |
| Verify before commit | Catch staging errors before they're permanent |

### Pre-Commit Checks

Before creating the commit:

```bash
# Check for staged files
STAGED=$(git diff --cached --name-only)
if [ -z "$STAGED" ]; then
    echo "ERROR: No files staged for commit"
    exit 1
fi

# Check for unstaged changes in task files
for file in $TASK_FILES; do
    if git diff --name-only | grep -q "$file"; then
        echo "WARNING: $file has unstaged changes"
    fi
done

# Check for untracked task files
for file in $TASK_FILES; do
    if ! git ls-files --error-unmatch "$file" 2>/dev/null; then
        if [ -f "$file" ]; then
            echo "INFO: $file is new, will be added"
        fi
    fi
done
```

### Config-Based Behavior

Check `.ultraplan/config.json` for commit settings:

```json
{
  "workflow": {
    "auto_commit": true,
    "commit_docs": true
  }
}
```

| Setting | true | false |
|---------|------|-------|
| auto_commit | Commit after each task | Only commit on user request |
| commit_docs | Include .md files in commits | Skip documentation changes |

If `auto_commit: false`, log the pending commit but don't execute:

```yaml
pending_commit:
  task: "Task 3: Implement validation"
  files:
    - src/validation.ts
  message: "feat(03-08): implement validation"
  status: pending_user_commit
```
```
  </action>
  <verify>
grep -c "Git Commands" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Stage only task files" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "auto_commit" .claude/skills/ultraplan/references/commit-protocol.md
  </verify>
  <done>Git commands section added with staging rules and config-based behavior</done>
</task>

<task type="auto">
  <name>Task 4: Add Rollback/Revert Protocol</name>
  <files>.claude/skills/ultraplan/references/commit-protocol.md</files>
  <action>
Add rollback and revert protocols:

```markdown
## Rollback Protocol

### When to Rollback

Rollback may be needed when:
- Later task discovers previous task broke something
- User requests undo of specific task
- Integration test fails after multiple tasks
- Architect rejects work in subsequent review

### Rollback Strategies

#### Strategy 1: Revert Single Task

For reverting the most recent task:

```bash
# Revert the last commit (creates new commit)
git revert HEAD --no-edit

# Or, if you need to revert with custom message
git revert HEAD -m "revert(03-08): undo task 3 - validation broke auth"
```

#### Strategy 2: Revert Specific Task

For reverting a task from earlier in the sequence:

```bash
# Find the commit hash from STATE.md
TASK_COMMIT="abc1234"

# Revert that specific commit
git revert $TASK_COMMIT --no-edit

# Note: This may cause conflicts if later commits depend on it
```

#### Strategy 3: Reset to Checkpoint

For reverting multiple tasks (use with caution):

```bash
# Find the last known-good commit
CHECKPOINT="def5678"

# Soft reset (keeps changes as uncommitted)
git reset --soft $CHECKPOINT

# Hard reset (discards all changes) - DANGEROUS
git reset --hard $CHECKPOINT
```

### Rollback Decision Matrix

| Scenario | Strategy | Impact |
|----------|----------|--------|
| Last task broke tests | Revert HEAD | Low - clean undo |
| Task 3 of 5 has bug | Revert specific | Medium - may conflict |
| Multiple tasks broken | Reset to checkpoint | High - lose all work since |
| Need to redo approach | Reset soft + retry | Medium - keeps code visible |

### Conflict Resolution

When reverting causes conflicts:

1. **Identify conflict files:**
   ```bash
   git status | grep "both modified"
   ```

2. **Analyze the conflict:**
   - Original change (task being reverted)
   - Dependent change (later task)

3. **Resolution options:**
   | Option | When |
   |--------|------|
   | Accept revert | Later task doesn't need the change |
   | Accept current | Keep later task's version |
   | Manual merge | Combine both changes appropriately |

4. **After resolution:**
   ```bash
   git add <resolved-files>
   git revert --continue
   ```

### State Recovery

After rollback, update STATE.md:

```markdown
## Task Log

| Task | Status | Commit | Rolled Back |
|------|--------|--------|-------------|
| Task 1 | Complete | abc1234 | - |
| Task 2 | Complete | def5678 | - |
| Task 3 | Reverted | ghi9012 | jkl3456 |
```

Include:
- Original commit hash
- Revert commit hash
- Reason for rollback
- Any manual interventions needed
```
  </action>
  <verify>
grep -c "Rollback Protocol" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Revert Single Task" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Conflict Resolution" .claude/skills/ultraplan/references/commit-protocol.md
  </verify>
  <done>Rollback and revert protocols added with strategies and conflict resolution</done>
</task>

<task type="auto">
  <name>Task 5: Add Commit Logging to STATE.md</name>
  <files>.claude/skills/ultraplan/references/commit-protocol.md</files>
  <action>
Add STATE.md integration section:

```markdown
## STATE.md Integration

### Task Log Format

STATE.md maintains a commit log for all completed tasks:

```markdown
## Execution Log

### Phase 3: Sequential Execution

| Plan | Task | Status | Commit | Timestamp |
|------|------|--------|--------|-----------|
| 03-01 | Task 1 | Complete | `a1b2c3d` | 2026-01-26 14:30 |
| 03-01 | Task 2 | Complete | `e4f5g6h` | 2026-01-26 14:45 |
| 03-01 | Task 3 | Failed | - | 2026-01-26 15:00 |
| 03-01 | Task 3 | Complete | `i7j8k9l` | 2026-01-26 15:15 |
```

### Log Entry Fields

| Field | Source | Purpose |
|-------|--------|---------|
| Plan | Current plan identifier | Traceability |
| Task | Task name from XML | Identification |
| Status | Executor result | Progress tracking |
| Commit | `git rev-parse --short HEAD` | Audit trail |
| Timestamp | Current time | Timeline |

### Update Protocol

After successful commit:

1. **Read current STATE.md**
2. **Find Execution Log section** (create if missing)
3. **Append new row:**
   ```markdown
   | 03-08 | Task 1 | Complete | `abc1234` | 2026-01-26 16:00 |
   ```
4. **Update progress metrics:**
   - Increment completed tasks count
   - Recalculate progress percentage
   - Update progress bar

### Failed Task Logging

For failed tasks (no commit):

```markdown
| 03-08 | Task 2 | Failed | - | 2026-01-26 16:15 |
```

Followed by retry:

```markdown
| 03-08 | Task 2 | Complete | `def5678` | 2026-01-26 16:30 |
```

### Rollback Logging

When a task is rolled back:

```markdown
| 03-08 | Task 2 | Reverted | `ghi9012` | 2026-01-26 17:00 |
```

Note: Revert commit hash goes in Commit column for traceability.

### Session Continuity

STATE.md commit log enables session recovery:

1. **On session start:** Read last commit hash from log
2. **Verify git state:** `git log --oneline -1` matches expected
3. **If mismatch:** Warn user, offer sync options
4. **Resume:** Continue from last logged complete task

### Example Full Log

```markdown
## Execution Log

### Phase 3: Sequential Execution

**Plan 03-01: Executor Agent Definition**

| Task | Description | Status | Commit | Time |
|------|-------------|--------|--------|------|
| 1 | Create frontmatter | Complete | `a1b2c3d` | 14:30 |
| 2 | Add execution protocol | Complete | `e4f5g6h` | 14:45 |
| 3 | Add result reporting | Complete | `i7j8k9l` | 15:00 |
| 4 | Add constraints | Complete | `m0n1o2p` | 15:15 |
| 5 | Add example | Complete | `q3r4s5t` | 15:30 |

**Plan 03-08: Atomic Commit Protocol**

| Task | Description | Status | Commit | Time |
|------|-------------|--------|--------|------|
| 1 | Create reference doc | Complete | `u6v7w8x` | 16:00 |
| 2 | Define message format | In Progress | - | - |

**Summary:**
- Tasks completed: 6
- Tasks in progress: 1
- Tasks failed: 0
- Last commit: `u6v7w8x`
```
```
  </action>
  <verify>
grep -c "STATE.md Integration" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Task Log Format" .claude/skills/ultraplan/references/commit-protocol.md
grep -c "Session Continuity" .claude/skills/ultraplan/references/commit-protocol.md
wc -l .claude/skills/ultraplan/references/commit-protocol.md
  </verify>
  <done>STATE.md integration section added with log format and session continuity</done>
</task>

<task type="auto">
  <name>Task 6: Update Executor Agent with Commit Integration</name>
  <files>.claude/agents/ultraplan-executor.md</files>
  <action>
Add commit protocol reference to the executor agent. Find the "Result Transmission" section and add commit integration:

After the existing Result Transmission section, add:

```markdown
### Commit Integration

After Architect verification passes, the orchestrator triggers atomic commit:

1. **Commit Trigger:**
   - Your successful result triggers commit (not your responsibility)
   - Orchestrator handles git operations
   - See: `.claude/skills/ultraplan/references/commit-protocol.md`

2. **Your Responsibilities:**
   - Report accurate `files_modified` list
   - Include all changed files (not just `<files>` if you created extras)
   - Do NOT run git commands yourself

3. **Result Fields Used for Commit:**
   ```yaml
   task_name: "Task 3: Implement validation"  # → commit description
   files_modified:                             # → git add targets
     - src/validation.ts
     - tests/validation.test.ts
   ```

**Note:** The commit message type (feat/fix/refactor) is inferred by the orchestrator from your `task_name` and `evidence` fields.
```
  </action>
  <verify>
grep -c "Commit Integration" .claude/agents/ultraplan-executor.md
grep -c "commit-protocol.md" .claude/agents/ultraplan-executor.md
  </verify>
  <done>Executor agent updated with commit integration section</done>
</task>

</tasks>

<verification>
1. Reference doc exists: `ls -la .claude/skills/ultraplan/references/commit-protocol.md`
2. Has trigger conditions: `grep "Commit Trigger Conditions" .claude/skills/ultraplan/references/commit-protocol.md`
3. Has message format: `grep "Commit Message Format" .claude/skills/ultraplan/references/commit-protocol.md`
4. Has git commands: `grep "Git Commands" .claude/skills/ultraplan/references/commit-protocol.md`
5. Has rollback protocol: `grep "Rollback Protocol" .claude/skills/ultraplan/references/commit-protocol.md`
6. Has STATE.md integration: `grep "STATE.md Integration" .claude/skills/ultraplan/references/commit-protocol.md`
7. Minimum length: `wc -l .claude/skills/ultraplan/references/commit-protocol.md` (should be >= 150)
8. Executor updated: `grep "Commit Integration" .claude/agents/ultraplan-executor.md`

**Structural Validation:** After grep checks pass, visually confirm:
- Commit trigger flow diagram shows Architect approval gate
- Message format follows Conventional Commits
- Rollback strategies cover single task, specific task, and checkpoint
- STATE.md log format includes commit hash column
- Executor knows not to run git commands itself
</verification>

<success_criteria>
- [ ] Reference document created at `.claude/skills/ultraplan/references/commit-protocol.md`
- [ ] Commit trigger conditions defined (after verification gate)
- [ ] Commit message format follows Conventional Commits with plan/task reference
- [ ] Git command sequence documented (add, status, commit)
- [ ] Rollback/revert protocol for failed tasks
- [ ] Conflict resolution guidance for rollbacks
- [ ] STATE.md integration with commit hash logging
- [ ] Session continuity using commit log
- [ ] Executor agent updated with commit integration reference
- [ ] At least 150 lines of structured content in reference doc
</success_criteria>

<output>
After completion, create `.planning/phases/03-sequential-execution/03-08-SUMMARY.md`
</output>
