# Ultra Planning v4.0 Vision

> Context Architect: 실행하는 에이전트가 아닌, 맥락을 설계하는 아키텍트

## Overview

Ultra Planning v4.0은 두 가지 핵심 개선을 목표로 합니다:

1. **Central Registry** - 에이전트/스킬 중앙 저장소
2. **Context Engineering** - 업계 모범 사례 기반 맥락 관리

## Part 1: Central Registry

### 문제
- 현재: 프로젝트별로 에이전트/스킬 분산
- Ultra Planning이 다른 프로젝트(adsaprk-ceo 등)의 에이전트를 모름
- 스킬 인젝션이 프로젝트 경계를 넘지 못함

### 해결
```
~/registry/  (또는 별도 repo)
├── agents/
│   ├── development/
│   │   ├── executor.yaml
│   │   ├── architect.yaml
│   │   └── build-fixer.yaml
│   └── thinktank/
│       ├── optimist.yaml
│       ├── pessimist.yaml
│       └── realist.yaml
│
└── skills/
    ├── development/
    │   ├── build-fix.yaml
    │   └── security-review.yaml
    └── thinktank/
        ├── risk-analysis.yaml
        └── market-research.yaml
```

### 프로젝트 설정
```json
// .ultraplan/config.json
{
  "registry": "~/registry",
  "use": {
    "agents": ["thinktank/*", "development/executor"],
    "skills": ["thinktank/*", "development/build-fix"]
  }
}
```

## Part 2: Context Engineering

### 2.1 Layered Memory (Google ADK 기반)

| Layer | 내용 | 수명 | 파일 |
|-------|------|------|------|
| Working Memory | 현재 태스크, PLAN.md | 휘발성 | `.planning/*/PLAN.md` |
| Short-term Memory | 세션 상태, STATE.md | 프로젝트 | `.planning/STATE.md` |
| Long-term Memory | Learnings, Decisions, Issues | 영속적 | `.planning/wisdom/` |

### 2.2 Artifact Pattern (Google ADK 기반)

**현재 (나쁜 예 - Context Dumping):**
```javascript
prompt = `
여기 PROJECT.md 전체 내용:
${fs.readFileSync('PROJECT.md')}  // 10,000 tokens 낭비

여기 ROADMAP.md 전체 내용:
${fs.readFileSync('ROADMAP.md')}  // 5,000 tokens 낭비

이제 Task 1을 실행해...
`
```

**개선 (Artifact Pattern - JIT Loading):**
```javascript
prompt = `
## Artifacts (필요시 Read 도구로 조회)
- PROJECT.md: .planning/PROJECT.md
- ROADMAP.md: .planning/ROADMAP.md
- Current Phase: .planning/phases/01-*/

## Current Task
Task 1: ...

필요한 컨텍스트만 Read 도구로 조회하세요.
`
```

### 2.3 Context Compaction (Mem0 기반)

**트리거:** Context 사용량 80% 도달

**프로세스:**
1. 핵심 정보 추출
   - 아키텍처 결정사항
   - 미해결 이슈
   - 현재 진행 상태
2. 중복 제거
3. 압축된 컨텍스트로 재시작 (/fresh-start)

**보존 우선순위:**
1. 현재 태스크 상태 (필수)
2. 미해결 이슈/블로커 (필수)
3. 아키텍처 결정 (중요)
4. 최근 학습 내용 (중요)
5. 대화 히스토리 (선택적 압축)

### 2.4 6-Layer Context Stack (Anthropic 기반)

```
┌─────────────────────────────────────┐
│ 1. System Instructions             │  ← CLAUDE.md, agents/*.md
├─────────────────────────────────────┤
│ 2. Long-term Memory                │  ← .planning/wisdom/
├─────────────────────────────────────┤
│ 3. Retrieved Docs                  │  ← JIT loaded artifacts
├─────────────────────────────────────┤
│ 4. Tool Definitions                │  ← MCP tools
├─────────────────────────────────────┤
│ 5. Conversation History            │  ← Compacted if needed
├─────────────────────────────────────┤
│ 6. Current Task                    │  ← PLAN.md current task
└─────────────────────────────────────┘
```

## Development Phases

### Phase 1: Central Registry
- [ ] Registry 디렉토리 구조 생성
- [ ] agents/ 스키마 정의
- [ ] skills/ 스키마 정의
- [ ] SkillRegistry 수정 (registry 경로 지원)
- [ ] config.json에 registry 설정 추가
- [ ] 기존 에이전트/스킬 마이그레이션

### Phase 2: Artifact Pattern
- [ ] generate_worker_prompt 수정 (경로만 제공)
- [ ] collect_project_context 수정 (요약만 반환)
- [ ] 에이전트 프롬프트 템플릿 수정
- [ ] JIT loading 가이드라인 문서화

### Phase 3: Layered Memory 강화
- [ ] .planning/wisdom/ 구조 정의
- [ ] Wisdom 자동 수집 로직
- [ ] MCP 도구 개선 (add_learning, add_decision 등)
- [ ] 세션 간 Wisdom 전달

### Phase 4: Context Compaction 고도화
- [ ] 컨텍스트 사용량 모니터링
- [ ] 자동 압축 트리거
- [ ] 핵심 정보 추출 알고리즘
- [ ] /fresh-start 개선

## Success Metrics

| 항목 | 현재 | 목표 |
|------|------|------|
| 토큰 효율성 | ~50% 낭비 | <20% 낭비 |
| 크로스 프로젝트 스킬 공유 | 불가능 | 가능 |
| 장기 세션 안정성 | ~2시간 | ~8시간 |
| Wisdom 재사용 | 수동 | 자동 |

## References

- Anthropic: Context Engineering Guide
- Google ADK: Memory Architecture & Artifact Pattern
- Microsoft: Orchestration Patterns
- Mem0: Context Compaction Strategies

---

*Created: 2026-01-31*
*Target: Ultra Planning v4.0*
