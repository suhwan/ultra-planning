---
phase: 05-opencode-reimplementation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/orchestrator/types.ts
  - src/hooks/orchestrator/file-guard.ts
  - src/hooks/orchestrator/single-task.ts
  - src/hooks/orchestrator/index.ts
  - src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Orchestrator warned when writing files outside .ultraplan/.planning/"
    - "Single-task directive available for subagent injection"
    - "System directive prefix used consistently"
    - "Warning is soft (returns warning text, does not block)"
  artifacts:
    - path: "src/hooks/orchestrator/types.ts"
      provides: "Type definitions for hooks"
      exports: ["SystemDirectiveType", "FileGuardResult", "SYSTEM_DIRECTIVE_PREFIX"]
    - path: "src/hooks/orchestrator/file-guard.ts"
      provides: "File modification warning logic"
      exports: ["shouldWarnOnWrite", "getFileGuardWarning", "ALLOWED_PATHS", "WRITE_TOOLS"]
    - path: "src/hooks/orchestrator/single-task.ts"
      provides: "Single task directive for subagents"
      exports: ["SINGLE_TASK_DIRECTIVE", "createSingleTaskDirective"]
    - path: "src/hooks/orchestrator/index.ts"
      provides: "Module exports"
      exports: ["createSystemDirective", "isSystemDirective"]
  key_links:
    - from: "src/hooks/orchestrator/file-guard.ts"
      to: "ALLOWED_PATHS constant"
      via: "path includes check"
      pattern: "ALLOWED_PATHS.*some.*includes"
    - from: "src/hooks/orchestrator/index.ts"
      to: "src/hooks/index.ts"
      via: "re-export"
      pattern: "export.*from.*orchestrator"
---

<objective>
Implement orchestrator enforcement hooks for delegation-only behavior.

Purpose: Prevent the main orchestrator from directly modifying source code (it should delegate to subagents), and provide the single-task directive to inject into subagent prompts to prevent multi-task sprawl.

Output: `src/hooks/orchestrator/` module with file guard warnings and single-task directive.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-opencode-reimplementation/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create orchestrator hook types and system directive utilities</name>
  <files>src/hooks/orchestrator/types.ts</files>
  <action>
Create type definitions for orchestrator enforcement hooks:

1. **SYSTEM_DIRECTIVE_PREFIX constant**:
   ```typescript
   export const SYSTEM_DIRECTIVE_PREFIX = '[SYSTEM DIRECTIVE: ULTRA-PLANNING';
   ```

2. **SystemDirectiveType enum/const object**:
   ```typescript
   export const SystemDirectiveTypes = {
     RALPH_LOOP: 'RALPH LOOP',
     DELEGATION_REQUIRED: 'DELEGATION REQUIRED',
     SINGLE_TASK_ONLY: 'SINGLE TASK ONLY',
     VERIFICATION_REMINDER: 'VERIFICATION REMINDER',
   } as const;

   export type SystemDirectiveType = typeof SystemDirectiveTypes[keyof typeof SystemDirectiveTypes];
   ```

3. **FileGuardResult interface**:
   ```typescript
   export interface FileGuardResult {
     shouldWarn: boolean;
     path: string;
     tool: string;
     warning?: string;
   }
   ```

4. **createSystemDirective function**:
   ```typescript
   export function createSystemDirective(type: SystemDirectiveType): string {
     return `${SYSTEM_DIRECTIVE_PREFIX} - ${type}]`;
   }
   ```

5. **isSystemDirective function**:
   ```typescript
   export function isSystemDirective(text: string): boolean {
     return text.trimStart().startsWith(SYSTEM_DIRECTIVE_PREFIX);
   }
   ```

Add JSDoc comments explaining the orchestrator enforcement purpose.
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -E "(error|warning)" || echo "Build clean"
```
Verify exports:
```bash
grep -E "export (const|interface|function|type)" src/hooks/orchestrator/types.ts
```
  </verify>
  <done>
- SYSTEM_DIRECTIVE_PREFIX exported
- SystemDirectiveTypes const object exported with all 4 directive types
- FileGuardResult interface exported
- createSystemDirective and isSystemDirective functions exported
- Build passes with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement file guard and single-task directive</name>
  <files>src/hooks/orchestrator/file-guard.ts, src/hooks/orchestrator/single-task.ts</files>
  <action>
**file-guard.ts** - File modification warning system:

1. **Constants**:
   ```typescript
   export const WRITE_TOOLS = ['Write', 'Edit', 'write', 'edit', 'MultiEdit'];
   export const ALLOWED_PATHS = ['.ultraplan/', '.planning/', 'CLAUDE.md', 'AGENTS.md'];
   ```

2. **shouldWarnOnWrite(tool: string, filePath: string): boolean**:
   - Return false if tool not in WRITE_TOOLS
   - Return false if filePath includes any ALLOWED_PATHS prefix
   - Return true otherwise (should warn)

3. **getFileGuardWarning(tool: string, filePath: string): FileGuardResult**:
   - Call shouldWarnOnWrite
   - If no warning needed, return { shouldWarn: false, path, tool }
   - If warning needed, return full result with warning text:
   ```typescript
   const WARNING_TEMPLATE = `${createSystemDirective(SystemDirectiveTypes.DELEGATION_REQUIRED)}

**STOP. YOU ARE VIOLATING ORCHESTRATOR PROTOCOL.**

You are attempting to directly modify: ${filePath}

As an ORCHESTRATOR, you MUST:
1. DELEGATE all implementation work via subagents
2. VERIFY the work done by subagents
3. COORDINATE - you orchestrate, you don't implement

**Allowed exceptions:**
- .ultraplan/ and .planning/ directories (planning docs)
- CLAUDE.md and AGENTS.md (configuration files)

If this is verification/fix work, delegate it to an executor subagent.`;
   ```

**single-task.ts** - Single task enforcement directive:

1. **SINGLE_TASK_DIRECTIVE constant**:
   ```typescript
   export const SINGLE_TASK_DIRECTIVE = `${createSystemDirective(SystemDirectiveTypes.SINGLE_TASK_ONLY)}

**STOP. READ THIS BEFORE PROCEEDING.**

If you were NOT given **exactly ONE atomic task**, you MUST:
1. **IMMEDIATELY REFUSE** this request
2. **DEMAND** the orchestrator provide a single, specific task

**Your response if multiple tasks detected:**
> "I refuse to proceed. You provided multiple tasks.
> PROVIDE EXACTLY ONE TASK. One file. One change. One verification."

**REFUSE multi-task requests. DEMAND single-task clarity.**
`;
   ```

2. **createSingleTaskDirective(taskDescription?: string): string**:
   - If taskDescription provided, append: `\n\nYour single task: ${taskDescription}`
   - Return the directive

IMPORTANT: These are warnings/directives, NOT blocking. The orchestrator can still proceed (soft enforcement via prompt injection, not hard blocking).
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -E "(error|warning)" || echo "Build clean"
```
Test file guard logic:
```bash
node -e "
const { shouldWarnOnWrite, getFileGuardWarning } = require('./dist/hooks/orchestrator/file-guard.js');
console.log('Source file warns:', shouldWarnOnWrite('Write', 'src/api.ts') === true);
console.log('Planning file ok:', shouldWarnOnWrite('Write', '.planning/PLAN.md') === false);
console.log('Ultraplan file ok:', shouldWarnOnWrite('Write', '.ultraplan/state/x.json') === false);
console.log('Read tool ok:', shouldWarnOnWrite('Read', 'src/api.ts') === false);

const result = getFileGuardWarning('Write', 'src/models/user.ts');
console.log('Has warning text:', result.warning?.includes('DELEGATION REQUIRED') === true);
"
```
  </verify>
  <done>
- shouldWarnOnWrite returns true for source files, false for allowed paths
- getFileGuardWarning returns warning text with DELEGATION REQUIRED directive
- SINGLE_TASK_DIRECTIVE constant exported
- createSingleTaskDirective function exported
- Warnings are informational (soft enforcement), not blocking
- Build passes with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create hooks module exports</name>
  <files>src/hooks/orchestrator/index.ts, src/hooks/index.ts, src/index.ts</files>
  <action>
**src/hooks/orchestrator/index.ts** - Module exports:

Re-export everything from types, file-guard, and single-task:
```typescript
/**
 * Orchestrator Enforcement Hooks
 *
 * Provides soft enforcement for orchestrator delegation patterns:
 * - File guard: Warns when orchestrator writes source files directly
 * - Single task: Directive to inject into subagent prompts
 *
 * These are SOFT enforcement (warnings), not hard blocking.
 */

export * from './types.js';
export * from './file-guard.js';
export * from './single-task.js';
```

**src/hooks/index.ts** - Hooks module barrel:
```typescript
/**
 * Hooks Module
 *
 * Re-exports all hook utilities including:
 * - Orchestrator enforcement (file guard, single task directive)
 * - (Future: verification reminder)
 */

export * from './orchestrator/index.js';
```

**src/index.ts** - Update main entry point:
- Add export for hooks module: `export * from './hooks/index.js';`
- Ensure hooks functions are accessible from main API

Create directory structure if needed:
```bash
mkdir -p src/hooks/orchestrator
```
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -E "(error|warning)" || echo "Build clean"
```
Verify exports from main index:
```bash
node -e "
const api = require('./dist/index.js');
const fns = [
  'SYSTEM_DIRECTIVE_PREFIX',
  'SystemDirectiveTypes',
  'createSystemDirective',
  'isSystemDirective',
  'shouldWarnOnWrite',
  'getFileGuardWarning',
  'SINGLE_TASK_DIRECTIVE',
  'createSingleTaskDirective',
  'WRITE_TOOLS',
  'ALLOWED_PATHS'
];
fns.forEach(fn => console.log(fn + ':', typeof api[fn]));
"
```
  </verify>
  <done>
- All orchestrator hook functions exported from src/hooks/index.ts
- All functions accessible from main src/index.ts
- Directory structure created: src/hooks/orchestrator/
- JSDoc comments explain soft enforcement purpose
- Build passes with no TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. Build check: `npm run build` succeeds with exit code 0
2. Exports check: All hook functions accessible from main index
3. File guard: Correctly identifies source files vs allowed paths
4. Single task: Directive text available for subagent injection
5. System directive: Prefix functions work correctly
</verification>

<success_criteria>
- src/hooks/orchestrator/ module created with types, file-guard, single-task, index files
- File guard warns on source file writes, allows .ultraplan/.planning/ paths
- Single task directive available as constant and function
- System directive utilities (createSystemDirective, isSystemDirective) working
- Soft enforcement (warnings, not blocking)
- All functions exported from main src/index.ts
- npm run build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-opencode-reimplementation/05-02-SUMMARY.md`
</output>
