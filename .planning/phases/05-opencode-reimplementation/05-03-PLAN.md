---
phase: 05-opencode-reimplementation
plan: 03
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - src/hooks/orchestrator/verification.ts
  - src/hooks/orchestrator/index.ts
  - src/state/types.ts
autonomous: true

must_haves:
  truths:
    - "Verification reminder text displayed after subagent completes"
    - "Reminder includes specific verification steps (diagnostics, tests, build, read)"
    - "Reminder warns about subagent claims being unverified"
    - "Event emitted when verification is required"
  artifacts:
    - path: "src/hooks/orchestrator/verification.ts"
      provides: "Verification reminder logic"
      exports: ["VERIFICATION_REMINDER", "createVerificationReminder", "emitVerificationRequired"]
  key_links:
    - from: "src/hooks/orchestrator/verification.ts"
      to: "src/state/event-system.ts"
      via: "emitEvent for verification_required"
      pattern: "emitEvent.*verification_required"
    - from: "src/hooks/orchestrator/verification.ts"
      to: "src/hooks/orchestrator/types.ts"
      via: "createSystemDirective import"
      pattern: "createSystemDirective.*VERIFICATION_REMINDER"
---

<objective>
Implement verification reminder that displays after subagent delegation completes.

Purpose: Subagents frequently claim completion without actually verifying. The verification reminder prompts the orchestrator to run independent verification checks (diagnostics, tests, build, read code) before accepting a subagent's claim of completion.

Output: Verification reminder text and helper functions in `src/hooks/orchestrator/verification.ts`.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-opencode-reimplementation/05-RESEARCH.md

# Depends on 05-02 for system directive utilities
@src/hooks/orchestrator/types.ts
@src/hooks/orchestrator/index.ts

# Event system for verification events
@src/state/event-system.ts
@src/state/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verification_required event type</name>
  <files>src/state/types.ts</files>
  <action>
Update StateEventType to include new event types for Ralph Loop and verification:

Find the `StateEventType` type definition and add:
```typescript
export type StateEventType =
  | 'plan_started'
  | 'plan_completed'
  | 'plan_failed'
  | 'task_started'
  | 'task_completed'
  | 'task_failed'
  | 'checkpoint_created'
  | 'rollback_initiated'
  | 'mode_changed'
  // Phase 5 additions
  | 'ralph_loop_started'
  | 'ralph_loop_iteration'
  | 'ralph_loop_completed'
  | 'ralph_loop_failed'
  | 'orchestrator_warning'
  | 'verification_required';
```

This allows the event system to track Ralph Loop lifecycle and verification events.
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -E "(error|warning)" || echo "Build clean"
```
Verify event types exist:
```bash
grep -E "verification_required|ralph_loop" src/state/types.ts
```
  </verify>
  <done>
- StateEventType includes ralph_loop_started, ralph_loop_iteration, ralph_loop_completed, ralph_loop_failed
- StateEventType includes orchestrator_warning, verification_required
- Build passes with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create verification reminder module</name>
  <files>src/hooks/orchestrator/verification.ts</files>
  <action>
Create verification reminder functionality:

1. **VERIFICATION_REMINDER constant** - The full reminder text:
```typescript
import { createSystemDirective, SystemDirectiveTypes } from './types.js';
import { emitEvent } from '../../state/event-system.js';

export const VERIFICATION_REMINDER = `${createSystemDirective(SystemDirectiveTypes.VERIFICATION_REMINDER)}

**MANDATORY: VERIFY BEFORE ACCEPTING SUBAGENT CLAIMS**

CRITICAL: Subagents FREQUENTLY LIE about completion. They will claim "done" without:
- Running tests
- Checking for TypeScript errors
- Verifying the code actually works

**STEP 1: VERIFY WITH YOUR OWN TOOL CALLS**
1. \`lsp_diagnostics\` on changed files -> Must be CLEAN (0 errors)
2. Run tests (\`npm test\`) -> Must PASS
3. Run build/typecheck (\`npm run build\`) -> Must succeed
4. Read the actual code -> Must match requirements

**STEP 2: IF VERIFICATION FAILS**
- Resume the SAME subagent session with the ACTUAL error
- Do NOT start fresh - continue from where they left off
- Provide the exact error message they need to fix

**STEP 3: ONLY AFTER VERIFICATION PASSES**
- Update plan checkbox [x]
- Create atomic commit
- Proceed to next task

**NEVER trust "done" claims. ALWAYS verify independently.**
`;
```

2. **createVerificationReminder(context?: string): string**:
   - Return VERIFICATION_REMINDER
   - If context provided, prepend: `\nSubagent completed: ${context}\n\n`

3. **emitVerificationRequired(subagentType: string, task: string): void**:
   - Emit event with type 'verification_required'
   - Payload: { subagentType, task, timestamp: new Date().toISOString() }
   - Source: 'orchestrator'

4. **VerificationStep interface** (for future extensibility):
```typescript
export interface VerificationStep {
  name: string;
  command: string;
  expectedResult: string;
}

export const DEFAULT_VERIFICATION_STEPS: VerificationStep[] = [
  { name: 'Diagnostics', command: 'lsp_diagnostics', expectedResult: '0 errors' },
  { name: 'Tests', command: 'npm test', expectedResult: 'All tests pass' },
  { name: 'Build', command: 'npm run build', expectedResult: 'Exit code 0' },
  { name: 'Code Review', command: 'Read changed files', expectedResult: 'Matches requirements' },
];
```

Add JSDoc explaining that this reminder should be shown after every subagent delegation returns.
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -E "(error|warning)" || echo "Build clean"
```
Verify reminder content:
```bash
node -e "
const { VERIFICATION_REMINDER, createVerificationReminder, DEFAULT_VERIFICATION_STEPS } = require('./dist/hooks/orchestrator/verification.js');
console.log('Has VERIFICATION_REMINDER:', VERIFICATION_REMINDER.includes('VERIFY BEFORE ACCEPTING'));
console.log('Has lsp_diagnostics step:', VERIFICATION_REMINDER.includes('lsp_diagnostics'));
console.log('Has tests step:', VERIFICATION_REMINDER.includes('npm test'));
console.log('Has build step:', VERIFICATION_REMINDER.includes('npm run build'));
console.log('Default steps count:', DEFAULT_VERIFICATION_STEPS.length);

const withContext = createVerificationReminder('executor finished user model');
console.log('Context prepended:', withContext.includes('executor finished user model'));
"
```
  </verify>
  <done>
- VERIFICATION_REMINDER constant exported with full reminder text
- Reminder includes all 4 verification steps (diagnostics, tests, build, read)
- createVerificationReminder adds optional context prefix
- emitVerificationRequired emits event to event system
- DEFAULT_VERIFICATION_STEPS array exported
- Build passes with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update hooks module exports</name>
  <files>src/hooks/orchestrator/index.ts</files>
  <action>
Update src/hooks/orchestrator/index.ts to export verification module:

```typescript
/**
 * Orchestrator Enforcement Hooks
 *
 * Provides soft enforcement for orchestrator delegation patterns:
 * - File guard: Warns when orchestrator writes source files directly
 * - Single task: Directive to inject into subagent prompts
 * - Verification reminder: Shows after subagent completion
 *
 * These are SOFT enforcement (warnings/reminders), not hard blocking.
 */

export * from './types.js';
export * from './file-guard.js';
export * from './single-task.js';
export * from './verification.js';
```

Ensure all verification exports are accessible from main src/index.ts (should work automatically via barrel exports).
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -E "(error|warning)" || echo "Build clean"
```
Verify all exports from main index:
```bash
node -e "
const api = require('./dist/index.js');
const fns = [
  'VERIFICATION_REMINDER',
  'createVerificationReminder',
  'emitVerificationRequired',
  'DEFAULT_VERIFICATION_STEPS'
];
fns.forEach(fn => console.log(fn + ':', typeof api[fn]));
"
```
  </verify>
  <done>
- verification.ts exports included in orchestrator index
- All verification functions accessible from main src/index.ts
- JSDoc updated to mention verification reminder
- Build passes with no TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. Build check: `npm run build` succeeds with exit code 0
2. Event types: StateEventType includes verification_required and ralph_loop_* events
3. Reminder content: Includes all 4 verification steps (diagnostics, tests, build, read)
4. Exports check: All verification functions accessible from main index
5. Event emission: emitVerificationRequired creates event with correct structure
</verification>

<success_criteria>
- StateEventType extended with Phase 5 event types
- VERIFICATION_REMINDER constant with comprehensive verification checklist
- createVerificationReminder function with optional context
- emitVerificationRequired function for event tracking
- DEFAULT_VERIFICATION_STEPS array for programmatic access
- All exports accessible from main src/index.ts
- npm run build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-opencode-reimplementation/05-03-SUMMARY.md`
</output>
