---
phase: 13-central-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/registry/types.ts
  - src/registry/paths.ts
  - src/registry/index.ts
autonomous: true

must_haves:
  truths:
    - "Registry path can resolve ~/registry to absolute path"
    - "Registry path works cross-platform (macOS, Linux, Windows)"
    - "Types define RegistrySource with path, loadOrder, and isGlobal"
  artifacts:
    - path: "src/registry/types.ts"
      provides: "Registry type definitions"
      exports: ["RegistrySource", "RegistryConfig", "SkillSelection"]
    - path: "src/registry/paths.ts"
      provides: "Cross-platform path resolution"
      exports: ["resolveRegistryPath", "getDefaultRegistryPath", "expandTilde"]
    - path: "src/registry/index.ts"
      provides: "Module barrel export"
      exports: ["*"]
  key_links:
    - from: "src/registry/paths.ts"
      to: "os.homedir()"
      via: "tilde expansion"
      pattern: "os\\.homedir\\(\\)"
---

<objective>
Define registry directory schema and cross-platform path resolution utilities.

Purpose: Establish the foundation types and path utilities that SkillRegistry and AgentRegistry will use to locate and load skills/agents from both global registry (~/.registry) and local project directories.

Output: TypeScript types for registry configuration and path resolution utilities.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-central-registry/13-RESEARCH.md
@src/state/types.ts
@src/state/state-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create registry types</name>
  <files>src/registry/types.ts</files>
  <action>
Create TypeScript type definitions for the registry system:

```typescript
/**
 * Registry Types - Central registry for cross-project skill/agent sharing
 */

/**
 * Registry source with load ordering
 *
 * loadOrder determines which sources can override others:
 * - Lower number = loaded earlier = can be overridden by later sources
 * - Higher number = loaded later = overrides earlier sources
 *
 * Example:
 * - Global (loadOrder: 1) loaded first, can be overridden
 * - Local (loadOrder: 2) loaded last, overrides global
 */
export interface RegistrySource {
  /** Absolute path to the registry directory */
  path: string;
  /** Load order (lower = loaded first = can be overridden, higher = loaded last = overrides) */
  loadOrder: number;
  /** Whether this is the global registry */
  isGlobal: boolean;
}

/** Configuration for registry paths and skill/agent selection */
export interface RegistryConfig {
  /** Path to global registry (default: ~/registry) */
  registry?: string;
  /** Skill/agent selection patterns */
  use?: {
    /** Glob patterns for agent selection (e.g., ["thinktank/*", "development/executor"]) */
    agents?: string[];
    /** Glob patterns for skill selection (e.g., ["thinktank/*", "development/build-fix"]) */
    skills?: string[];
  };
}

/** Skill selection result after pattern matching */
export interface SkillSelection {
  /** Skill ID that matched */
  skillId: string;
  /** Pattern that matched */
  matchedPattern: string;
  /** Source registry (global or local) */
  source: RegistrySource;
}

/** Agent selection result after pattern matching */
export interface AgentSelection {
  /** Agent ID that matched */
  agentId: string;
  /** Pattern that matched */
  matchedPattern: string;
  /** Source registry (global or local) */
  source: RegistrySource;
}

/** Default registry path relative to home directory */
export const DEFAULT_REGISTRY_DIR = 'registry';

/** Skills subdirectory within registry */
export const SKILLS_SUBDIR = 'skills';

/** Agents subdirectory within registry */
export const AGENTS_SUBDIR = 'agents';
```
  </action>
  <verify>
Run `npx tsc --noEmit src/registry/types.ts` - should compile with no errors.
  </verify>
  <done>
Types compile successfully and export RegistrySource, RegistryConfig, SkillSelection, AgentSelection interfaces with loadOrder field (not priority).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create path resolution utilities</name>
  <files>src/registry/paths.ts</files>
  <action>
Create cross-platform path resolution utilities for registry paths:

```typescript
/**
 * Registry Path Resolution - Cross-platform path utilities
 *
 * Handles ~ expansion and platform-specific path resolution.
 * Based on StateManager pattern but extended for registry paths.
 */

import { homedir } from 'os';
import { join, isAbsolute, resolve } from 'path';
import { existsSync } from 'fs';
import { DEFAULT_REGISTRY_DIR, SKILLS_SUBDIR, AGENTS_SUBDIR } from './types.js';

/**
 * Expand tilde (~) in path to user home directory
 *
 * @param inputPath - Path that may contain ~
 * @returns Absolute path with ~ expanded
 */
export function expandTilde(inputPath: string): string {
  if (inputPath.startsWith('~/')) {
    return join(homedir(), inputPath.slice(2));
  }
  if (inputPath === '~') {
    return homedir();
  }
  return inputPath;
}

/**
 * Resolve registry path to absolute path
 *
 * Handles:
 * - ~ expansion (~/registry -> /home/user/registry)
 * - Absolute paths (passed through)
 * - Relative paths (resolved from cwd)
 *
 * @param configPath - Registry path from config (may be ~, relative, or absolute)
 * @returns Absolute path to registry directory
 */
export function resolveRegistryPath(configPath: string): string {
  // Handle tilde expansion
  const expanded = expandTilde(configPath);

  // If absolute, return as-is
  if (isAbsolute(expanded)) {
    return expanded;
  }

  // Relative path - resolve from cwd
  return resolve(process.cwd(), expanded);
}

/**
 * Get default global registry path
 *
 * @returns Absolute path to ~/registry
 */
export function getDefaultRegistryPath(): string {
  return join(homedir(), DEFAULT_REGISTRY_DIR);
}

/**
 * Get skills directory within a registry path
 *
 * @param registryPath - Base registry path
 * @returns Absolute path to skills directory
 */
export function getSkillsPath(registryPath: string): string {
  return join(resolveRegistryPath(registryPath), SKILLS_SUBDIR);
}

/**
 * Get agents directory within a registry path
 *
 * @param registryPath - Base registry path
 * @returns Absolute path to agents directory
 */
export function getAgentsPath(registryPath: string): string {
  return join(resolveRegistryPath(registryPath), AGENTS_SUBDIR);
}

/**
 * Check if a registry path exists and is accessible
 *
 * @param registryPath - Registry path to check
 * @returns Whether the path exists
 */
export function registryExists(registryPath: string): boolean {
  return existsSync(resolveRegistryPath(registryPath));
}

/**
 * Check if skills directory exists in registry
 *
 * @param registryPath - Base registry path
 * @returns Whether skills directory exists
 */
export function skillsExist(registryPath: string): boolean {
  return existsSync(getSkillsPath(registryPath));
}

/**
 * Check if agents directory exists in registry
 *
 * @param registryPath - Base registry path
 * @returns Whether agents directory exists
 */
export function agentsExist(registryPath: string): boolean {
  return existsSync(getAgentsPath(registryPath));
}
```

Ensure to handle Windows paths correctly by using path.join() everywhere, never string concatenation.
  </action>
  <verify>
Run `npx tsc --noEmit src/registry/paths.ts` - should compile with no errors.
  </verify>
  <done>
Path utilities compile and export expandTilde, resolveRegistryPath, getDefaultRegistryPath, getSkillsPath, getAgentsPath, registryExists, skillsExist, agentsExist functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create module barrel export</name>
  <files>src/registry/index.ts</files>
  <action>
Create barrel export for the registry module:

```typescript
/**
 * Central Registry Module
 *
 * Provides cross-project skill/agent sharing via global and local registries.
 *
 * Directory structure:
 * ~/registry/           # Global registry
 *   agents/             # Agent YAML definitions
 *   skills/             # Skill YAML definitions
 * .ultraplan/           # Local project overrides
 *   skills/             # Project-specific skills (override global)
 */

// Types
export type {
  RegistrySource,
  RegistryConfig,
  SkillSelection,
  AgentSelection,
} from './types.js';

export {
  DEFAULT_REGISTRY_DIR,
  SKILLS_SUBDIR,
  AGENTS_SUBDIR,
} from './types.js';

// Path utilities
export {
  expandTilde,
  resolveRegistryPath,
  getDefaultRegistryPath,
  getSkillsPath,
  getAgentsPath,
  registryExists,
  skillsExist,
  agentsExist,
} from './paths.js';
```
  </action>
  <verify>
Run `npx tsc --noEmit src/registry/index.ts` - should compile with no errors.
  </verify>
  <done>
Module exports all types and functions from types.ts and paths.ts.
  </done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors: `npm run build`
2. Types are properly exported and can be imported from `src/registry/index.js`
3. Path resolution handles:
   - `~/registry` expands to `/home/user/registry` (Linux/macOS) or `C:\Users\user\registry` (Windows)
   - Absolute paths pass through unchanged
   - Relative paths resolve from cwd
</verification>

<success_criteria>
- [ ] src/registry/types.ts exports RegistrySource, RegistryConfig, SkillSelection, AgentSelection
- [ ] RegistrySource uses `loadOrder` field (not `priority`)
- [ ] src/registry/paths.ts exports all path resolution functions
- [ ] src/registry/index.ts barrel exports all types and functions
- [ ] `npm run build` passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-central-registry/13-01-SUMMARY.md`
</output>
