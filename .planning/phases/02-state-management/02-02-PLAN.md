---
phase: 02-state-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/state/types.ts
  - src/state/event-system.ts
  - src/state/index.ts
autonomous: true

must_haves:
  truths:
    - "emitEvent appends events to JSONL file"
    - "pollEvents returns events since a given line number"
    - "Events have unique IDs and timestamps"
    - "Event file rotation occurs at threshold"
  artifacts:
    - path: "src/state/event-system.ts"
      provides: "File-based event queue"
      exports: ["emitEvent", "pollEvents", "rotateEventsIfNeeded"]
      min_lines: 80
    - path: "src/state/types.ts"
      provides: "Event-related types"
      contains: "StateEvent"
  key_links:
    - from: "src/state/event-system.ts"
      to: ".ultraplan/state/events.jsonl"
      via: "appendFileSync"
      pattern: "appendFileSync.*events"
---

<objective>
Implement file-based event queue for inter-agent communication.

Purpose: Enables the orchestrator to signal events to agents and track progress. Uses append-only JSONL format for efficient writes and line-based polling for efficient reads.

Output: `emitEvent` and `pollEvents` functions that provide a durable event queue without external services.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-state-management/02-RESEARCH.md
@.planning/phases/02-state-management/02-01-SUMMARY.md
@src/state/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event types to state types</name>
  <files>src/state/types.ts</files>
  <action>
Add event-related types to src/state/types.ts:

1. `StateEvent` interface:
   - id: string (UUID)
   - timestamp: string (ISO 8601)
   - type: StateEventType
   - payload: Record<string, unknown>
   - source: string ('orchestrator' | 'agent:{name}')

2. `StateEventType` union type:
   - 'plan_started' | 'plan_completed' | 'plan_failed'
   - 'task_started' | 'task_completed' | 'task_failed'
   - 'checkpoint_created' | 'rollback_initiated' | 'mode_changed'

3. `EventPollResult` interface:
   - events: StateEvent[]
   - lastLine: number
   - hasMore: boolean

4. Constants:
   - EVENT_FILE = 'events.jsonl'
   - EVENT_FILE_MAX_LINES = 1000
  </action>
  <verify>
`npx tsc --noEmit` passes without errors
  </verify>
  <done>
Event types added to src/state/types.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement event system</name>
  <files>src/state/event-system.ts</files>
  <action>
Create the event system with append-only JSONL pattern:

1. `getEventFilePath(): string` - returns full path to events.jsonl

2. `emitEvent(event: Omit<StateEvent, 'id' | 'timestamp'>): StateEvent`
   - Generate UUID via crypto.randomUUID()
   - Add ISO timestamp
   - Append JSON line + '\n' to events.jsonl
   - Return the full event object

3. `pollEvents(sinceLineNumber: number = 0): EventPollResult`
   - Read events.jsonl (handle file not existing)
   - Split by newlines, filter empty
   - Return events from sinceLineNumber onwards
   - Include lastLine for next poll, hasMore if more events exist

4. `rotateEventsIfNeeded(): boolean`
   - Check line count against EVENT_FILE_MAX_LINES
   - If exceeded, move current file to events.{timestamp}.jsonl
   - Create fresh events.jsonl
   - Return true if rotated

5. `clearEvents(): void`
   - Delete events.jsonl if exists

Use synchronous fs operations. Ensure directory exists before write.
  </action>
  <verify>
`npx tsc --noEmit` passes without errors
  </verify>
  <done>
Event system functions implemented with JSONL append pattern
  </done>
</task>

<task type="auto">
  <name>Task 3: Export and integration</name>
  <files>src/state/index.ts</files>
  <action>
Add event system exports to src/state/index.ts:

```typescript
export * from './event-system.js';
```

Verify the exports are accessible from the main package.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. emitEvent and pollEvents are exported from package root
  </verify>
  <done>
Event system integrated and exported
  </done>
</task>

</tasks>

<verification>
All checks must pass:

1. **Type check:** `npx tsc --noEmit` completes without errors
2. **Build:** `npm run build` produces dist/state/event-system.js
3. **Exports:** emitEvent, pollEvents, rotateEventsIfNeeded exported from package
4. **Event types:** StateEvent and EventPollResult types available
</verification>

<success_criteria>
- emitEvent appends events with UUID and timestamp to JSONL file
- pollEvents returns events from specified line number onwards
- rotateEventsIfNeeded moves old events when threshold exceeded
- All functions use synchronous I/O for predictability
</success_criteria>

<output>
After completion, create `.planning/phases/02-state-management/02-02-SUMMARY.md`
</output>
