---
phase: 02-state-management
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/state/types.ts
  - src/state/checkpoint.ts
  - src/state/index.ts
autonomous: true

must_haves:
  truths:
    - "createCheckpoint creates a git commit with state snapshot"
    - "rollbackToCheckpoint restores state from checkpoint commit"
    - "listCheckpoints returns available checkpoint history"
    - "Checkpoints only include .ultraplan/state/ not source code"
  artifacts:
    - path: "src/state/checkpoint.ts"
      provides: "Git-based checkpoint system"
      exports: ["createCheckpoint", "rollbackToCheckpoint", "listCheckpoints"]
      min_lines: 100
    - path: "src/state/types.ts"
      provides: "Checkpoint-related types"
      contains: "Checkpoint"
  key_links:
    - from: "src/state/checkpoint.ts"
      to: "git"
      via: "execSync"
      pattern: "execSync.*git"
---

<objective>
Implement git-based checkpoint system for state persistence and rollback.

Purpose: Enables recovery from failed operations by creating git commits as checkpoint markers. The orchestrator can rollback to a previous checkpoint when errors occur during plan execution.

Output: Functions to create, list, and rollback to checkpoints using git as the persistence layer.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-state-management/02-RESEARCH.md
@.planning/phases/02-state-management/02-01-SUMMARY.md
@src/state/types.ts
@src/state/state-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkpoint types</name>
  <files>src/state/types.ts</files>
  <action>
Add checkpoint-related types to src/state/types.ts:

1. `Checkpoint` interface:
   - id: string (UUID)
   - commitHash: string
   - createdAt: string (ISO 8601)
   - phase: string
   - plan: number
   - wave: number
   - description: string
   - stateSnapshot: Record<string, unknown> (captured state at checkpoint time)

2. `CheckpointCreateResult` interface:
   - success: boolean
   - checkpoint?: Checkpoint
   - error?: string

3. `RollbackResult` interface:
   - success: boolean
   - rolledBackTo?: Checkpoint
   - filesRestored?: string[]
   - error?: string

4. Constants:
   - CHECKPOINT_DIR = '.ultraplan/checkpoints'
   - CHECKPOINT_RETAIN_COUNT = 10
  </action>
  <verify>
`npx tsc --noEmit` passes without errors
  </verify>
  <done>
Checkpoint types added to src/state/types.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement checkpoint system</name>
  <files>src/state/checkpoint.ts</files>
  <action>
Create checkpoint system using git commits:

1. Helper functions:
   - `isGitRepo(): boolean` - check if .git exists
   - `execGit(args: string[]): string` - safe git command execution
   - `getCheckpointIndexPath(): string` - path to checkpoint index file

2. `createCheckpoint(phase: string, plan: number, wave: number, description: string): CheckpointCreateResult`
   - Verify git repo exists
   - Stage .ultraplan/state/ files: `git add .ultraplan/state/`
   - Capture current state snapshot (read all .json files in state dir)
   - Create commit: `git commit -m "checkpoint(${phase}/${plan}): ${description}" --allow-empty`
   - Get commit hash: `git rev-parse HEAD`
   - Save checkpoint metadata to index file
   - Return CheckpointCreateResult with checkpoint object

3. `rollbackToCheckpoint(checkpointId: string): RollbackResult`
   - Load checkpoint from index
   - Reset git to checkpoint commit: `git checkout {hash} -- .ultraplan/state/`
   - Do NOT use `git reset --hard` (would affect source code)
   - Return RollbackResult with restored files

4. `listCheckpoints(): Checkpoint[]`
   - Read checkpoint index file
   - Return array sorted by createdAt descending

5. `pruneOldCheckpoints(): number`
   - Keep only CHECKPOINT_RETAIN_COUNT most recent
   - Delete old checkpoint metadata
   - Return number pruned

6. `getLatestCheckpoint(): Checkpoint | undefined`
   - Return most recent checkpoint or undefined

Use StateManager to persist checkpoint index at .ultraplan/checkpoints/index.json.

IMPORTANT: Only affect .ultraplan/state/ directory, NEVER reset source code.
  </action>
  <verify>
`npx tsc --noEmit` passes without errors
  </verify>
  <done>
Checkpoint system with create/rollback/list implemented using git
  </done>
</task>

<task type="auto">
  <name>Task 3: Export and integration</name>
  <files>src/state/index.ts</files>
  <action>
Add checkpoint exports to src/state/index.ts:

```typescript
export * from './checkpoint.js';
```

Verify the exports are accessible from the main package.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. createCheckpoint, rollbackToCheckpoint, listCheckpoints exported from package
  </verify>
  <done>
Checkpoint system integrated and exported
  </done>
</task>

</tasks>

<verification>
All checks must pass:

1. **Type check:** `npx tsc --noEmit` completes without errors
2. **Build:** `npm run build` produces dist/state/checkpoint.js
3. **Exports:** Checkpoint functions exported from package
4. **Types:** Checkpoint, CheckpointCreateResult, RollbackResult types available
</verification>

<success_criteria>
- createCheckpoint creates git commit with state files only
- rollbackToCheckpoint restores state without affecting source code
- listCheckpoints returns ordered checkpoint history
- Checkpoint index persisted via StateManager
- Git operations use safe argument passing (no shell interpolation)
</success_criteria>

<output>
After completion, create `.planning/phases/02-state-management/02-04-SUMMARY.md`
</output>
