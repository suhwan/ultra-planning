---
phase: 10-context-monitor
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/context/checkpoint-return.ts
  - src/context/index.ts
autonomous: true

must_haves:
  truths:
    - "Checkpoint return captures completed items with status"
    - "Remaining items include reference patterns for continuation"
    - "Handoff context preserves decisions, patterns, filesModified"
    - "Builder pattern enables fluent checkpoint construction"
  artifacts:
    - path: "src/context/checkpoint-return.ts"
      provides: "Checkpoint return structure and builder"
      exports: ["CheckpointReturn", "CheckpointReturnBuilder", "CompletedItem", "RemainingItem", "HandoffContext"]
  key_links:
    - from: "src/context/checkpoint-return.ts"
      to: "src/state/state-manager.ts"
      via: "optional persistence"
      pattern: "StateManager"
---

<objective>
Implement the checkpoint return structure for graceful subagent handoff.

Purpose: When subagent reaches critical threshold, it returns structured checkpoint data for continuation
Output: CheckpointReturn type and builder class for constructing handoff data
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-context-monitor/10-RESEARCH.md

# Existing patterns
@src/state/state-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define checkpoint return types</name>
  <files>src/context/checkpoint-return.ts</files>
  <action>
Create the checkpoint return structure based on ROADMAP.md pattern:

1. **CompletedItem interface:**
   - `file: string` - Path to completed file
   - `status: 'done' | 'partial'` - Completion status
   - `tests?: 'passed' | 'skipped' | 'failed'` - Test status if applicable
   - `notes?: string` - Optional implementation notes

2. **RemainingItem interface:**
   - `file: string` - Path to remaining file
   - `description: string` - What needs to be done
   - `referencePattern?: string` - e.g., "utils.ts:15-30 error handling"
   - `priority?: 'high' | 'normal' | 'low'` - Execution priority

3. **HandoffContext interface:**
   - `decisions: string[]` - Key architectural decisions made
   - `patterns: string[]` - Code patterns to follow
   - `issues?: string[]` - Issues encountered (optional)
   - `filesModified: string[]` - All files touched for dependency tracking

4. **CheckpointReturn interface:**
   - `completed: CompletedItem[]` - Items done by this subagent
   - `remaining: RemainingItem[]` - Items for next subagent
   - `context: HandoffContext` - Preserved context
   - `createdAt: string` - ISO timestamp
   - `agentId: string` - Source agent identifier
   - `reason: 'threshold_critical' | 'task_complete' | 'error'` - Why checkpoint created

5. **CHECKPOINT_SIZE_WARNING = 4000** chars (~1000 tokens)
   - Warn if checkpoint exceeds this size

Export all types.
  </action>
  <verify>
`npx tsc --noEmit` passes
  </verify>
  <done>
All checkpoint return types defined with proper structure for handoff data
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement CheckpointReturnBuilder</name>
  <files>src/context/checkpoint-return.ts, src/context/index.ts</files>
  <action>
Add builder class for fluent checkpoint construction:

**CheckpointReturnBuilder class:**

```typescript
class CheckpointReturnBuilder {
  private completed: CompletedItem[] = [];
  private remaining: RemainingItem[] = [];
  private context: HandoffContext = {
    decisions: [],
    patterns: [],
    filesModified: []
  };
  private agentId: string;
  private reason: CheckpointReturn['reason'];

  constructor(agentId: string, reason: CheckpointReturn['reason'])
```

**Methods (all return `this` for chaining):**
- `addCompleted(item: CompletedItem): this`
- `addRemaining(item: RemainingItem): this`
- `addDecision(decision: string): this`
- `addPattern(pattern: string): this`
- `addIssue(issue: string): this`
- `addFileModified(file: string): this` - Deduplicates

**Build method:**
- `build(): CheckpointReturn` - Creates final structure with timestamp
- Logs warning if JSON.stringify(result).length > CHECKPOINT_SIZE_WARNING

**Helper function:**
- `validateCheckpointSize(checkpoint: CheckpointReturn): { valid: boolean; size: number; warning?: string }`

**index.ts:**
- Export CheckpointReturnBuilder, all interfaces, validateCheckpointSize
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Builder constructs valid CheckpointReturn structure
3. Size validation works
  </verify>
  <done>
- CheckpointReturnBuilder provides fluent API for checkpoint construction
- Size validation warns on oversized checkpoints
- All exports available from src/context/index.ts
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - All files compile
2. Builder creates complete CheckpointReturn with all fields
3. Size warning triggered for large checkpoints (>4000 chars)
4. Deduplication works for filesModified
</verification>

<success_criteria>
- CheckpointReturn structure matches ROADMAP.md pattern
- Builder enables fluent construction of handoff data
- Size validation prevents oversized checkpoints
- All necessary context captured for continuation
</success_criteria>

<output>
After completion, create `.planning/phases/10-context-monitor/10-03-SUMMARY.md`
</output>
