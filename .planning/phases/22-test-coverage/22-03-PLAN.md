---
phase: 22-test-coverage
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - src/hooks/orchestrator/file-guard.test.ts
  - src/hooks/orchestrator/single-task.test.ts
  - src/hooks/orchestrator/verification.test.ts
  - src/quality/lsp/diagnostics.test.ts
  - src/quality/lsp/parser.test.ts
  - src/quality/ast/analyzer.test.ts
  - src/quality/ast/patterns.test.ts
autonomous: true

must_haves:
  truths:
    - "File guard tests verify orchestrator write warning enforcement"
    - "Single task hook tests verify task isolation behavior"
    - "Verification hook tests verify completion verification"
    - "LSP diagnostics tests verify TypeScript error detection"
    - "AST analyzer tests verify code pattern detection"
  artifacts:
    - path: "src/hooks/orchestrator/file-guard.test.ts"
      provides: "File guard hook tests for write warning system"
      min_lines: 60
    - path: "src/hooks/orchestrator/single-task.test.ts"
      provides: "Single task hook tests for task isolation"
      min_lines: 50
    - path: "src/hooks/orchestrator/verification.test.ts"
      provides: "Verification hook tests for completion checks"
      min_lines: 50
    - path: "src/quality/lsp/diagnostics.test.ts"
      provides: "LSP diagnostics runner tests"
      min_lines: 80
    - path: "src/quality/lsp/parser.test.ts"
      provides: "Diagnostic output parser tests"
      min_lines: 60
    - path: "src/quality/ast/analyzer.test.ts"
      provides: "AST analyzer tests for code analysis"
      min_lines: 60
    - path: "src/quality/ast/patterns.test.ts"
      provides: "AST pattern matching tests"
      min_lines: 50
  key_links:
    - from: "src/hooks/orchestrator/file-guard.test.ts"
      to: "src/hooks/orchestrator/file-guard.ts"
      via: "imports shouldWarnOnWrite, getFileGuardWarning"
      pattern: "import.*shouldWarnOnWrite"
    - from: "src/quality/lsp/diagnostics.test.ts"
      to: "src/quality/lsp/diagnostics.ts"
      via: "imports runDiagnostics"
      pattern: "import.*runDiagnostics"
---

<objective>
Create unit tests for hooks and quality modules (Wave 3 - Hooks and Quality Tests).

Purpose: Test the orchestration hooks that enforce delegation patterns and the quality modules that provide LSP diagnostics and AST analysis. These are critical for maintaining code quality during execution.

Output:
- `src/hooks/orchestrator/file-guard.test.ts` - File guard hook tests
- `src/hooks/orchestrator/single-task.test.ts` - Single task hook tests
- `src/hooks/orchestrator/verification.test.ts` - Verification hook tests
- `src/quality/lsp/diagnostics.test.ts` - LSP diagnostics tests
- `src/quality/lsp/parser.test.ts` - Diagnostic parser tests
- `src/quality/ast/analyzer.test.ts` - AST analyzer tests
- `src/quality/ast/patterns.test.ts` - AST pattern tests
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-test-coverage/22-RESEARCH.md

# Existing test patterns
@src/hooks/tool/category-routing.test.ts - Hook testing pattern with mocks
@src/complexity/estimator.test.ts - Unit test pattern

# Source files to test
@src/hooks/orchestrator/file-guard.ts - Write warning enforcement
@src/hooks/orchestrator/single-task.ts - Task isolation
@src/hooks/orchestrator/verification.ts - Completion verification
@src/quality/lsp/diagnostics.ts - TypeScript diagnostics runner
@src/quality/lsp/parser.ts - Diagnostic output parser
@src/quality/ast/analyzer.ts - Code pattern analyzer
@src/quality/ast/patterns.ts - AST pattern definitions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create File Guard Hook Tests</name>
  <files>src/hooks/orchestrator/file-guard.test.ts</files>
  <action>
Create tests for the file guard hook:

1. **shouldWarnOnWrite tests:**
   - Returns true for Write tool on source files (src/*.ts)
   - Returns true for Edit tool on source files
   - Returns false for Write tool on .planning/ paths
   - Returns false for Write tool on .ultraplan/ paths
   - Returns false for Write tool on CLAUDE.md
   - Returns false for Write tool on AGENTS.md
   - Returns false for Read tool (not a write operation)
   - Returns false for non-write tools

2. **getFileGuardWarning tests:**
   - Returns shouldWarn:false for allowed paths
   - Returns shouldWarn:true with warning for source files
   - Warning includes file path
   - Warning includes delegation instructions
   - Warning mentions allowed exceptions

3. **WRITE_TOOLS constant tests:**
   - Contains 'Write' and 'Edit'
   - Case variations handled

4. **ALLOWED_PATHS constant tests:**
   - Contains .ultraplan/, .planning/, CLAUDE.md, AGENTS.md

```typescript
import { describe, it, expect } from 'vitest';
import {
  shouldWarnOnWrite,
  getFileGuardWarning,
  WRITE_TOOLS,
  ALLOWED_PATHS,
} from './file-guard.js';
```
  </action>
  <verify>npm test -- src/hooks/orchestrator/file-guard.test.ts</verify>
  <done>File guard tests pass, write warning enforcement verified</done>
</task>

<task type="auto">
  <name>Task 2: Create Single Task Hook Tests</name>
  <files>src/hooks/orchestrator/single-task.test.ts</files>
  <action>
Create tests for the single task hook:

1. **Task isolation tests:**
   - Hook enforces one task at a time
   - Second task blocked while first in progress
   - Task completes and unblocks next task

2. **Hook handler tests:**
   - Returns handler for task.start event
   - Returns handler for task.complete event
   - Handler validates task context

3. **Error handling tests:**
   - Handles task failure gracefully
   - Releases lock on task error
   - Logs appropriate messages

Check single-task.ts exports to align tests with actual implementation.
If the module exports a factory function like createSingleTaskHook, test that.

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
// Import actual exports from single-task.ts
```
  </action>
  <verify>npm test -- src/hooks/orchestrator/single-task.test.ts</verify>
  <done>Single task hook tests pass, task isolation verified</done>
</task>

<task type="auto">
  <name>Task 3: Create Verification Hook Tests</name>
  <files>src/hooks/orchestrator/verification.test.ts</files>
  <action>
Create tests for the verification hook:

1. **Verification requirement tests:**
   - Hook checks for verification before completion
   - Blocks completion without verification
   - Allows completion after verification

2. **Verification types tests:**
   - Build verification (npm run build)
   - Test verification (npm test)
   - Type check verification (tsc --noEmit)

3. **Hook handler tests:**
   - Returns handler for task.complete.before event
   - Handler checks verification state
   - Handler returns warning if unverified

4. **Evidence tracking tests:**
   - Records verification evidence
   - Evidence includes timestamp
   - Evidence includes command output

Check verification.ts exports to align tests with actual implementation.

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
// Import actual exports from verification.ts
```
  </action>
  <verify>npm test -- src/hooks/orchestrator/verification.test.ts</verify>
  <done>Verification hook tests pass, completion verification enforced</done>
</task>

<task type="auto">
  <name>Task 4: Create LSP Diagnostics Tests</name>
  <files>src/quality/lsp/diagnostics.test.ts</files>
  <action>
Create tests for the LSP diagnostics runner:

1. **runDiagnostics tests:**
   - Returns DiagnosticResult with success flag
   - Auto-detects tsc strategy when tsconfig.json exists
   - Falls back to lsp strategy when no tsconfig
   - Respects explicit strategy option
   - Includes duration in result

2. **tsc strategy tests:**
   - Executes tsc --noEmit command
   - Parses error output correctly
   - Returns empty diagnostics on clean build
   - Captures TypeScript errors with file:line:col

3. **lsp strategy tests:**
   - Falls back when tsc not available
   - Returns stub result (implementation pending)

4. **Error handling tests:**
   - Handles timeout gracefully
   - Handles missing tsc gracefully
   - Returns error field on failure

5. **Summary tests:**
   - Counts errors, warnings, info, hints
   - Counts affected files

Mock execSync to avoid actual tsc execution in tests.

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { runDiagnostics } from './diagnostics.js';

// Mock child_process
vi.mock('child_process', () => ({
  execSync: vi.fn(),
}));
```
  </action>
  <verify>npm test -- src/quality/lsp/diagnostics.test.ts</verify>
  <done>LSP diagnostics tests pass, TypeScript error detection verified</done>
</task>

<task type="auto">
  <name>Task 5: Create LSP Parser Tests</name>
  <files>src/quality/lsp/parser.test.ts</files>
  <action>
Create tests for the diagnostic output parser:

1. **parseDiagnosticOutput tests:**
   - Parses tsc error format: "file(line,col): error TS2345: message"
   - Parses warning format: "file(line,col): warning TS6385: message"
   - Handles multi-line error messages
   - Returns empty array for clean output
   - Handles relative and absolute paths

2. **countBySeverity tests:**
   - Counts errors correctly
   - Counts warnings correctly
   - Returns zero counts for empty input
   - Counts unique files affected

3. **Diagnostic structure tests:**
   - Includes file path
   - Includes line and column numbers
   - Includes severity (error/warning/info/hint)
   - Includes error code (TS2345)
   - Includes message text

4. **Edge cases:**
   - Handles malformed output gracefully
   - Ignores non-diagnostic lines
   - Handles Windows-style paths

```typescript
import { describe, it, expect } from 'vitest';
import { parseDiagnosticOutput, countBySeverity } from './parser.js';
```
  </action>
  <verify>npm test -- src/quality/lsp/parser.test.ts</verify>
  <done>LSP parser tests pass, diagnostic parsing verified</done>
</task>

<task type="auto">
  <name>Task 6: Create AST Analyzer Tests</name>
  <files>src/quality/ast/analyzer.test.ts</files>
  <action>
Create tests for the AST analyzer:

1. **Code analysis tests:**
   - Analyzes TypeScript source files
   - Detects function declarations
   - Detects class declarations
   - Detects export statements

2. **Pattern matching tests:**
   - Finds patterns in code
   - Returns matches with locations
   - Handles no matches gracefully

3. **Metrics extraction tests:**
   - Counts lines of code
   - Counts functions/methods
   - Counts classes
   - Calculates complexity estimates

4. **Error handling tests:**
   - Handles invalid TypeScript gracefully
   - Returns partial results on parse errors

Check analyzer.ts exports and ast-grep usage to align tests.

```typescript
import { describe, it, expect } from 'vitest';
// Import actual exports from analyzer.ts
```
  </action>
  <verify>npm test -- src/quality/ast/analyzer.test.ts</verify>
  <done>AST analyzer tests pass, code analysis verified</done>
</task>

<task type="auto">
  <name>Task 7: Create AST Patterns Tests</name>
  <files>src/quality/ast/patterns.test.ts</files>
  <action>
Create tests for AST pattern definitions:

1. **Pattern definition tests:**
   - Function declaration pattern matches functions
   - Class declaration pattern matches classes
   - Import statement pattern matches imports
   - Export statement pattern matches exports

2. **Pattern format tests:**
   - Patterns are valid ast-grep syntax
   - Patterns include capture groups where needed

3. **Complex pattern tests:**
   - Arrow function pattern
   - Async function pattern
   - Generic type pattern

Check patterns.ts exports to see what patterns are defined.

```typescript
import { describe, it, expect } from 'vitest';
// Import actual patterns from patterns.ts
```
  </action>
  <verify>npm test -- src/quality/ast/patterns.test.ts</verify>
  <done>AST patterns tests pass, pattern definitions verified</done>
</task>

</tasks>

<verification>
1. `npm test -- src/hooks/orchestrator/` - All orchestrator hook tests pass
2. `npm test -- src/quality/` - All quality tests pass
3. `npm run build` - No TypeScript errors in test files
4. Tests use mocks for external dependencies (execSync, fs)
5. Tests don't require actual TypeScript compiler execution
</verification>

<success_criteria>
1. 7 new test files created for hooks and quality modules
2. Hook tests verify enforcement behavior
3. Quality tests verify diagnostic and analysis features
4. All tests pass independently and together
5. External dependencies properly mocked
6. Each test file has appropriate coverage (50+ lines minimum)
</success_criteria>

<output>
After completion, create `.planning/phases/22-test-coverage/22-03-SUMMARY.md`
</output>
