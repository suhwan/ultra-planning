---
phase: 22-test-coverage
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/state/mode-registry.test.ts
  - src/state/event-system.test.ts
  - src/sync/plan-parser.test.ts
  - src/sync/task-mapper.test.ts
  - src/sync/dependency-map.test.ts
autonomous: true

must_haves:
  truths:
    - "Mode registry tests verify exclusive mode enforcement"
    - "Event system tests verify event emission and subscription"
    - "Plan parser tests verify PLAN.md parsing and task ID generation"
    - "Task mapper tests verify TaskMapping creation from parsed plans"
    - "Dependency map tests verify task dependency graph construction"
  artifacts:
    - path: "src/state/mode-registry.test.ts"
      provides: "Mode registry tests for exclusive mode management"
      min_lines: 80
    - path: "src/state/event-system.test.ts"
      provides: "Event system tests for pub/sub functionality"
      min_lines: 60
    - path: "src/sync/plan-parser.test.ts"
      provides: "Plan parser tests for PLAN.md sync operations"
      min_lines: 100
    - path: "src/sync/task-mapper.test.ts"
      provides: "Task mapper tests for TaskMapping generation"
      min_lines: 80
    - path: "src/sync/dependency-map.test.ts"
      provides: "Dependency map tests for task graph construction"
      min_lines: 60
  key_links:
    - from: "src/state/mode-registry.test.ts"
      to: "src/state/mode-registry.ts"
      via: "imports mode registry functions"
      pattern: "import.*from.*mode-registry"
    - from: "src/sync/plan-parser.test.ts"
      to: "src/sync/plan-parser.ts"
      via: "imports parsePlanForSync"
      pattern: "import.*parsePlanForSync"
---

<objective>
Create unit tests for state management and sync modules (Wave 2 - State and Sync Tests).

Purpose: Test the state management layer that tracks execution modes and the sync module that bridges PLAN.md documents with Claude's Task tool. These modules depend on the document parsing tested in Wave 1.

Output:
- `src/state/mode-registry.test.ts` - Mode registry tests
- `src/state/event-system.test.ts` - Event system tests
- `src/sync/plan-parser.test.ts` - Plan parser tests
- `src/sync/task-mapper.test.ts` - Task mapper tests
- `src/sync/dependency-map.test.ts` - Dependency map tests
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-test-coverage/22-RESEARCH.md

# Existing test patterns
@src/complexity/estimator.test.ts - Unit test pattern
@src/hooks/tool/category-routing.test.ts - Mocking pattern

# Source files to test
@src/state/mode-registry.ts - Mode tracking with mutual exclusion
@src/state/event-system.ts - Event pub/sub system
@src/sync/plan-parser.ts - PLAN.md parsing for sync
@src/sync/task-mapper.ts - Task mapping creation
@src/sync/dependency-map.ts - Dependency graph construction
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Mode Registry Tests</name>
  <files>src/state/mode-registry.test.ts</files>
  <action>
Create comprehensive tests for the mode registry module:

1. **isModeActive tests:**
   - Returns false for mode with no state file
   - Returns true for mode with active state file
   - Returns false for stale markers (older than threshold)
   - Handles missing activeProperty gracefully

2. **canStartMode tests:**
   - Returns allowed:true for non-exclusive modes
   - Returns allowed:true when no exclusive mode is active
   - Returns allowed:false with blockedBy when exclusive mode is active
   - Returns correct message with blocking mode name

3. **startMode tests:**
   - Creates state file with active:true
   - Includes startedAt timestamp
   - Includes process pid
   - Stores optional metadata
   - Returns false if blocked by another mode
   - Returns false for unconfigured mode

4. **endMode tests:**
   - Clears state file on end
   - Returns true on successful end
   - Returns false for unconfigured mode

5. **getActiveModes tests:**
   - Returns empty array when no modes active
   - Returns array of active mode statuses
   - Includes metadata and timestamps in status

6. **MODE_CONFIGS tests:**
   - All expected modes are configured
   - Each config has stateFile and activeProperty

Mock the StateManager or use in-memory state for isolation.

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import {
  isModeActive,
  canStartMode,
  startMode,
  endMode,
  getActiveModes,
  MODE_CONFIGS,
  EXCLUSIVE_MODES,
} from './mode-registry.js';
```
  </action>
  <verify>npm test -- src/state/mode-registry.test.ts</verify>
  <done>Mode registry tests pass, exclusive mode enforcement verified</done>
</task>

<task type="auto">
  <name>Task 2: Create Event System Tests</name>
  <files>src/state/event-system.test.ts</files>
  <action>
Create tests for the event system module:

1. **Event subscription tests:**
   - subscribe returns unsubscribe function
   - Multiple subscribers receive same event
   - Unsubscribe removes subscriber

2. **Event emission tests:**
   - emit calls all subscribers for event type
   - Subscribers receive event payload
   - No error when emitting with no subscribers

3. **Event types tests:**
   - Supports typed event payloads
   - Type safety for event data

4. **once subscription tests (if implemented):**
   - once subscriber called only once
   - once subscriber auto-unsubscribes after call

5. **Error handling tests:**
   - Subscriber error doesn't break other subscribers
   - Error is logged but not thrown

6. **Clear/reset tests:**
   - clearAll removes all subscribers
   - New subscriptions work after clear

Check event-system.ts exports to align tests with actual API.

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
// Import actual exports from event-system.ts
```
  </action>
  <verify>npm test -- src/state/event-system.test.ts</verify>
  <done>Event system tests pass, pub/sub functionality verified</done>
</task>

<task type="auto">
  <name>Task 3: Create Plan Parser Tests</name>
  <files>src/sync/plan-parser.test.ts</files>
  <action>
Create comprehensive tests for the sync plan parser:

1. **generateTaskId tests:**
   - Generates correct format: {phase}-{plan:02d}-{taskIndex:02d}
   - Handles phase with name (e.g., "06-claude-tasks-sync" -> "06")
   - Pads single digits correctly
   - Examples: phase "06", plan 1, task 1 -> "06-01-01"

2. **parsePlanForSync tests:**
   - Extracts frontmatter fields (phase, plan, wave)
   - Extracts tasks array using parseTasksSection
   - Returns correct path
   - Uses defaults for missing optional fields
   - Throws on file read error

3. **extractTaskMappings tests:**
   - Creates TaskMapping for each task
   - Generates deterministic task IDs
   - Includes wave from frontmatter
   - Sets initial status to 'pending'
   - Applies sync config defaults

4. **formatTaskPrompt tests:**
   - Formats auto task with all sections
   - Formats checkpoint:human-verify task
   - Formats checkpoint:decision task with options
   - Formats checkpoint:human-action task

5. **parseAndExtractMappings tests:**
   - Convenience function works end-to-end
   - Returns correct number of mappings

6. **findTaskById and filterTasksByStatus tests:**
   - findTaskById returns correct mapping
   - findTaskById returns undefined for unknown ID
   - filterTasksByStatus filters correctly

Use mock file system or create temp files for testing.

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import {
  generateTaskId,
  parsePlanForSync,
  extractTaskMappings,
  formatTaskPrompt,
  parseAndExtractMappings,
  findTaskById,
  filterTasksByStatus,
} from './plan-parser.js';
```
  </action>
  <verify>npm test -- src/sync/plan-parser.test.ts</verify>
  <done>Plan parser tests pass, all sync parsing functions verified</done>
</task>

<task type="auto">
  <name>Task 4: Create Task Mapper Tests</name>
  <files>src/sync/task-mapper.test.ts</files>
  <action>
Create tests for the task mapper module:

1. **TaskMapping creation tests:**
   - Creates mapping with all required fields
   - task_id follows expected format
   - plan_path is absolute path
   - tool_params include description, prompt, subagent_type, model

2. **Task type handling tests:**
   - Auto tasks get correct tool_params
   - Checkpoint tasks get checkpoint-aware params
   - Files are included in prompt for auto tasks

3. **Config application tests:**
   - Default model is applied
   - Default subagent is applied
   - Config overrides work

4. **Status management tests:**
   - Initial status is 'pending'
   - Status can be updated to 'in_progress'
   - Status can be updated to 'completed'
   - Status can be updated to 'failed'

5. **Description truncation tests:**
   - Long task names are truncated to 50 chars
   - "Task N:" prefix is removed
   - Truncation adds "..." suffix

Check task-mapper.ts to see what functions/classes are exported.
If the module re-exports from plan-parser.ts, focus on any unique exports.

```typescript
import { describe, it, expect } from 'vitest';
// Import actual exports from task-mapper.ts
```
  </action>
  <verify>npm test -- src/sync/task-mapper.test.ts</verify>
  <done>Task mapper tests pass, mapping creation and config verified</done>
</task>

<task type="auto">
  <name>Task 5: Create Dependency Map Tests</name>
  <files>src/sync/dependency-map.test.ts</files>
  <action>
Create tests for the dependency map module:

1. **Dependency graph construction tests:**
   - buildDependencyMap creates graph from mappings
   - Tasks with no dependencies are roots
   - Tasks with depends_on link to prior tasks

2. **Wave calculation tests:**
   - Wave 1 tasks have no dependencies
   - Wave 2 tasks depend on Wave 1
   - Correct wave assignment from frontmatter

3. **Dependency resolution tests:**
   - getDependencies returns task's dependencies
   - getDependents returns tasks depending on this task
   - Handles circular dependency detection (if implemented)

4. **Execution order tests:**
   - getExecutionOrder returns topological sort
   - Parallel tasks at same level grouped
   - Respects blockedBy relationships

5. **Graph queries tests:**
   - isBlocked returns true if dependencies incomplete
   - getUnblockedTasks returns tasks ready to execute
   - Updates as tasks complete

Check dependency-map.ts exports to align tests with actual API.

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
// Import actual exports from dependency-map.ts
```
  </action>
  <verify>npm test -- src/sync/dependency-map.test.ts</verify>
  <done>Dependency map tests pass, graph construction and queries verified</done>
</task>

</tasks>

<verification>
1. `npm test -- src/state/` - All state tests pass
2. `npm test -- src/sync/` - All sync tests pass
3. `npm run build` - No TypeScript errors in test files
4. Tests don't depend on external state files
5. Tests clean up any temp files created
</verification>

<success_criteria>
1. 5 new test files created for state and sync modules
2. Mode registry tests verify exclusive mode enforcement
3. Sync tests verify PLAN.md to Task tool bridge
4. All tests pass independently and together
5. Tests use mocks/fixtures instead of real file system where possible
6. Each test file has 60+ lines of comprehensive tests
</success_criteria>

<output>
After completion, create `.planning/phases/22-test-coverage/22-02-SUMMARY.md`
</output>
