---
phase: 20-category-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/orchestration/delegation/types.ts
  - src/orchestration/delegation/schema.ts
  - src/orchestration/delegation/manager.ts
  - src/orchestration/delegation/index.ts
autonomous: true

must_haves:
  truths:
    - "Zod schema validates CategoryConfig at runtime"
    - "9 categories exist (7 existing + unspecified-low + unspecified-high)"
    - "Thinking budget has token mapping (low=1000, medium=5000, high=10000, max=32000)"
    - "getCategoryThinkingBudgetTokens() returns token count for category"
  artifacts:
    - path: "src/orchestration/delegation/schema.ts"
      provides: "Zod schema for CategoryConfig"
      exports: ["CategoryConfigSchema", "BuiltinCategoryNameSchema", "ThinkingBudgetSchema"]
    - path: "src/orchestration/delegation/types.ts"
      provides: "DelegationCategory type with 9 categories, THINKING_BUDGET_TOKENS constant"
      contains: "unspecified-low"
    - path: "src/orchestration/delegation/manager.ts"
      provides: "getCategoryThinkingBudgetTokens function"
      exports: ["getCategoryThinkingBudgetTokens"]
  key_links:
    - from: "src/orchestration/delegation/manager.ts"
      to: "types.ts"
      via: "import THINKING_BUDGET_TOKENS"
      pattern: "THINKING_BUDGET_TOKENS\\[.*thinkingBudget"
    - from: "src/orchestration/delegation/index.ts"
      to: "schema.ts"
      via: "re-export"
      pattern: "export.*from.*schema"
---

<objective>
Add Zod schema validation, thinking budget token mapping, and fallback categories to the delegation module.

Purpose: Enable runtime validation of category configs and provide token budget mapping for Claude API integration.
Output: Enhanced delegation types with Zod schema, 9 categories, and thinking budget tokens.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-category-routing/20-RESEARCH.md

# Existing implementation to enhance
@src/orchestration/delegation/types.ts
@src/orchestration/delegation/manager.ts
@src/orchestration/delegation/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schema and add fallback categories</name>
  <files>
    src/orchestration/delegation/schema.ts
    src/orchestration/delegation/types.ts
    src/orchestration/delegation/index.ts
  </files>
  <action>
Create new file `src/orchestration/delegation/schema.ts` with Zod schemas:

```typescript
import { z } from 'zod';

// Thinking budget levels
export const ThinkingBudgetSchema = z.enum(['low', 'medium', 'high', 'max']);

// Builtin category names (9 total)
export const BuiltinCategoryNameSchema = z.enum([
  'quick',
  'standard',
  'complex',
  'ultrabrain',
  'visual-engineering',
  'artistry',
  'writing',
  'unspecified-low',    // NEW: fallback for explicit low-tier requests
  'unspecified-high',   // NEW: fallback for explicit high-tier requests
]);

// Model config within category
export const ModelConfigSchema = z.object({
  tier: z.enum(['haiku', 'sonnet', 'opus']),
  temperature: z.number().min(0).max(2),
  thinkingBudget: ThinkingBudgetSchema,
});

// Full category config
export const CategoryConfigSchema = z.object({
  category: BuiltinCategoryNameSchema,
  displayName: z.string(),
  description: z.string(),
  model: ModelConfigSchema,
  keywords: z.array(z.string()),
  useCases: z.array(z.string()),
});

// Export validator function
export function validateCategoryConfig(config: unknown): boolean {
  return CategoryConfigSchema.safeParse(config).success;
}
```

Update `types.ts`:
1. Add `'unspecified-low' | 'unspecified-high'` to DelegationCategory union type
2. Add THINKING_BUDGET_TOKENS constant:
```typescript
export const THINKING_BUDGET_TOKENS = {
  low: 1000,
  medium: 5000,
  high: 10000,
  max: 32000,
} as const;
```
3. Add configs for unspecified-low (haiku, temp 0.3, low budget) and unspecified-high (opus, temp 0.3, high budget) to DELEGATION_CATEGORIES
4. Add entries for unspecified-low/high in CATEGORY_AGENTS (map to 'executor-low' and 'executor-high')

Update `index.ts` to re-export from schema.ts.
  </action>
  <verify>
    `npm run build` succeeds
    `grep -r "unspecified-low" src/orchestration/delegation/` shows matches in types.ts and schema.ts
  </verify>
  <done>
    - schema.ts exports CategoryConfigSchema, BuiltinCategoryNameSchema, ThinkingBudgetSchema
    - DelegationCategory type includes 9 categories
    - THINKING_BUDGET_TOKENS constant exists with correct values
    - DELEGATION_CATEGORIES has 9 entries
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getCategoryThinkingBudgetTokens and update tests</name>
  <files>
    src/orchestration/delegation/manager.ts
    src/orchestration/delegation/manager.test.ts
  </files>
  <action>
Add to `manager.ts`:

```typescript
import { THINKING_BUDGET_TOKENS } from './types.js';

/**
 * Get thinking budget token count for a category.
 * Maps thinkingBudget string to actual token count for Claude API.
 */
export function getCategoryThinkingBudgetTokens(category: DelegationCategory): number {
  const config = DELEGATION_CATEGORIES[category];
  return THINKING_BUDGET_TOKENS[config.model.thinkingBudget];
}

/**
 * Get full category resolution with priority:
 * 1. Explicit category (if provided)
 * 2. Explicit tier -> unspecified-{tier}
 * 3. Auto-detect from description
 */
export function resolveCategory(options: {
  taskDescription: string;
  explicitCategory?: DelegationCategory;
  explicitTier?: ModelTier;
}): DelegationCategory {
  // 1. Explicit category wins
  if (options.explicitCategory) {
    return options.explicitCategory;
  }

  // 2. Explicit tier maps to unspecified-{tier}
  if (options.explicitTier) {
    return options.explicitTier === 'haiku' ? 'unspecified-low' : 'unspecified-high';
  }

  // 3. Auto-detect
  return detectCategory(options.taskDescription);
}
```

Add tests to `manager.test.ts`:

```typescript
describe('getCategoryThinkingBudgetTokens', () => {
  it('should return token count for each category', () => {
    expect(getCategoryThinkingBudgetTokens('quick')).toBe(1000);        // low
    expect(getCategoryThinkingBudgetTokens('standard')).toBe(5000);     // medium
    expect(getCategoryThinkingBudgetTokens('ultrabrain')).toBe(32000);  // max
    expect(getCategoryThinkingBudgetTokens('unspecified-low')).toBe(1000);
    expect(getCategoryThinkingBudgetTokens('unspecified-high')).toBe(10000);
  });
});

describe('resolveCategory', () => {
  it('should prefer explicit category', () => {
    expect(resolveCategory({
      taskDescription: 'find something',
      explicitCategory: 'ultrabrain'
    })).toBe('ultrabrain');
  });

  it('should map explicit tier to unspecified category', () => {
    expect(resolveCategory({
      taskDescription: 'do task',
      explicitTier: 'haiku'
    })).toBe('unspecified-low');

    expect(resolveCategory({
      taskDescription: 'do task',
      explicitTier: 'opus'
    })).toBe('unspecified-high');
  });

  it('should auto-detect when no explicit options', () => {
    expect(resolveCategory({
      taskDescription: 'debug the race condition'
    })).toBe('ultrabrain');
  });
});

describe('unspecified categories', () => {
  it('should have unspecified-low config', () => {
    const config = getCategoryConfig('unspecified-low');
    expect(config.model.tier).toBe('haiku');
  });

  it('should have unspecified-high config', () => {
    const config = getCategoryConfig('unspecified-high');
    expect(config.model.tier).toBe('opus');
  });
});
```
  </action>
  <verify>
    `npm test -- src/orchestration/delegation/manager.test.ts` passes
    `npm run build` succeeds
  </verify>
  <done>
    - getCategoryThinkingBudgetTokens() returns correct token counts
    - resolveCategory() implements priority resolution
    - All 9 categories have working configs and tests
    - listCategories() returns 9 categories
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
npm run build

# Tests pass
npm test -- src/orchestration/delegation/

# Schema exports exist
grep -q "CategoryConfigSchema" src/orchestration/delegation/schema.ts
grep -q "BuiltinCategoryNameSchema" src/orchestration/delegation/schema.ts

# 9 categories exist
grep -c "category:" src/orchestration/delegation/types.ts | grep -q "9"

# Token mapping works
grep -q "THINKING_BUDGET_TOKENS" src/orchestration/delegation/types.ts
```
</verification>

<success_criteria>
- Zod schema validates CategoryConfig at runtime
- 9 delegation categories exist (7 original + 2 fallbacks)
- THINKING_BUDGET_TOKENS maps budget levels to token counts
- getCategoryThinkingBudgetTokens() returns token count for any category
- resolveCategory() implements layered priority resolution
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-category-routing/20-01-SUMMARY.md`
</output>
