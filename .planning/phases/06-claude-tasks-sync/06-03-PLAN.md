---
phase: 06-claude-tasks-sync
plan: 3
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/sync/status-sync.ts
  - src/sync/index.ts
autonomous: true

must_haves:
  truths:
    - "Task completion updates PLAN.md checkbox status"
    - "Task states are tracked in frontmatter"
    - "Status updates preserve PLAN.md content integrity"
  artifacts:
    - path: "src/sync/status-sync.ts"
      provides: "Task status synchronization to PLAN.md"
      exports: ["updateTaskStatus", "getTaskStates", "markTaskComplete", "markTaskFailed"]
      min_lines: 80
  key_links:
    - from: "src/sync/status-sync.ts"
      to: "src/documents/templates/plan.ts"
      via: "import parsePlanMd, generatePlanMd"
      pattern: "parsePlanMd|generatePlanMd"
    - from: "src/sync/status-sync.ts"
      to: "src/sync/types.ts"
      via: "import TaskState, TaskMapping"
      pattern: "TaskState"
---

<objective>
Implement Task status to PLAN.md synchronization for completion tracking

Purpose: Enable automatic PLAN.md updates when tasks complete or fail
Output: status-sync.ts in src/sync/ for bidirectional state tracking
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-claude-tasks-sync/06-RESEARCH.md

# From Plan 06-01
@src/sync/types.ts
@src/sync/plan-parser.ts

# Existing plan utilities
@src/documents/templates/plan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement status sync utilities</name>
  <files>src/sync/status-sync.ts</files>
  <action>
Create status-sync.ts with functions for PLAN.md status updates:

1. Extended frontmatter type (internal):
   ```typescript
   interface ExtendedPlanFrontmatter extends PlanFrontmatter {
     task_states?: Record&lt;string, TaskState&gt;;
   }
   ```

2. getTaskStates(planPath: string): Promise&lt;Record&lt;string, TaskState&gt;&gt;
   - Read PLAN.md from planPath
   - Parse frontmatter with gray-matter
   - Return task_states field (or empty object if not present)

3. updateTaskStatus(
     planPath: string,
     taskId: string,
     update: Partial&lt;TaskState&gt;
   ): Promise&lt;void&gt;
   - Read PLAN.md
   - Parse with gray-matter
   - Update task_states[taskId] with spread: { ...existing, ...update }
   - Preserve all other frontmatter fields
   - Write updated PLAN.md back
   - Use generatePlanMd from templates/plan.ts

4. markTaskComplete(planPath: string, taskId: string): Promise&lt;void&gt;
   - Convenience wrapper for updateTaskStatus
   - Sets status: 'completed', completed_at: new Date().toISOString()

5. markTaskFailed(planPath: string, taskId: string, error: string): Promise&lt;void&gt;
   - Convenience wrapper for updateTaskStatus
   - Sets status: 'failed', error: error, completed_at: new Date().toISOString()

6. markTaskInProgress(planPath: string, taskId: string, agentId?: string): Promise&lt;void&gt;
   - Sets status: 'in_progress', started_at: new Date().toISOString()
   - Optionally stores agent_id for resumption

7. updateContentCheckbox(content: string, taskName: string, completed: boolean): string
   - Find task in content by name (regex match in XML)
   - Add or update status attribute: status="completed" or status="pending"
   - Return updated content
   - Note: This is optional enhancement - frontmatter tracking is primary

Import: fs/promises, path, gray-matter (matter), parsePlanMd/generatePlanMd from '../documents/templates/plan.js', TaskState from './types.js', PlanFrontmatter from '../types.js'.
  </action>
  <verify>npx tsc --noEmit src/sync/status-sync.ts</verify>
  <done>updateTaskStatus correctly reads, modifies, and writes PLAN.md with task states</done>
</task>

<task type="auto">
  <name>Task 2: Update sync module exports (final)</name>
  <files>src/sync/index.ts</files>
  <action>
Update index.ts to include status-sync exports:

Add re-exports from './status-sync.js':
- getTaskStates
- updateTaskStatus
- markTaskComplete
- markTaskFailed
- markTaskInProgress
- updateContentCheckbox

Final export organization:
```typescript
// Types
export type { TaskMapping, TaskState, TaskToolParams, SyncConfig } from './types.js';
export type { TaskInvocation } from './task-mapper.js';
export type { DependencyMap } from './dependency-map.js';

// Plan Parser
export { parsePlanForSync, extractTaskMappings, generateTaskId } from './plan-parser.js';

// Task Mapper
export { createTaskInvocation, createTaskInvocations, determineSubagentType } from './task-mapper.js';

// Dependency Mapping
export { buildDependencyMap, mapWaveToBlockedBy, getExecutionOrder } from './dependency-map.js';

// Status Sync
export {
  getTaskStates,
  updateTaskStatus,
  markTaskComplete,
  markTaskFailed,
  markTaskInProgress,
  updateContentCheckbox,
} from './status-sync.js';
```
  </action>
  <verify>npx tsc --noEmit src/sync/index.ts</verify>
  <done>Complete sync module API exported from src/sync</done>
</task>

<task type="auto">
  <name>Task 3: Add sync to main index</name>
  <files>src/index.ts</files>
  <action>
Update src/index.ts to include sync module exports:

Add at appropriate location (after existing modules):
```typescript
// Sync (Phase 6)
export * from './sync/index.js';
```

Verify that all sync types and functions are accessible from main package entry.
  </action>
  <verify>npx tsc --noEmit src/index.ts</verify>
  <done>Sync module accessible from main package entry point</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/sync/status-sync.ts exists with all status functions
- [ ] src/sync/index.ts has complete exports
- [ ] src/index.ts includes sync module
- [ ] npx tsc --noEmit passes for all files
- [ ] Task states correctly stored in frontmatter.task_states
</verification>

<success_criteria>

- getTaskStates reads task_states from PLAN.md frontmatter
- updateTaskStatus correctly modifies frontmatter without corrupting content
- markTaskComplete/Failed are convenient wrappers with correct timestamps
- PLAN.md file integrity preserved after updates
- Sync module fully integrated into main package

</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-tasks-sync/06-03-SUMMARY.md`
</output>
