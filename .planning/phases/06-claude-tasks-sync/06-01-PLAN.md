---
phase: 06-claude-tasks-sync
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sync/types.ts
  - src/sync/plan-parser.ts
  - src/sync/index.ts
autonomous: true

must_haves:
  truths:
    - "PLAN.md tasks can be parsed to TaskMapping objects"
    - "Task IDs are deterministic and stable across runs"
    - "All task types (auto, checkpoint) are mapped correctly"
  artifacts:
    - path: "src/sync/types.ts"
      provides: "TaskMapping, TaskState, SyncConfig interfaces"
      exports: ["TaskMapping", "TaskState", "TaskToolParams", "SyncConfig"]
      min_lines: 40
    - path: "src/sync/plan-parser.ts"
      provides: "Enhanced PLAN.md parser with task extraction"
      exports: ["parsePlanForSync", "extractTaskMappings", "generateTaskId"]
      min_lines: 80
    - path: "src/sync/index.ts"
      provides: "Module exports"
      min_lines: 5
  key_links:
    - from: "src/sync/plan-parser.ts"
      to: "src/documents/xml/task-parser.ts"
      via: "import parseTasksSection"
      pattern: "parseTasksSection"
    - from: "src/sync/plan-parser.ts"
      to: "src/documents/templates/plan.ts"
      via: "import parsePlanMd"
      pattern: "parsePlanMd"
---

<objective>
Implement sync module types and enhanced PLAN.md parser for task extraction

Purpose: Enable extraction of task details from PLAN.md for Claude Task tool synchronization
Output: src/sync/ module with types and plan parser
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-claude-tasks-sync/06-RESEARCH.md

# Existing infrastructure to integrate with
@src/documents/xml/task-parser.ts
@src/documents/xml/types.ts
@src/documents/templates/plan.ts
@src/documents/types.ts
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync module types</name>
  <files>src/sync/types.ts</files>
  <action>
Create TypeScript interfaces for the sync module:

1. TaskMapping interface - maps PLAN.md task to Task tool params:
   - task_id: string (deterministic, format: {phase}-{plan}-{taskIndex})
   - plan_path: string (path to PLAN.md)
   - name: string (task name)
   - type: TaskType (from xml/types.ts)
   - tool_params: TaskToolParams
   - status: TaskState['status']
   - wave: number (from plan frontmatter)

2. TaskToolParams interface - Claude Task tool invocation params:
   - description: string (3-5 words, max 50 chars)
   - prompt: string (full task instructions)
   - subagent_type: string (default: 'oh-my-claudecode:executor')
   - model?: 'sonnet' | 'opus' | 'haiku'

3. TaskState interface - task execution state:
   - status: 'pending' | 'in_progress' | 'completed' | 'failed'
   - started_at?: string (ISO timestamp)
   - completed_at?: string (ISO timestamp)
   - agent_id?: string (for resumption)
   - error?: string

4. SyncConfig interface - sync behavior configuration:
   - default_model: 'sonnet' | 'opus' | 'haiku'
   - default_subagent: string
   - update_checkboxes: boolean
   - track_in_frontmatter: boolean

Import TaskType from '../documents/xml/types.js'.
  </action>
  <verify>npx tsc --noEmit src/sync/types.ts</verify>
  <done>All interfaces exported, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Implement enhanced PLAN.md parser</name>
  <files>src/sync/plan-parser.ts</files>
  <action>
Create plan-parser.ts with functions to extract task mappings from PLAN.md:

1. generateTaskId(phase: string, plan: number, taskIndex: number): string
   - Format: `{phase}-{plan:02d}-{taskIndex:02d}` (e.g., "06-01-01")
   - Deterministic: same input = same output

2. parsePlanForSync(planPath: string): Promise&lt;PlanSyncData&gt;
   - Read PLAN.md file from planPath
   - Parse with gray-matter (existing parsePlanMd)
   - Extract tasks with parseTasksSection (from xml/task-parser.ts)
   - Return { frontmatter, tasks, path }

3. extractTaskMappings(planData: PlanSyncData): TaskMapping[]
   - Convert each parsed task to TaskMapping
   - Generate deterministic task_id
   - Create tool_params from task fields:
     - description: task.name.slice(0, 50)
     - prompt: formatTaskPrompt(task) - combine action, verify, done
     - subagent_type based on task type (auto vs checkpoint)
   - Set initial status: 'pending'
   - Include wave from frontmatter

4. formatTaskPrompt(task: Task): string
   - Format: "# {name}\n\n## Files\n{files}\n\n## Action\n{action}\n\n## Verification\n{verify}\n\n## Done Criteria\n{done}"
   - For checkpoint tasks, adapt format appropriately

Import: fs/promises, path, parsePlanMd from templates/plan.ts, parseTasksSection from xml/task-parser.ts, types from xml/types.ts and ./types.ts.
  </action>
  <verify>npx tsc --noEmit src/sync/plan-parser.ts</verify>
  <done>parsePlanForSync and extractTaskMappings work with test PLAN.md files</done>
</task>

<task type="auto">
  <name>Task 3: Create sync module index</name>
  <files>src/sync/index.ts</files>
  <action>
Create index.ts exporting all sync module public API:

1. Re-export all types from './types.js':
   - TaskMapping, TaskState, TaskToolParams, SyncConfig

2. Re-export functions from './plan-parser.js':
   - parsePlanForSync, extractTaskMappings, generateTaskId

Add JSDoc module comment explaining this is the Claude Tasks synchronization module.
  </action>
  <verify>npx tsc --noEmit src/sync/index.ts</verify>
  <done>All exports available from src/sync/index.ts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/sync/types.ts exists with all interfaces
- [ ] src/sync/plan-parser.ts exists with parser functions
- [ ] src/sync/index.ts exists with re-exports
- [ ] npx tsc --noEmit passes for all files
- [ ] Imports resolve correctly (xml/task-parser.ts, templates/plan.ts)
</verification>

<success_criteria>

- TaskMapping interface correctly models PLAN.md task to Task tool mapping
- generateTaskId produces deterministic IDs
- parsePlanForSync reads and parses PLAN.md files
- extractTaskMappings converts parsed tasks to TaskMapping objects
- All TypeScript types are correct with no errors

</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-tasks-sync/06-01-SUMMARY.md`
</output>
