---
phase: 16-context-compaction
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/context/extractor.ts
  - src/context/compactor.ts
  - src/context/index.ts
autonomous: true

must_haves:
  truths:
    - "Architecture decisions are extracted from STATE.md and notepads"
    - "Unresolved issues are preserved during compaction"
    - "Current progress state (phase, plan, task) is captured"
    - "Compacted context is under 20% of original size"
  artifacts:
    - path: "src/context/extractor.ts"
      provides: "Core information extraction from project state"
      exports: ["extractCoreInfo", "CoreInfo"]
    - path: "src/context/compactor.ts"
      provides: "Enhanced compaction with priority ordering"
      contains: "extractCoreInfo"
  key_links:
    - from: "src/context/compactor.ts"
      to: "src/context/extractor.ts"
      via: "import extractCoreInfo"
      pattern: "extractCoreInfo"
    - from: "src/context/extractor.ts"
      to: ".planning/STATE.md"
      via: "file read"
      pattern: "STATE.md"
---

<objective>
Implement core information extraction algorithm for context compaction.

Purpose: Preserve critical information (architecture decisions, unresolved issues, current state) while compressing context
Output: CoreInfo extractor and enhanced compaction that maintains <20% token waste
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/context/compactor.ts
@src/context/collector.ts
@src/notepad/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CoreInfo extractor module</name>
  <files>src/context/extractor.ts</files>
  <action>
Create src/context/extractor.ts:

1. Define CoreInfo interface:
```typescript
export interface CoreInfo {
  // Architecture & Decisions
  architectureDecisions: string[];  // From STATE.md Decisions section
  keyReferences: string[];          // From STATE.md Key References

  // Issues & Blockers
  unresolvedIssues: string[];       // From notepads/issues or STATE.md Blockers
  pendingTodos: string[];           // From STATE.md Pending Todos

  // Current Progress
  currentPhase: { number: number; name: string; status: string };
  currentPlan: { id: string; objective: string } | null;
  progressMetrics: { completed: number; total: number; percent: number };

  // Learnings (most recent 5)
  recentLearnings: string[];
}
```

2. Implement extractCoreInfo(planningDir: string): CoreInfo
   - Parse STATE.md for decisions, references, todos, blockers
   - Parse ROADMAP.md for current phase and progress
   - Parse .omc/notepads/_project/ for issues and learnings
   - Limit arrays to reasonable sizes (decisions: 10, issues: 5, learnings: 5)

3. Add priority ordering:
   - Issues (most actionable) first
   - Decisions (architectural context) second
   - Learnings (patterns) third
   - References (for lookup) last

Helper functions:
- parseStateDecisions(stateMd: string): string[]
- parseStateReferences(stateMd: string): string[]
- parseRoadmapProgress(roadmapMd: string): ProgressInfo
- loadNotepadWisdom(notepadDir: string): WisdomInfo
  </action>
  <verify>npm run build -- --filter=./src/context/extractor.ts passes</verify>
  <done>CoreInfo interface defined, extractCoreInfo function parses STATE.md and notepads correctly</done>
</task>

<task type="auto">
  <name>Task 2: Enhance compactor with CoreInfo integration</name>
  <files>src/context/compactor.ts, src/context/index.ts</files>
  <action>
Update src/context/compactor.ts:

1. Import extractCoreInfo from extractor.ts

2. Add new function: compactWithCoreInfo(options: CompactionOptions): CompactedContext
   - Calls extractCoreInfo to get prioritized core information
   - Merges with existing compactContext logic
   - Ensures compacted size is <20% of original

3. Update CompactedContext interface:
```typescript
export interface CompactedContext {
  // ... existing fields ...

  // New: Extracted core info
  coreInfo?: CoreInfo;

  // New: Compression stats
  compressionRatio: number;  // originalTokens / compactedTokens
}
```

4. Add compression validation:
```typescript
function validateCompression(original: number, compacted: number): boolean {
  const ratio = compacted / original;
  return ratio <= 0.20; // Must be under 20%
}
```

5. If compression fails (>20%), progressively remove:
   - References (least critical)
   - Older learnings
   - Detailed progress info
   Until under 20%

Update src/context/index.ts:
- Export extractCoreInfo, CoreInfo from extractor
- Export compactWithCoreInfo
  </action>
  <verify>npm run build passes, compression ratio calculated correctly</verify>
  <done>compactWithCoreInfo produces context under 20% of original, CoreInfo integrated</done>
</task>

<task type="auto">
  <name>Task 3: Add extraction and compression tests</name>
  <files>src/context/extractor.test.ts</files>
  <action>
Create src/context/extractor.test.ts:

1. Test STATE.md parsing:
   - Create mock STATE.md content with Decisions, References, Todos sections
   - Verify extractCoreInfo extracts each section correctly
   - Verify array limits enforced (max 10 decisions, 5 issues)

2. Test ROADMAP.md progress parsing:
   - Mock ROADMAP.md with phase completion checkboxes
   - Verify currentPhase and progressMetrics accurate

3. Test notepad integration:
   - Create temp .omc/notepads/_project/ with issues.md, learnings.md
   - Verify files parsed and content extracted

4. Test compression ratio:
   - Create large mock context (~10000 tokens)
   - Run compactWithCoreInfo
   - Assert compactedTokens / originalTokens <= 0.20

5. Test priority ordering:
   - Verify issues appear before decisions in output
   - Verify learnings limited to 5 most recent

Use vitest with temp directories for file-based tests.
  </action>
  <verify>npm test -- src/context/extractor.test.ts passes all tests</verify>
  <done>Extraction tests pass, compression under 20% verified, priority ordering correct</done>
</task>

</tasks>

<verification>
- npm run build succeeds
- npm test -- src/context/ passes
- extractCoreInfo parses STATE.md correctly
- Compression ratio <= 20% for test cases
</verification>

<success_criteria>
1. CoreInfo captures architecture decisions from STATE.md
2. Unresolved issues extracted from notepads and STATE.md blockers
3. Current progress (phase/plan/task) accurately captured
4. Compacted context is verifiably under 20% of original size
</success_criteria>

<output>
After completion, create `.planning/phases/16-context-compaction/16-02-SUMMARY.md`
</output>
