---
phase: 16-context-compaction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/context/types.ts
  - src/context/advanced-monitor.ts
  - src/context/index.ts
autonomous: true

must_haves:
  truths:
    - "Context usage can be tracked in real-time"
    - "80% threshold is configurable and detectable"
    - "Auto-compaction threshold is distinct from existing 70%/85%"
  artifacts:
    - path: "src/context/types.ts"
      provides: "AutoCompactionConfig type with 80% threshold"
      contains: "AUTO_COMPACTION_THRESHOLD"
    - path: "src/context/advanced-monitor.ts"
      provides: "AdvancedContextMonitor with auto-compaction detection"
      exports: ["AdvancedContextMonitor", "createAdvancedMonitor"]
  key_links:
    - from: "src/context/advanced-monitor.ts"
      to: "src/context/types.ts"
      via: "import AUTO_COMPACTION_THRESHOLD"
      pattern: "AUTO_COMPACTION_THRESHOLD"
---

<objective>
Enhance context monitoring to support 80% auto-compaction threshold detection.

Purpose: Enable automatic context compaction triggers at 80% usage (before the existing 85% critical threshold)
Output: AdvancedContextMonitor class with configurable auto-compaction threshold and state tracking
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/context/types.ts
@src/context/monitor.ts
@src/context/thresholds.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-compaction threshold constant and types</name>
  <files>src/context/types.ts</files>
  <action>
Add to src/context/types.ts:

1. New constant:
   ```typescript
   /** Auto-compaction threshold - trigger compaction at 80% */
   export const AUTO_COMPACTION_THRESHOLD = 0.80;
   ```

2. Extend ContextConfig:
   ```typescript
   /** Auto-compaction threshold ratio (default: 0.80) */
   autoCompactionThreshold?: number;
   ```

3. Add new ThresholdStatus value:
   ```typescript
   export type ThresholdStatus = 'normal' | 'warning' | 'auto_compact' | 'critical';
   ```

4. Add new ContextAction:
   ```typescript
   export type ContextAction = 'none' | 'prepare_handoff' | 'auto_compact' | 'force_return';
   ```
  </action>
  <verify>npm run build -- --filter=./src/context/types.ts passes without errors</verify>
  <done>AUTO_COMPACTION_THRESHOLD=0.80 constant exists, ContextConfig has autoCompactionThreshold field, ThresholdStatus includes 'auto_compact'</done>
</task>

<task type="auto">
  <name>Task 2: Implement AdvancedContextMonitor with auto-compaction detection</name>
  <files>src/context/advanced-monitor.ts, src/context/index.ts</files>
  <action>
Create src/context/advanced-monitor.ts:

1. Import types and existing monitor infrastructure
2. Create AdvancedContextMonitor class that:
   - Extends behavior of existing ContextMonitor
   - Tracks three thresholds: warning (70%), auto_compact (80%), critical (85%)
   - Emits 'context_auto_compaction_triggered' event at 80%
   - Returns 'auto_compact' action when 80% reached
   - Tracks whether compaction has been triggered this session (to avoid repeated triggers)

Key methods:
- constructor(agentId, config): Initialize with autoCompactionThreshold
- checkAutoCompaction(): boolean - Check if at 80% and not yet triggered
- triggerAutoCompaction(): void - Mark compaction as triggered, emit event
- getAdvancedState(): AdvancedContextState - Include autoCompactionTriggered flag

State interface:
```typescript
export interface AdvancedContextState extends SubagentContextState {
  autoCompactionTriggered: boolean;
  autoCompactionThreshold: number;
}
```

Update src/context/index.ts:
- Export AdvancedContextMonitor and createAdvancedMonitor
  </action>
  <verify>npm run build passes, new exports available from src/context/index.ts</verify>
  <done>AdvancedContextMonitor detects 80% threshold, emits auto_compaction event, tracks triggered state</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for advanced monitoring</name>
  <files>src/context/advanced-monitor.test.ts</files>
  <action>
Create src/context/advanced-monitor.test.ts with tests:

1. Test auto-compaction threshold detection:
   - Track content until 80% usage
   - Verify 'auto_compact' action returned
   - Verify autoCompactionTriggered becomes true

2. Test threshold ordering (70% < 80% < 85%):
   - Verify warning at 70%, auto_compact at 80%, critical at 85%
   - Each threshold triggers only once

3. Test configurable threshold:
   - Create monitor with custom autoCompactionThreshold: 0.75
   - Verify triggers at 75% instead of 80%

4. Test event emission:
   - Verify 'context_auto_compaction_triggered' event emitted exactly once

Use vitest, mock StateManager if needed, test with small contextLimit (1000 tokens) for fast tests.
  </action>
  <verify>npm test -- src/context/advanced-monitor.test.ts passes all tests</verify>
  <done>All 4 test scenarios pass, advanced monitoring behavior verified</done>
</task>

</tasks>

<verification>
- npm run build succeeds
- npm test -- src/context/ passes
- AUTO_COMPACTION_THRESHOLD = 0.80 in types.ts
- AdvancedContextMonitor exported from index.ts
</verification>

<success_criteria>
1. New 80% auto-compaction threshold is distinct from existing 70% warning and 85% critical
2. AdvancedContextMonitor tracks and reports when 80% threshold crossed
3. Event system integration for auto-compaction trigger
4. Configurable threshold via ContextConfig.autoCompactionThreshold
</success_criteria>

<output>
After completion, create `.planning/phases/16-context-compaction/16-01-SUMMARY.md`
</output>
