---
phase: 07-cli-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ultraplan-new-project.md
  - src/orchestration/keywords/command-triggers.ts
autonomous: true

must_haves:
  truths:
    - "User can run /ultraplan:new-project and interview begins"
    - "User can say 'ultraplan new project' and interview begins"
    - "Command validates existing state before spawning agent"
    - "Planner agent receives complete context (pwd, brownfield detection)"
  artifacts:
    - path: ".claude/commands/ultraplan-new-project.md"
      provides: "Slash command definition with validation and agent spawning"
      contains: "subagent_type"
    - path: "src/orchestration/keywords/command-triggers.ts"
      provides: "Keyword to command mapping"
      exports: ["COMMAND_KEYWORDS", "getCommandForKeyword"]
  key_links:
    - from: ".claude/commands/ultraplan-new-project.md"
      to: ".claude/agents/ultraplan-planner.md"
      via: "Task tool spawning"
      pattern: "ultraplan-planner"
    - from: "src/orchestration/keywords/command-triggers.ts"
      to: "src/orchestration/keywords/patterns.ts"
      via: "keyword pattern reuse"
      pattern: "import.*patterns"
---

<objective>
Complete the /ultraplan:new-project command with full validation, context assembly, and agent spawning.

Purpose: Enable users to initialize new Ultra Planner projects via slash command or natural language keyword.
Output: Working slash command that spawns Planner agent with complete context.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-cli-commands/07-RESEARCH.md

# Existing command (80% complete)
@.claude/commands/ultraplan-new-project.md

# Agent to spawn
@.claude/agents/ultraplan-planner.md

# Keyword patterns to integrate
@src/orchestration/keywords/patterns.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Finalize ultraplan-new-project command</name>
  <files>.claude/commands/ultraplan-new-project.md</files>
  <action>
Update the existing ultraplan-new-project.md command to:

1. **Fix directory references**: Use `.planning/` not `.ultraplan/` for all file paths:
   - PROJECT.md at .planning/PROJECT.md
   - ROADMAP.md at .planning/ROADMAP.md
   - STATE.md at .planning/STATE.md
   - Plans at .planning/phases/

2. **Ensure complete validation section** with clear decision matrix:
   - Check .planning/ directory exists
   - Check PROJECT.md exists
   - Handle brownfield vs greenfield detection

3. **Finalize Task tool invocation format**:
   ```
   Task(
     subagent_type="ultraplan-planner",
     model="opus",
     prompt="..."
   )
   ```
   - Include NEW-PROJECT mode flag
   - Include pwd, directory name, brownfield/greenfield context
   - Include user description extraction from arguments

4. **Add unattended mode handling**:
   - Auto-proceed without confirmation when in /thorough mode
   - Log decisions for audit trail

5. **Verify error handling is complete**:
   - Permission check
   - Partial initialization handling
   - Agent spawn failure recovery
  </action>
  <verify>
Read the updated command file and verify:
- All paths use .planning/ not .ultraplan/
- Task tool invocation is properly formatted
- Decision matrix covers all states
- Error handling is comprehensive
  </verify>
  <done>
Command file is complete with:
- Correct .planning/ directory references
- Complete validation section
- Proper Task tool invocation for planner agent
- Unattended mode support
  </done>
</task>

<task type="auto">
  <name>Task 2: Create command keyword trigger mapping</name>
  <files>src/orchestration/keywords/command-triggers.ts</files>
  <action>
Create a new TypeScript module that maps keywords to slash commands:

```typescript
/**
 * Command Keyword Triggers
 *
 * Maps natural language keywords to slash commands for unified invocation.
 */

import type { MagicKeyword } from './types.js';

// Command trigger keywords
export const NEW_PROJECT_KEYWORD: MagicKeyword = {
  triggers: ['ultraplan new', 'new project', 'start project', 'init ultraplan'],
  description: 'Initialize new Ultra Planner project',
  action: (prompt: string) => {
    // Extract description after trigger
    const cleaned = prompt.replace(/ultraplan\s+new|new\s+project|start\s+project|init\s+ultraplan/gi, '').trim();
    return `[COMMAND: /ultraplan:new-project ${cleaned}]`;
  }
};

export const PLAN_PHASE_KEYWORD: MagicKeyword = {
  triggers: ['ultraplan plan', 'plan phase'],
  description: 'Plan a specific phase',
  action: (prompt: string) => {
    // Extract phase number
    const match = prompt.match(/phase\s*(\d+)|(\d+)/i);
    const phase = match ? match[1] || match[2] : '';
    return `[COMMAND: /ultraplan:plan-phase ${phase}]`;
  }
};

export const EXECUTE_KEYWORD: MagicKeyword = {
  triggers: ['ultraplan execute', 'execute plan', 'run plan'],
  description: 'Execute a plan file',
  action: (prompt: string) => {
    // Extract plan reference
    const match = prompt.match(/(\d+-\d+)/);
    const plan = match ? match[1] : '';
    return `[COMMAND: /ultraplan:execute ${plan}]`;
  }
};

export const COMMAND_KEYWORDS: MagicKeyword[] = [
  NEW_PROJECT_KEYWORD,
  PLAN_PHASE_KEYWORD,
  EXECUTE_KEYWORD,
];

/**
 * Get command for keyword if matched
 */
export function getCommandForKeyword(input: string): string | null {
  const lower = input.toLowerCase();
  for (const kw of COMMAND_KEYWORDS) {
    for (const trigger of kw.triggers) {
      if (lower.includes(trigger)) {
        return kw.action(input);
      }
    }
  }
  return null;
}
```

This creates:
1. Keywords for each command (new-project, plan-phase, execute)
2. Action functions that extract relevant parameters
3. getCommandForKeyword function for orchestrator use
  </action>
  <verify>
Run TypeScript compilation:
```bash
cd /home/ubuntu/code/ultra-planning && npx tsc --noEmit src/orchestration/keywords/command-triggers.ts
```
Should compile without errors.
  </verify>
  <done>
command-triggers.ts exists with:
- NEW_PROJECT_KEYWORD for new project triggers
- PLAN_PHASE_KEYWORD for planning triggers
- EXECUTE_KEYWORD for execution triggers
- getCommandForKeyword export function
  </done>
</task>

</tasks>

<verification>
1. Read .claude/commands/ultraplan-new-project.md and verify .planning/ paths
2. Run `npx tsc --noEmit` to verify TypeScript compiles
3. Verify command-triggers.ts exports are correct
</verification>

<success_criteria>
- /ultraplan:new-project command uses correct .planning/ directory structure
- Keywords "ultraplan new", "new project" map to the command
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-commands/07-01-SUMMARY.md`
</output>
