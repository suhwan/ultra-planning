---
phase: 07-cli-commands
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ultraplan-execute.md
autonomous: true

must_haves:
  truths:
    - "User can run /ultraplan:execute 07-01 and tasks execute"
    - "Command accepts shorthand (07-01) and resolves to full path"
    - "Tasks are registered in Claude Tasks API before execution"
    - "Executor agent is spawned for each task"
    - "Architect agent verifies each task completion"
    - "STATE.md updates after task completion"
  artifacts:
    - path: ".claude/commands/ultraplan-execute.md"
      provides: "Slash command for plan execution"
      contains: "Router Protocol"
  key_links:
    - from: ".claude/commands/ultraplan-execute.md"
      to: ".claude/skills/ultraplan/references/router.md"
      via: "Protocol reference"
      pattern: "router.md"
    - from: ".claude/commands/ultraplan-execute.md"
      to: ".claude/agents/ultraplan-executor.md"
      via: "Task tool spawning for execution"
      pattern: "ultraplan-executor"
    - from: ".claude/commands/ultraplan-execute.md"
      to: ".claude/agents/ultraplan-architect.md"
      via: "Task tool spawning for verification"
      pattern: "ultraplan-architect"
---

<objective>
Complete the /ultraplan:execute command with Router Protocol integration, task sync, and full execution loop.

Purpose: Enable users to execute PLAN.md tasks via slash command with proper agent orchestration.
Output: Working slash command that executes tasks using Executor/Architect verification loop.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-cli-commands/07-RESEARCH.md

# Existing command (80% complete)
@.claude/commands/ultraplan-execute.md

# Router protocol reference
@.claude/skills/ultraplan/references/router.md

# Agents to spawn
@.claude/agents/ultraplan-executor.md
@.claude/agents/ultraplan-architect.md

# Sync module
@src/sync/task-mapper.ts
@src/sync/status-sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Finalize ultraplan-execute command</name>
  <files>.claude/commands/ultraplan-execute.md</files>
  <action>
Update the existing ultraplan-execute.md command to:

1. **Fix directory references**: Use `.planning/` structure:
   - STATE.md at .planning/STATE.md
   - Plans at .planning/phases/{phase}-{name}/{phase}-{NN}-PLAN.md

2. **Update shorthand resolution**:
   ```bash
   # Accept: "07-01", "07-01-PLAN.md", or full path
   # Resolve to: .planning/phases/07-cli-commands/07-01-PLAN.md

   parse_plan_path() {
     local input="$1"

     # If full path exists, use it
     if [[ -f "$input" ]]; then
       echo "$input"
       return
     fi

     # Extract phase and plan from shorthand (e.g., "07-01")
     local phase=$(echo "$input" | cut -d'-' -f1)
     local plan_num=$(echo "$input" | cut -d'-' -f2 | sed 's/-PLAN.md//')

     # Pad phase number
     local padded=$(printf "%02d" "$phase")

     # Find phase directory
     local phase_dir=$(ls -d .planning/phases/${padded}-* 2>/dev/null | head -1)

     if [[ -z "$phase_dir" ]]; then
       echo "ERROR: Phase directory not found for phase $phase"
       return 1
     fi

     # Construct full path
     echo "${phase_dir}/${padded}-${plan_num}-PLAN.md"
   }
   ```

3. **Add prerequisite validation**:
   - Check PLAN.md exists at resolved path
   - Check STATE.md exists
   - Check required agents exist:
     - .claude/agents/ultraplan-executor.md
     - .claude/agents/ultraplan-architect.md

4. **Add Router Protocol execution loop documentation**:
   Reference the router.md for execution flow but inline the key steps:

   ```markdown
   ### Execution Loop

   For each task in PLAN.md (ordered by wave):

   1. **Check dependencies**: Ensure all blockers are complete
   2. **Spawn Executor**:
      ```
      Task(
        subagent_type="ultraplan-executor",
        model="sonnet",
        prompt="Execute task: {task_xml}"
      )
      ```
   3. **On Executor success, spawn Architect**:
      ```
      Task(
        subagent_type="ultraplan-architect",
        model="opus",
        prompt="Verify task completion: {task_xml}\n\nExecutor result: {result}"
      )
      ```
   4. **On Architect approval**:
      - Mark task complete in STATE.md
      - Commit changes
      - Unblock dependent tasks
   5. **On failure**: Retry up to 3 times with feedback
   ```

5. **Add progress display format**:
   ```
   Executing: 07-01-PLAN.md
   =======================================

   [=====-----] 2/5 tasks complete

   Current: Task 3: Create keyword triggers
     Status: Executing...
     Elapsed: 45s
   ```

6. **Add completion summary format**:
   ```
   Plan Execution Complete
   =======================================

   Plan: 07-01-PLAN.md
   Status: SUCCESS

   Results:
     [x] Task 1: Finalize command (1m 23s)
     [x] Task 2: Create triggers (2m 05s)

   Total Time: 3m 28s
   Commits: 2

   Next:
     /ultraplan:execute 07-02  (next plan)
     /ultraplan:status         (view progress)
   ```

7. **Add unattended mode handling**:
   - Auto-proceed without "Proceed? (y/n)" confirmation
   - Auto-retry on failures
   - Only stop for permanent failures after 3 retries
  </action>
  <verify>
Read the updated command file and verify:
- Shorthand resolution handles phase directory discovery
- Prerequisite validation checks all required files
- Execution loop documentation is complete
- Progress and completion formats are defined
  </verify>
  <done>
Command file is complete with:
- Correct .planning/ directory structure
- Shorthand resolution with phase discovery
- Complete prerequisite validation
- Router Protocol execution loop
- Progress and completion display formats
- Unattended mode support
  </done>
</task>

<task type="auto">
  <name>Task 2: Add task queue and state management section</name>
  <files>.claude/commands/ultraplan-execute.md</files>
  <action>
Enhance the command with task queue management:

1. **Add task queue building section**:
   ```markdown
   ### Building Task Queue

   1. Parse PLAN.md frontmatter and task XML
   2. Extract tasks with wave assignments
   3. Build dependency map from waves:
      - Wave 0 tasks: No dependencies
      - Wave N tasks: Blocked by all Wave 0..N-1 tasks
   4. Sort by wave, then by task index
   ```

2. **Add Claude Tasks API integration section**:
   ```markdown
   ### Claude Tasks Registration

   Before execution, register tasks in Claude Tasks API:

   For each task:
   - TaskCreate with subject = task name
   - Set blockedBy based on wave dependencies
   - Store mapping: task_id -> Claude task ID

   This enables:
   - Visual task tracking during execution
   - Dependency visualization in Claude UI
   - Session-level progress persistence
   ```

3. **Add state sync section**:
   ```markdown
   ### State Synchronization

   After each task completion:

   1. Update PLAN.md frontmatter (task_states field)
   2. Update STATE.md progress section
   3. Sync Claude Tasks status to 'completed'

   On resume (if execution interrupted):
   1. Read task_states from PLAN.md frontmatter
   2. Skip tasks already marked complete
   3. Re-register pending tasks in Claude Tasks
   ```

4. **Add error handling section**:
   ```markdown
   ### Error Handling

   | Error | Response |
   |-------|----------|
   | Plan file not found | "Plan not found: {path}. Check path." |
   | Agent spawn failure | Retry spawn 3 times, then abort |
   | Task failed 3x | Mark permanent failure, offer skip/retry/abort |
   | Architect rejected 3x | Same as task failure |
   ```
  </action>
  <verify>
Read the command and verify all sections are present: task queue building, Claude Tasks registration, state synchronization, error handling.
  </verify>
  <done>
Command includes:
- Task queue building section
- Claude Tasks API integration section
- State synchronization section
- Comprehensive error handling table
  </done>
</task>

</tasks>

<verification>
1. Read .claude/commands/ultraplan-execute.md
2. Verify shorthand resolution logic
3. Verify execution loop references Router Protocol correctly
4. Verify state sync and Claude Tasks integration documented
</verification>

<success_criteria>
- Command accepts shorthand (07-01) and resolves to full .planning/ path
- Execution loop spawns Executor then Architect for each task
- Task states sync to PLAN.md frontmatter and Claude Tasks API
- Error handling covers all failure modes
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-commands/07-03-SUMMARY.md`
</output>
