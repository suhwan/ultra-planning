---
phase: 07-cli-commands
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ultraplan-plan-phase.md
autonomous: true

must_haves:
  truths:
    - "User can run /ultraplan:plan-phase 7 and PLAN.md files are generated"
    - "Command validates ROADMAP.md exists before planning"
    - "Command validates phase number exists in ROADMAP"
    - "Generated plans are registered in Claude Tasks API"
  artifacts:
    - path: ".claude/commands/ultraplan-plan-phase.md"
      provides: "Slash command for phase planning"
      contains: "ultraplan-planner"
  key_links:
    - from: ".claude/commands/ultraplan-plan-phase.md"
      to: ".claude/agents/ultraplan-planner.md"
      via: "Task tool spawning in PHASE-PLANNING mode"
      pattern: "PHASE-PLANNING"
    - from: ".claude/commands/ultraplan-plan-phase.md"
      to: "src/sync/task-mapper.ts"
      via: "References task registration pattern"
      pattern: "Tasks API"
---

<objective>
Complete the /ultraplan:plan-phase command with proper validation, context assembly, and Task API integration.

Purpose: Enable users to generate PLAN.md files for a specific phase via slash command.
Output: Working slash command that spawns Planner agent in PHASE-PLANNING mode and integrates with Task sync.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-cli-commands/07-RESEARCH.md

# Existing command (80% complete)
@.claude/commands/ultraplan-plan-phase.md

# Agent to spawn
@.claude/agents/ultraplan-planner.md

# Task sync reference
@src/sync/task-mapper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Finalize ultraplan-plan-phase command</name>
  <files>.claude/commands/ultraplan-plan-phase.md</files>
  <action>
Update the existing ultraplan-plan-phase.md command to:

1. **Fix directory references**: Use `.planning/` not `.ultraplan/` for all file paths:
   - ROADMAP.md at .planning/ROADMAP.md
   - PROJECT.md at .planning/PROJECT.md
   - STATE.md at .planning/STATE.md
   - Plans at .planning/phases/{phase}-{name}/ (match actual structure)

2. **Add phase directory discovery**:
   ```bash
   # Find phase directory with zero-padded or unpadded names
   PADDED_PHASE=$(printf "%02d" ${phase_number})
   PHASE_DIR=$(ls -d .planning/phases/${PADDED_PHASE}-* .planning/phases/${phase_number}-* 2>/dev/null | head -1)
   ```

3. **Update Task tool prompt for PHASE-PLANNING mode**:
   - Clear mode indicator: PHASE-PLANNING (not NEW-PROJECT)
   - Include phase goal from ROADMAP.md
   - Include success criteria from ROADMAP.md
   - Include context from PROJECT.md
   - Instruct to write PLAN.md files to phase directory

4. **Add Task API registration note**:
   After Planner generates plans, note that tasks will be registered in Claude Tasks API:
   ```markdown
   ## After Plan Generation

   Tasks from generated PLAN.md files are registered in Claude Tasks API
   for execution tracking. Use `/ultraplan:execute {plan}` to begin execution.
   ```

5. **Add unattended mode handling**:
   - Auto-proceed when prior phases not complete (warn but continue)
   - Auto-overwrite existing plans with backup
   - Skip confirmation prompts in /thorough mode

6. **Fix plan naming convention**:
   - Plans go in: .planning/phases/{phase_dir}/{phase}-{NN}-PLAN.md
   - Example: .planning/phases/07-cli-commands/07-01-PLAN.md
   - NOT: .ultraplan/plans/{phase}-01-{name}.md
  </action>
  <verify>
Read the updated command file and verify:
- All paths use .planning/ structure
- Phase directory discovery uses zero-padding fallback
- Task tool invocation is complete
- Plan naming matches actual convention
  </verify>
  <done>
Command file is complete with:
- Correct .planning/phases/{phase}-{name}/ directory structure
- Zero-padded phase directory discovery
- Complete Task tool invocation for Planner in PHASE-PLANNING mode
- Task API registration documentation
- Unattended mode support
  </done>
</task>

<task type="auto">
  <name>Task 2: Add context extraction helpers</name>
  <files>.claude/commands/ultraplan-plan-phase.md</files>
  <action>
Enhance the command with robust context extraction:

1. **Add phase goal extraction**:
   ```bash
   # Extract phase goal from ROADMAP.md
   PHASE_GOAL=$(sed -n "/^### Phase ${phase_number}:/,/^### Phase/p" .planning/ROADMAP.md | \
     grep "^**Goal**:" | sed 's/^**Goal**: //')
   ```

2. **Add success criteria extraction**:
   ```bash
   # Extract success criteria
   SUCCESS=$(sed -n "/^### Phase ${phase_number}:/,/^### Phase/p" .planning/ROADMAP.md | \
     sed -n '/^**Success Criteria/,/^**Plans/p' | head -n -1)
   ```

3. **Add depends_on extraction**:
   ```bash
   # Extract dependencies
   DEPENDS=$(sed -n "/^### Phase ${phase_number}:/,/^### Phase/p" .planning/ROADMAP.md | \
     grep "^**Depends on**:" | sed 's/^**Depends on**: //')
   ```

4. **Update prompt template to use extracted values**:
   ```
   Task(
     subagent_type="ultraplan-planner",
     model="opus",
     prompt="""
   You are planning Phase {phase_number}: {PHASE_GOAL}

   ## Mode
   PHASE-PLANNING

   ## Phase Definition
   **Goal:** {PHASE_GOAL}
   **Depends on:** {DEPENDS}

   ## Success Criteria
   {SUCCESS}

   ## Output Location
   Write PLAN.md files to: {PHASE_DIR}/
   Naming: {phase_number}-01-PLAN.md, {phase_number}-02-PLAN.md, etc.

   ...
   """
   )
   ```
  </action>
  <verify>
Read the command and verify extraction commands are present and properly integrated into the Task prompt.
  </verify>
  <done>
Command includes:
- Phase goal extraction from ROADMAP.md
- Success criteria extraction
- Dependency extraction
- All extracted values used in Planner prompt
  </done>
</task>

</tasks>

<verification>
1. Read .claude/commands/ultraplan-plan-phase.md
2. Verify all paths use .planning/ structure
3. Verify context extraction commands are correct
4. Verify Task tool invocation includes all context
</verification>

<success_criteria>
- Command uses correct .planning/phases/ directory structure
- Phase directory discovery handles zero-padding variations
- Context extraction works for goal, success criteria, dependencies
- Planner agent receives complete context for PHASE-PLANNING mode
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-commands/07-02-SUMMARY.md`
</output>
