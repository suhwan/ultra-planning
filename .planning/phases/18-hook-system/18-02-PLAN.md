---
phase: 18-hook-system
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/hooks/core/todo-continuation-enforcer.ts
  - src/hooks/core/index.ts
autonomous: true

must_haves:
  truths:
    - "Hook detects session.idle with incomplete todos"
    - "2-second countdown before auto-injection"
    - "Continuation prompt injected when countdown completes"
    - "Countdown cancelled on user activity"
    - "Background tasks awareness (skip if pending)"
  artifacts:
    - path: "src/hooks/core/todo-continuation-enforcer.ts"
      provides: "Todo continuation enforcer hook"
      exports: ["createTodoContinuationEnforcerHook", "TodoContinuationEnforcerOptions"]
    - path: "src/hooks/core/index.ts"
      provides: "Core hooks barrel export"
      exports: ["createTodoContinuationEnforcerHook"]
  key_links:
    - from: "src/hooks/core/todo-continuation-enforcer.ts"
      to: "src/hooks/types.ts"
      via: "Implements HookHandlers interface"
      pattern: "HookHandlers"
    - from: "src/hooks/core/todo-continuation-enforcer.ts"
      to: "src/hooks/orchestrator/types.ts"
      via: "Uses createSystemDirective"
      pattern: "createSystemDirective"
---

<objective>
Implement the todo-continuation-enforcer hook that automatically continues work when session becomes idle with incomplete tasks.

Purpose: Prevent agents from stopping prematurely when tasks remain - a critical feature from oh-my-opencode.
Output: Production-ready hook that auto-injects continuation prompts after 2-second countdown.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-hook-system/18-RESEARCH.md
@.planning/phases/18-hook-system/18-01-SUMMARY.md

# Reference implementation
@references/oh-my-opencode/src/hooks/todo-continuation-enforcer.ts

# Hook types from 18-01
@src/hooks/types.ts
@src/hooks/registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Todo continuation enforcer implementation</name>
  <files>src/hooks/core/todo-continuation-enforcer.ts</files>
  <action>
Create the todo-continuation-enforcer hook following oh-my-opencode patterns:

1. **Session state tracking**:
   ```typescript
   interface SessionState {
     countdownTimer?: ReturnType<typeof setTimeout>;
     countdownInterval?: ReturnType<typeof setInterval>;
     isRecovering?: boolean;
     countdownStartedAt?: number;
     abortDetectedAt?: number;
   }

   const sessions = new Map<string, SessionState>();
   ```

2. **Configuration options**:
   ```typescript
   export interface TodoContinuationEnforcerOptions {
     countdownSeconds?: number;  // Default: 2
     skipAgents?: string[];      // Agents to skip (e.g., ['prometheus', 'compaction'])
     checkBackgroundTasks?: boolean;  // Default: true
   }
   ```

3. **Continuation prompt** (use SystemDirectiveTypes.TODO_CONTINUATION):
   ```typescript
   const CONTINUATION_PROMPT = `${createSystemDirective(SystemDirectiveTypes.TODO_CONTINUATION)}

   Incomplete tasks remain in your todo list. Continue working on the next pending task.

   - Proceed without asking for permission
   - Mark each task complete when finished
   - Do not stop until all tasks are done`;
   ```

4. **Event handlers**:
   - `session.idle`: Check for incomplete todos, start countdown
   - `session.error`: Cancel countdown, detect abort errors
   - `message.updated`: Cancel countdown on user/assistant activity
   - `tool.execute.before/after`: Cancel countdown on tool activity
   - `session.deleted`: Cleanup session state

5. **Countdown logic**:
   - getState(sessionID) - Get or create session state
   - cancelCountdown(sessionID) - Clear timers
   - startCountdown(sessionID, incompleteCount) - Begin 2-second countdown
   - injectContinuation(sessionID) - Send continuation prompt

6. **Background task awareness**:
   - Accept optional backgroundTaskChecker function
   - Skip injection if background tasks are running
   - Type: `(sessionId: string) => boolean`

7. **Todo counting**:
   ```typescript
   function getIncompleteCount(todos: Todo[]): number {
     return todos.filter(t =>
       t.status !== "completed" && t.status !== "cancelled"
     ).length;
   }
   ```

8. **Factory function**:
   ```typescript
   export function createTodoContinuationEnforcerHook(
     ctx: HookContext,
     options: TodoContinuationEnforcerOptions = {}
   ): HookHandlers {
     // Implementation
     return {
       event: eventHandler,
     };
   }
   ```

Note: Since we don't have actual Claude Code session API, stub the injection:
- Log the continuation prompt that WOULD be injected
- Emit event to EventSystem for orchestrator to act on
- The actual injection will be wired when integrated with Claude Code plugin API
  </action>
  <verify>npm run build passes; hook can be instantiated</verify>
  <done>Todo continuation enforcer hook implemented with countdown and event handling</done>
</task>

<task type="auto">
  <name>Task 2: Core hooks barrel export</name>
  <files>src/hooks/core/index.ts, src/hooks/index.ts</files>
  <action>
1. **Create src/hooks/core/index.ts**:
   ```typescript
   /**
    * Core Hooks
    *
    * Essential hooks for agent orchestration:
    * - todo-continuation-enforcer: Auto-continue on incomplete tasks
    */
   export * from './todo-continuation-enforcer.js';
   ```

2. **Update src/hooks/index.ts** to include core hooks:
   ```typescript
   // Core hook system (from 18-01)
   export * from './types.js';
   export * from './registry.js';
   export * from './event-bus.js';

   // Core hooks
   export * from './core/index.js';

   // Existing orchestrator hooks
   export * from './orchestrator/index.js';
   ```

Ensure directory structure:
```
src/hooks/
├── types.ts              # From 18-01
├── registry.ts           # From 18-01
├── event-bus.ts          # From 18-01
├── index.ts              # Main exports
├── core/                 # Core hook implementations
│   ├── todo-continuation-enforcer.ts
│   └── index.ts
└── orchestrator/         # Existing (unchanged)
    ├── types.ts
    ├── file-guard.ts
    ├── single-task.ts
    ├── verification.ts
    └── index.ts
```
  </action>
  <verify>npm run build passes; `import { createTodoContinuationEnforcerHook } from './hooks'` works</verify>
  <done>Core hooks directory structure established with proper exports</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes with no errors
2. Hook can be created: `const hook = createTodoContinuationEnforcerHook(ctx)`
3. Hook returns valid HookHandlers with `event` handler
4. Session state is properly managed (Map-based isolation)
</verification>

<success_criteria>
- Session state tracked per-session using Map
- 2-second countdown timer with cancellation
- Continuation prompt follows SystemDirective format
- Background task awareness implemented
- Abort detection prevents unwanted injection
- Session cleanup on session.deleted
</success_criteria>

<output>
After completion, create `.planning/phases/18-hook-system/18-02-SUMMARY.md`
</output>
