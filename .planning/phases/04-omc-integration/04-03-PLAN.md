---
phase: 04-omc-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/orchestration/ultrapilot/types.ts
  - src/orchestration/ultrapilot/ownership.ts
  - src/orchestration/ultrapilot/index.ts
  - src/orchestration/index.ts
autonomous: true

must_haves:
  truths:
    - "File ownership can be assigned to workers"
    - "Shared files (package.json, tsconfig.json) reserved for coordinator"
    - "Conflicts detected when multiple workers claim same file"
    - "Ownership map queryable by worker ID"
  artifacts:
    - path: "src/orchestration/ultrapilot/types.ts"
      provides: "FileOwnership, WorkerInfo, UltrapilotState types"
      exports: ["FileOwnership", "WorkerInfo", "UltrapilotState", "UltrapilotConfig"]
      min_lines: 50
    - path: "src/orchestration/ultrapilot/ownership.ts"
      provides: "File ownership tracking functions"
      exports: ["createOwnership", "assignFile", "releaseFile", "getOwnerOf", "hasConflicts", "DEFAULT_SHARED_FILES"]
      min_lines: 80
  key_links:
    - from: "src/orchestration/ultrapilot/ownership.ts"
      to: "src/orchestration/ultrapilot/types.ts"
      via: "import FileOwnership type"
      pattern: "import.*FileOwnership"
    - from: "src/orchestration/index.ts"
      to: "src/orchestration/ultrapilot/index.ts"
      via: "re-export ultrapilot module"
      pattern: "from.*ultrapilot"
---

<objective>
Implement file ownership tracking for parallel worker coordination.

Purpose: When Ultrapilot spawns multiple workers, each worker must operate on exclusive file sets to prevent merge conflicts. This module tracks file ownership and prevents simultaneous modification.

Output: File ownership module with assignment, release, conflict detection, and query functions.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-omc-integration/04-RESEARCH.md

# Existing state infrastructure
@src/state/types.ts
@src/state/state-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Ultrapilot Types</name>
  <files>src/orchestration/ultrapilot/types.ts</files>
  <action>
Create types.ts with Ultrapilot-related type definitions:

```typescript
/**
 * File ownership tracking for parallel workers
 */
export interface FileOwnership {
  /** Files owned by coordinator (shared files like package.json) */
  coordinator: string[];
  /** Files owned by each worker (keyed by worker ID) */
  workers: Record<string, string[]>;
  /** Files with conflicts (multiple workers attempted modification) */
  conflicts: string[];
}

/**
 * Worker information
 */
export interface WorkerInfo {
  /** Unique worker identifier (UUID) */
  id: string;
  /** Worker status */
  status: 'pending' | 'running' | 'completed' | 'failed';
  /** Assigned subtask description */
  task: string;
  /** Files this worker owns */
  files: string[];
  /** When worker was spawned (ISO 8601) */
  startedAt: string;
  /** When worker completed (ISO 8601) */
  completedAt?: string;
  /** Error message if failed */
  error?: string;
}

/**
 * Configuration for Ultrapilot session
 */
export interface UltrapilotConfig {
  /** Maximum concurrent workers */
  maxWorkers?: number;
  /** Maximum iterations before force completion */
  maxIterations?: number;
  /** Custom shared files (added to defaults) */
  sharedFiles?: string[];
}

/**
 * Complete Ultrapilot session state
 */
export interface UltrapilotState {
  /** Whether ultrapilot is active */
  active: boolean;
  /** Current iteration number */
  iteration: number;
  /** Maximum allowed iterations */
  maxIterations: number;
  /** Original task from user */
  originalTask: string;
  /** Decomposed subtasks */
  subtasks: string[];
  /** Worker information */
  workers: WorkerInfo[];
  /** File ownership tracking */
  ownership: FileOwnership;
  /** When session started (ISO 8601) */
  startedAt: string;
  /** When session completed (ISO 8601) */
  completedAt: string | null;
  /** Total workers spawned across iterations */
  totalWorkersSpawned: number;
  /** Number of successful workers */
  successfulWorkers: number;
  /** Number of failed workers */
  failedWorkers: number;
  /** Optional session ID for resume */
  sessionId?: string;
}

/**
 * Result of file assignment operation
 */
export interface AssignmentResult {
  /** Whether assignment succeeded */
  success: boolean;
  /** Conflict reason if failed */
  conflict?: string;
}
```
  </action>
  <verify>npm run build succeeds, types importable</verify>
  <done>FileOwnership, WorkerInfo, UltrapilotState, UltrapilotConfig types exported</done>
</task>

<task type="auto">
  <name>Task 2: Implement File Ownership Functions</name>
  <files>src/orchestration/ultrapilot/ownership.ts</files>
  <action>
Create ownership.ts with file ownership tracking logic:

1. **DEFAULT_SHARED_FILES**: Array of files only coordinator can modify:
   - 'package.json', 'package-lock.json'
   - 'tsconfig.json', 'tsconfig.*.json'
   - '.gitignore', 'README.md'
   - '.env', '.env.*'

2. **createOwnership(config?: UltrapilotConfig): FileOwnership**
   - Initialize ownership with coordinator owning shared files
   - Merge config.sharedFiles with defaults
   - Return empty workers and conflicts

3. **assignFile(ownership: FileOwnership, workerId: string, filePath: string): AssignmentResult**
   - Check if file owned by another worker -> return conflict
   - Check if file is coordinator-owned (shared) -> return conflict
   - Add file to worker's ownership list
   - Return success

4. **releaseFile(ownership: FileOwnership, workerId: string, filePath: string): boolean**
   - Remove file from worker's list
   - Return true if file was released

5. **getOwnerOf(ownership: FileOwnership, filePath: string): string | null**
   - Check coordinator files first
   - Check all worker files
   - Return 'coordinator', worker ID, or null

6. **hasConflicts(ownership: FileOwnership): boolean**
   - Return ownership.conflicts.length > 0

7. **recordConflict(ownership: FileOwnership, filePath: string): void**
   - Add filePath to conflicts array if not already present
  </action>
  <verify>
```bash
npm run build
# Test ownership functions
node -e "import('./dist/index.js').then(m => {
  const ownership = m.createOwnership();
  console.log('Coordinator owns package.json:', ownership.coordinator.includes('package.json'));

  const result = m.assignFile(ownership, 'worker-1', 'src/index.ts');
  console.log('Assignment success:', result.success);

  const owner = m.getOwnerOf(ownership, 'src/index.ts');
  console.log('Owner of src/index.ts:', owner);

  const conflict = m.assignFile(ownership, 'worker-2', 'src/index.ts');
  console.log('Conflict on reassign:', !conflict.success);
})"
```
  </verify>
  <done>File ownership functions handle assignment, release, and conflict detection</done>
</task>

<task type="auto">
  <name>Task 3: Create Ultrapilot Module Exports</name>
  <files>
    src/orchestration/ultrapilot/index.ts
    src/orchestration/index.ts
  </files>
  <action>
1. Create src/orchestration/ultrapilot/index.ts:
   - Export all types from types.ts
   - Export all functions from ownership.ts
   - Export DEFAULT_SHARED_FILES constant

2. Update src/orchestration/index.ts:
   - Add: export * from './ultrapilot/index.js'
   - Keep existing keywords export

3. Update src/index.ts (main entry):
   - Add: export * from './orchestration/index.js'
   - Keep existing exports
  </action>
  <verify>npm run build succeeds, all exports accessible from src/index.ts</verify>
  <done>Ultrapilot types and ownership functions accessible via main module</done>
</task>

</tasks>

<verification>
```bash
# Build verification
npm run build

# Type exports
node -e "import('./dist/index.js').then(m => {
  console.log('Has createOwnership:', typeof m.createOwnership === 'function');
  console.log('Has assignFile:', typeof m.assignFile === 'function');
  console.log('Has getOwnerOf:', typeof m.getOwnerOf === 'function');
  console.log('Has DEFAULT_SHARED_FILES:', Array.isArray(m.DEFAULT_SHARED_FILES));
})"

# Full workflow test
node -e "import('./dist/index.js').then(m => {
  const ownership = m.createOwnership();

  // Worker 1 claims src/a.ts
  m.assignFile(ownership, 'w1', 'src/a.ts');
  // Worker 2 claims src/b.ts
  m.assignFile(ownership, 'w2', 'src/b.ts');
  // Worker 2 tries to claim src/a.ts (should conflict)
  const result = m.assignFile(ownership, 'w2', 'src/a.ts');

  console.log('Conflict detected:', !result.success);
  console.log('Conflict reason:', result.conflict);

  // Check coordinator protection
  const pkgResult = m.assignFile(ownership, 'w1', 'package.json');
  console.log('Package.json protected:', !pkgResult.success);
})"
```
</verification>

<success_criteria>
- [ ] npm run build succeeds with no TypeScript errors
- [ ] createOwnership() returns FileOwnership with coordinator owning shared files
- [ ] assignFile() returns conflict when file already owned by another worker
- [ ] assignFile() returns conflict when file is coordinator-owned
- [ ] getOwnerOf() returns correct owner or null
- [ ] All exports accessible from src/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-omc-integration/04-03-SUMMARY.md`
</output>
