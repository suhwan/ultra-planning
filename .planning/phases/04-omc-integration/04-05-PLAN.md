---
phase: 04-omc-integration
plan: 05
type: execute
wave: 2
depends_on: ["04-03"]
files_modified:
  - src/orchestration/ultrapilot/state.ts
  - src/orchestration/ultrapilot/coordinator.ts
  - src/orchestration/ultrapilot/index.ts
autonomous: true

must_haves:
  truths:
    - "Ultrapilot session can be initialized with subtasks"
    - "Workers can be spawned and tracked by ID"
    - "Worker status updates (running, completed, failed) persisted"
    - "Session supports up to 5 concurrent workers"
  artifacts:
    - path: "src/orchestration/ultrapilot/state.ts"
      provides: "Ultrapilot state persistence"
      exports: ["initUltrapilot", "getUltrapilotState", "updateWorker", "endUltrapilot"]
      min_lines: 80
    - path: "src/orchestration/ultrapilot/coordinator.ts"
      provides: "Worker coordination logic"
      exports: ["spawnWorker", "completeWorker", "failWorker", "getActiveWorkers", "canSpawnMore"]
      min_lines: 70
  key_links:
    - from: "src/orchestration/ultrapilot/state.ts"
      to: "src/state/state-manager.ts"
      via: "import StateManager"
      pattern: "import.*StateManager"
    - from: "src/orchestration/ultrapilot/coordinator.ts"
      to: "src/orchestration/ultrapilot/ownership.ts"
      via: "import assignFile for file ownership"
      pattern: "import.*assignFile"
---

<objective>
Implement Ultrapilot worker coordination for parallel task execution.

Purpose: Ultrapilot spawns up to 5 workers in parallel, each working on exclusive file sets. This module manages worker lifecycle (spawn, track, complete/fail) and integrates with file ownership tracking.

Output: Ultrapilot state management and worker coordination module with spawn/complete/fail operations.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-omc-integration/04-RESEARCH.md
@.planning/phases/04-omc-integration/04-03-SUMMARY.md

# File ownership (from 04-03)
@src/orchestration/ultrapilot/types.ts
@src/orchestration/ultrapilot/ownership.ts

# Existing state infrastructure
@src/state/state-manager.ts
@src/state/mode-registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Ultrapilot State Persistence</name>
  <files>src/orchestration/ultrapilot/state.ts</files>
  <action>
Create state.ts with Ultrapilot state management:

1. **STATE_FILE_NAME**: 'ultrapilot-state' (writes to .ultraplan/state/ultrapilot-state.json)
2. **DEFAULT_MAX_WORKERS**: 5

3. **initUltrapilot(originalTask: string, subtasks: string[], config?: UltrapilotConfig): UltrapilotState | null**
   - Check mode registry (canStartMode) - prevent if other exclusive mode active
   - Create initial state:
     - active: true
     - iteration: 1
     - maxIterations: config?.maxIterations ?? 3
     - originalTask, subtasks
     - workers: []
     - ownership: createOwnership(config)
     - startedAt: now
     - completedAt: null
     - totalWorkersSpawned: 0, successfulWorkers: 0, failedWorkers: 0
   - Write state file
   - Return state or null if blocked

4. **getUltrapilotState(): UltrapilotState | null**
   - Read state file
   - Return null if not exists or not active

5. **updateUltrapilotState(updates: Partial<UltrapilotState>): boolean**
   - Read current state
   - Merge updates
   - Write state file
   - Return success

6. **updateWorker(workerId: string, updates: Partial<WorkerInfo>): boolean**
   - Read current state
   - Find worker by ID
   - Merge updates into worker
   - Write state file
   - Return success (false if worker not found)

7. **endUltrapilot(): boolean**
   - Delete state file
   - Return success
  </action>
  <verify>
```bash
npm run build
# Test state management
node -e "import('./dist/index.js').then(m => {
  // Initialize
  const state = m.initUltrapilot('Build API', ['Create models', 'Create routes', 'Add tests']);
  console.log('Init success:', state !== null);
  console.log('Subtasks count:', state?.subtasks.length);
  console.log('Max workers:', state?.ownership.coordinator.length > 0);

  // Clean up
  m.endUltrapilot();
})"
```
  </verify>
  <done>Ultrapilot state can be initialized, updated, and persisted</done>
</task>

<task type="auto">
  <name>Task 2: Implement Worker Coordination</name>
  <files>src/orchestration/ultrapilot/coordinator.ts</files>
  <action>
Create coordinator.ts with worker lifecycle management:

1. **DEFAULT_MAX_CONCURRENT**: 5

2. **canSpawnMore(state: UltrapilotState, maxConcurrent?: number): boolean**
   - Count workers with status='running'
   - Return count < (maxConcurrent ?? DEFAULT_MAX_CONCURRENT)

3. **getActiveWorkers(state: UltrapilotState): WorkerInfo[]**
   - Filter workers where status='running'
   - Return array

4. **spawnWorker(task: string, files: string[]): WorkerInfo | null**
   - Get current state
   - Check canSpawnMore - return null if at limit
   - Generate worker ID (uuid v4)
   - Validate file ownership for each file:
     - Call assignFile for each file in files array
     - If any conflict, return null
   - Create WorkerInfo:
     - id: generated UUID
     - status: 'running'
     - task: task
     - files: files
     - startedAt: now
   - Add to state.workers
   - Increment totalWorkersSpawned
   - Update state file
   - Return WorkerInfo

5. **completeWorker(workerId: string): boolean**
   - Call updateWorker with status='completed', completedAt=now
   - Increment successfulWorkers in state
   - Return success

6. **failWorker(workerId: string, error: string): boolean**
   - Call updateWorker with status='failed', completedAt=now, error
   - Increment failedWorkers in state
   - Return success

7. **releaseWorkerFiles(workerId: string): boolean**
   - Get worker from state
   - Call releaseFile for each file in worker.files
   - Return success
  </action>
  <verify>
```bash
npm run build
# Test worker coordination
node -e "import('./dist/index.js').then(m => {
  // Initialize
  m.initUltrapilot('Build API', ['Task 1', 'Task 2']);

  // Spawn worker
  const worker = m.spawnWorker('Create models', ['src/models/user.ts']);
  console.log('Worker spawned:', worker !== null);
  console.log('Worker ID:', worker?.id);
  console.log('Worker status:', worker?.status);

  // Check active workers
  const state = m.getUltrapilotState();
  const active = m.getActiveWorkers(state);
  console.log('Active workers:', active.length);

  // Complete worker
  const completed = m.completeWorker(worker.id);
  console.log('Complete success:', completed);

  // Clean up
  m.endUltrapilot();
})"
```
  </verify>
  <done>Worker spawn, complete, and fail operations work correctly</done>
</task>

<task type="auto">
  <name>Task 3: Update Ultrapilot Module Exports</name>
  <files>src/orchestration/ultrapilot/index.ts</files>
  <action>
Update ultrapilot/index.ts to export all new functions:

1. Export all types from types.ts (already done in 04-03)
2. Export all functions from ownership.ts (already done in 04-03)
3. Add exports from state.ts:
   - initUltrapilot, getUltrapilotState, updateUltrapilotState, updateWorker, endUltrapilot
4. Add exports from coordinator.ts:
   - canSpawnMore, getActiveWorkers, spawnWorker, completeWorker, failWorker, releaseWorkerFiles
5. Export DEFAULT_MAX_CONCURRENT constant

Ensure all exports are accessible from src/index.ts.
  </action>
  <verify>npm run build succeeds, all exports accessible from src/index.ts</verify>
  <done>All Ultrapilot functions accessible via main module exports</done>
</task>

</tasks>

<verification>
```bash
# Build verification
npm run build

# Export verification
node -e "import('./dist/index.js').then(m => {
  console.log('Has initUltrapilot:', typeof m.initUltrapilot === 'function');
  console.log('Has spawnWorker:', typeof m.spawnWorker === 'function');
  console.log('Has completeWorker:', typeof m.completeWorker === 'function');
  console.log('Has failWorker:', typeof m.failWorker === 'function');
  console.log('Has canSpawnMore:', typeof m.canSpawnMore === 'function');
  console.log('Has getActiveWorkers:', typeof m.getActiveWorkers === 'function');
})"

# Full workflow test
node -e "import('./dist/index.js').then(m => {
  // Initialize ultrapilot session
  const state = m.initUltrapilot('Build REST API', [
    'Create User model',
    'Create Product model',
    'Create API routes',
    'Add tests'
  ]);
  console.log('Session active:', state.active);

  // Spawn workers for independent tasks
  const worker1 = m.spawnWorker('Create User model', ['src/models/user.ts']);
  const worker2 = m.spawnWorker('Create Product model', ['src/models/product.ts']);
  console.log('Worker 1 spawned:', worker1 !== null);
  console.log('Worker 2 spawned:', worker2 !== null);

  // Try to spawn conflicting worker (should fail)
  const conflictWorker = m.spawnWorker('Modify User', ['src/models/user.ts']);
  console.log('Conflict prevented:', conflictWorker === null);

  // Check concurrent workers
  const updated = m.getUltrapilotState();
  console.log('Active workers:', m.getActiveWorkers(updated).length);
  console.log('Can spawn more:', m.canSpawnMore(updated));

  // Complete a worker
  m.completeWorker(worker1.id);
  const afterComplete = m.getUltrapilotState();
  console.log('Successful workers:', afterComplete.successfulWorkers);

  // Fail a worker
  m.failWorker(worker2.id, 'Test error');
  const afterFail = m.getUltrapilotState();
  console.log('Failed workers:', afterFail.failedWorkers);

  // Clean up
  m.endUltrapilot();
  console.log('Session ended');
})"
```
</verification>

<success_criteria>
- [ ] npm run build succeeds with no TypeScript errors
- [ ] initUltrapilot() creates session with correct initial state
- [ ] spawnWorker() creates worker with unique ID and assigns file ownership
- [ ] spawnWorker() returns null when file ownership conflicts
- [ ] canSpawnMore() returns false when 5 workers are active
- [ ] completeWorker() updates status and increments successfulWorkers
- [ ] failWorker() updates status, error, and increments failedWorkers
- [ ] All exports accessible from src/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-omc-integration/04-05-SUMMARY.md`
</output>
