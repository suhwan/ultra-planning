---
phase: 04-omc-integration
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/orchestration/ralplan/types.ts
  - src/orchestration/ralplan/state.ts
  - src/orchestration/ralplan/orchestrator.ts
  - src/orchestration/ralplan/index.ts
  - src/orchestration/index.ts
autonomous: true

must_haves:
  truths:
    - "Ralplan state can be initialized with task description"
    - "Ralplan loop tracks iteration count with max_iterations=5"
    - "Current phase transitions: planner_planning -> critic_review -> handling_verdict"
    - "Forced approval occurs after max iterations with warning"
  artifacts:
    - path: "src/orchestration/ralplan/types.ts"
      provides: "RalplanState, RalplanPhase types"
      exports: ["RalplanState", "RalplanPhase", "RalplanConfig", "CriticVerdict"]
      min_lines: 40
    - path: "src/orchestration/ralplan/state.ts"
      provides: "State management for ralplan sessions"
      exports: ["initRalplan", "updateRalplanPhase", "advanceIteration", "getRalplanState", "endRalplan"]
      min_lines: 70
    - path: "src/orchestration/ralplan/orchestrator.ts"
      provides: "Loop orchestration logic"
      exports: ["handleCriticVerdict", "shouldForceApproval", "getNextPhase"]
      min_lines: 60
  key_links:
    - from: "src/orchestration/ralplan/state.ts"
      to: "src/state/state-manager.ts"
      via: "import StateManager"
      pattern: "import.*StateManager"
    - from: "src/orchestration/ralplan/orchestrator.ts"
      to: "src/orchestration/ralplan/types.ts"
      via: "import RalplanState, CriticVerdict"
      pattern: "import.*RalplanState"
---

<objective>
Implement the Ralplan verification loop for iterative plan refinement.

Purpose: Ralplan enables Planner+Architect+Critic iteration until consensus. The Critic reviews plans with OKAY/REJECT verdict, and rejected plans are refined up to max_iterations (5), after which forced approval occurs with warning.

Output: Ralplan state management and loop orchestration module that tracks phases, iterations, and verdicts.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-omc-integration/04-RESEARCH.md
@.planning/phases/04-omc-integration/04-01-SUMMARY.md

# Existing state infrastructure
@src/state/state-manager.ts
@src/state/types.ts
@src/state/mode-registry.ts

# Agent prompts (from 04-01)
@src/agents/prompts/architect.ts
@src/agents/prompts/critic.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Ralplan Types</name>
  <files>src/orchestration/ralplan/types.ts</files>
  <action>
Create types.ts with Ralplan-related type definitions:

```typescript
/**
 * Ralplan execution phases
 */
export type RalplanPhase =
  | 'planner_planning'      // Planner creating/refining plan
  | 'architect_consultation' // Optional Architect input
  | 'critic_review'         // Critic reviewing plan
  | 'handling_verdict'      // Processing OKAY/REJECT
  | 'complete';             // Loop finished

/**
 * Critic verdict type
 */
export type CriticVerdict = 'OKAY' | 'REJECT';

/**
 * Critic review result
 */
export interface CriticReviewResult {
  verdict: CriticVerdict;
  justification: string;
  improvements?: string[];
}

/**
 * Configuration for Ralplan session
 */
export interface RalplanConfig {
  /** Maximum iterations before forced approval (default: 5) */
  maxIterations?: number;
  /** Path to store the plan file */
  planPath?: string;
  /** Whether to consult Architect on rejection */
  consultArchitectOnReject?: boolean;
}

/**
 * Complete Ralplan session state
 */
export interface RalplanState {
  /** Whether ralplan is active */
  active: boolean;
  /** Mode identifier */
  mode: 'ralplan';
  /** Current iteration number (1-indexed) */
  iteration: number;
  /** Maximum allowed iterations */
  maxIterations: number;
  /** Path to the plan being reviewed */
  planPath: string;
  /** Current phase in the loop */
  currentPhase: RalplanPhase;
  /** When session started (ISO 8601) */
  startedAt: string;
  /** Original task description */
  taskDescription: string;
  /** Last critic verdict (if any) */
  lastVerdict?: CriticVerdict;
  /** Last critic feedback (if rejected) */
  lastFeedback?: string;
  /** Whether approval was forced (max iterations reached) */
  forcedApproval?: boolean;
  /** When session completed (ISO 8601) */
  completedAt?: string;
}

/**
 * Default configuration values
 */
export const DEFAULT_RALPLAN_CONFIG: Required<RalplanConfig> = {
  maxIterations: 5,
  planPath: '.ultraplan/plans/current.md',
  consultArchitectOnReject: true,
};
```
  </action>
  <verify>npm run build succeeds, types importable</verify>
  <done>RalplanState, RalplanPhase, CriticVerdict types exported</done>
</task>

<task type="auto">
  <name>Task 2: Implement Ralplan State Management</name>
  <files>src/orchestration/ralplan/state.ts</files>
  <action>
Create state.ts with Ralplan state persistence:

1. **STATE_FILE_NAME**: 'ralplan-state' (writes to .ultraplan/state/ralplan-state.json)

2. **initRalplan(taskDescription: string, config?: RalplanConfig): RalplanState | null**
   - Check mode registry (canStartMode) - prevent if other exclusive mode active
   - Create initial state with iteration=1, currentPhase='planner_planning'
   - Write state file using StateManager
   - Return state or null if blocked

3. **getRalplanState(): RalplanState | null**
   - Read state file
   - Return null if not exists or not active

4. **updateRalplanPhase(phase: RalplanPhase): boolean**
   - Read current state
   - Update currentPhase
   - Write state file
   - Return success

5. **advanceIteration(verdict: CriticVerdict, feedback?: string): boolean**
   - Read current state
   - If verdict is OKAY: set currentPhase='complete', completedAt=now
   - If verdict is REJECT: increment iteration, set currentPhase='planner_planning'
   - Store lastVerdict and lastFeedback
   - Write state file
   - Return success

6. **endRalplan(): boolean**
   - Delete state file
   - Return success
  </action>
  <verify>
```bash
npm run build
# Test state management
node -e "import('./dist/index.js').then(m => {
  // Initialize
  const state = m.initRalplan('Build a REST API');
  console.log('Init success:', state !== null);
  console.log('Initial phase:', state?.currentPhase);
  console.log('Initial iteration:', state?.iteration);

  // Advance to critic_review
  m.updateRalplanPhase('critic_review');
  const updated = m.getRalplanState();
  console.log('Updated phase:', updated?.currentPhase);

  // Clean up
  m.endRalplan();
})"
```
  </verify>
  <done>Ralplan state can be initialized, updated, and persisted</done>
</task>

<task type="auto">
  <name>Task 3: Implement Loop Orchestration Logic</name>
  <files>
    src/orchestration/ralplan/orchestrator.ts
    src/orchestration/ralplan/index.ts
    src/orchestration/index.ts
  </files>
  <action>
Create orchestrator.ts with loop control logic:

1. **shouldForceApproval(state: RalplanState): boolean**
   - Return state.iteration >= state.maxIterations

2. **getNextPhase(currentPhase: RalplanPhase, verdict?: CriticVerdict): RalplanPhase**
   - planner_planning -> critic_review
   - critic_review -> handling_verdict
   - handling_verdict + OKAY -> complete
   - handling_verdict + REJECT -> planner_planning (or architect_consultation if configured)
   - complete -> complete (terminal)

3. **handleCriticVerdict(verdict: CriticVerdict, feedback?: string): { nextPhase: RalplanPhase; forced: boolean; message: string }**
   - Get current state
   - If shouldForceApproval: set forced=true, return complete with warning message
   - If OKAY: return complete with success message
   - If REJECT: advance iteration, return planner_planning with feedback message

4. **getLoopSummary(state: RalplanState): string**
   - Return human-readable summary: "Ralplan iteration 2/5 - critic_review"

Then create index files:
- src/orchestration/ralplan/index.ts: Export all from types.ts, state.ts, orchestrator.ts
- Update src/orchestration/index.ts: Add export * from './ralplan/index.js'
  </action>
  <verify>
```bash
npm run build
# Test orchestration
node -e "import('./dist/index.js').then(async m => {
  // Initialize
  const state = m.initRalplan('Build API', { maxIterations: 3 });

  // Simulate loop
  console.log('Phase 1:', m.getNextPhase('planner_planning'));
  console.log('Phase after critic:', m.getNextPhase('critic_review'));

  // Test force approval
  const fakeState = { ...state, iteration: 3, maxIterations: 3 };
  console.log('Should force:', m.shouldForceApproval(fakeState));

  // Clean up
  m.endRalplan();
})"
```
  </verify>
  <done>Ralplan loop orchestration handles phase transitions and forced approval</done>
</task>

</tasks>

<verification>
```bash
# Build verification
npm run build

# Full workflow test
node -e "import('./dist/index.js').then(m => {
  // Initialize ralplan
  const state = m.initRalplan('Create authentication system');
  console.log('Ralplan active:', state.active);
  console.log('Max iterations:', state.maxIterations);

  // Simulate critic rejection
  m.updateRalplanPhase('critic_review');
  const result = m.handleCriticVerdict('REJECT', 'Missing error handling');
  console.log('After rejection - phase:', result.nextPhase);
  console.log('After rejection - forced:', result.forced);

  // Get updated state
  const updated = m.getRalplanState();
  console.log('New iteration:', updated.iteration);
  console.log('Last verdict:', updated.lastVerdict);

  // Test forced approval (simulate max iterations)
  // Would need to call advanceIteration multiple times

  // Clean up
  m.endRalplan();
  console.log('Cleanup complete');
})"

# Export verification
node -e "import('./dist/index.js').then(m => {
  console.log('Has initRalplan:', typeof m.initRalplan === 'function');
  console.log('Has handleCriticVerdict:', typeof m.handleCriticVerdict === 'function');
  console.log('Has shouldForceApproval:', typeof m.shouldForceApproval === 'function');
  console.log('Has DEFAULT_RALPLAN_CONFIG:', m.DEFAULT_RALPLAN_CONFIG !== undefined);
})"
```
</verification>

<success_criteria>
- [ ] npm run build succeeds with no TypeScript errors
- [ ] initRalplan() creates state with iteration=1, currentPhase='planner_planning'
- [ ] advanceIteration('REJECT') increments iteration and returns to planner_planning
- [ ] advanceIteration('OKAY') sets currentPhase='complete'
- [ ] shouldForceApproval returns true when iteration >= maxIterations
- [ ] handleCriticVerdict returns forced=true with warning when max iterations reached
- [ ] All exports accessible from src/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-omc-integration/04-04-SUMMARY.md`
</output>
