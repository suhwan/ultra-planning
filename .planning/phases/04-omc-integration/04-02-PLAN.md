---
phase: 04-omc-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/orchestration/keywords/types.ts
  - src/orchestration/keywords/patterns.ts
  - src/orchestration/keywords/processor.ts
  - src/orchestration/keywords/index.ts
  - src/orchestration/index.ts
autonomous: true

must_haves:
  truths:
    - "Magic keywords detected in plain text prompts"
    - "Keywords in code blocks are NOT detected (false positive prevention)"
    - "Detected keywords return enhanced prompt strings"
    - "'autopilot', 'plan', 'ultrawork' keywords are recognized"
  artifacts:
    - path: "src/orchestration/keywords/types.ts"
      provides: "MagicKeyword interface and related types"
      exports: ["MagicKeyword", "KeywordConfig", "KeywordDetectionResult"]
      min_lines: 25
    - path: "src/orchestration/keywords/patterns.ts"
      provides: "Built-in keyword definitions"
      exports: ["BUILTIN_KEYWORDS", "AUTOPILOT_KEYWORD", "PLAN_KEYWORD", "ULTRAWORK_KEYWORD"]
      min_lines: 60
    - path: "src/orchestration/keywords/processor.ts"
      provides: "Keyword detection and processing functions"
      exports: ["createKeywordProcessor", "detectKeywords", "removeCodeBlocks"]
      min_lines: 50
  key_links:
    - from: "src/orchestration/keywords/processor.ts"
      to: "src/orchestration/keywords/patterns.ts"
      via: "import BUILTIN_KEYWORDS"
      pattern: "import.*BUILTIN_KEYWORDS"
    - from: "src/orchestration/keywords/processor.ts"
      to: "src/orchestration/keywords/types.ts"
      via: "import MagicKeyword type"
      pattern: "import.*MagicKeyword"
---

<objective>
Implement magic keyword detection system for automatic mode activation.

Purpose: Enable natural language triggers like "autopilot build me a todo app" to automatically activate the appropriate execution mode without requiring explicit commands.

Output: Keyword detection module that strips code blocks before matching, returns detected keywords, and can enhance prompts with mode-specific instructions.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-omc-integration/04-RESEARCH.md

# Reference implementation to adapt
@references/oh-my-claudecode/src/features/magic-keywords.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Keyword Types</name>
  <files>src/orchestration/keywords/types.ts</files>
  <action>
Create types.ts with keyword-related type definitions:

```typescript
/**
 * Magic keyword configuration
 */
export interface MagicKeyword {
  /** Trigger words that activate this keyword */
  triggers: string[];
  /** Human-readable description */
  description: string;
  /** Action to perform when keyword detected - returns enhanced prompt */
  action: (prompt: string) => string;
}

/**
 * Configuration for keyword processor
 */
export interface KeywordConfig {
  /** Custom keyword overrides (trigger -> new triggers) */
  overrides?: Record<string, string[]>;
  /** Additional custom keywords */
  custom?: MagicKeyword[];
}

/**
 * Result of keyword detection
 */
export interface KeywordDetectionResult {
  /** Keywords that were detected */
  detected: string[];
  /** Original prompt text */
  originalPrompt: string;
  /** Prompt with code blocks removed (used for detection) */
  cleanedPrompt: string;
  /** Whether any keywords were found */
  hasKeywords: boolean;
}
```
  </action>
  <verify>npm run build succeeds, types importable</verify>
  <done>MagicKeyword, KeywordConfig, KeywordDetectionResult types exported</done>
</task>

<task type="auto">
  <name>Task 2: Create Built-in Keyword Patterns</name>
  <files>src/orchestration/keywords/patterns.ts</files>
  <action>
Create patterns.ts with built-in keyword definitions:

1. **AUTOPILOT_KEYWORD**:
   - triggers: ['autopilot', 'build me', 'create me', 'make me']
   - description: 'Full autonomous execution from idea to working code'
   - action: Prepend "[AUTOPILOT MODE] Full autonomous execution..."

2. **PLAN_KEYWORD**:
   - triggers: ['plan', 'plan this', 'plan the']
   - description: 'Planning session with interview workflow'
   - action: Prepend "[PLANNING MODE] Start planning interview..."

3. **ULTRAWORK_KEYWORD**:
   - triggers: ['ultrawork', 'ulw', 'uw']
   - description: 'Maximum parallel execution mode'
   - action: Prepend "[ULTRAWORK MODE] Maximum precision..."

4. **RALPLAN_KEYWORD**:
   - triggers: ['ralplan', 'iterative plan']
   - description: 'Iterative planning with Planner+Architect+Critic'
   - action: Prepend "[RALPLAN MODE] Iterative verification loop..."

5. **BUILTIN_KEYWORDS**: Array of all built-in keywords

Note: Keep action content concise (2-3 sentences). Full mode instructions live in agent prompts.
  </action>
  <verify>npm run build succeeds, BUILTIN_KEYWORDS exports 4+ keywords</verify>
  <done>Built-in keywords defined with triggers and actions</done>
</task>

<task type="auto">
  <name>Task 3: Create Keyword Processor</name>
  <files>
    src/orchestration/keywords/processor.ts
    src/orchestration/keywords/index.ts
    src/orchestration/index.ts
  </files>
  <action>
Create processor.ts with detection and processing logic:

1. **CODE_BLOCK_PATTERN**: /```[\s\S]*?```/g
2. **INLINE_CODE_PATTERN**: /`[^`]+`/g

3. **removeCodeBlocks(text: string): string**
   - Remove fenced code blocks and inline code
   - Return cleaned text for keyword matching

4. **detectKeywords(prompt: string, config?: KeywordConfig): KeywordDetectionResult**
   - Clean prompt with removeCodeBlocks
   - Match triggers against cleaned text using word boundaries (\b)
   - Return detected keywords and metadata

5. **createKeywordProcessor(config?: KeywordConfig): (prompt: string) => string**
   - Factory that returns processor function
   - Applies keyword overrides from config
   - Adds custom keywords from config
   - Returns function that detects and enhances prompts

Then create index.ts files:
- src/orchestration/keywords/index.ts: Export all from types, patterns, processor
- src/orchestration/index.ts: Create with export * from './keywords/index.js'
  </action>
  <verify>
```bash
npm run build
# Test detection
node -e "import('./dist/index.js').then(m => {
  const result = m.detectKeywords('autopilot build me a todo app');
  console.log('Detected:', result.detected);
  console.log('Has keywords:', result.hasKeywords);
})"
# Test code block stripping
node -e "import('./dist/index.js').then(m => {
  const result = m.detectKeywords('here is code: \`\`\`js\nautopilot\n\`\`\` but also autopilot');
  console.log('Detected (should find autopilot):', result.detected);
})"
```
  </verify>
  <done>Keyword processor detects triggers while ignoring code blocks</done>
</task>

</tasks>

<verification>
```bash
# Build verification
npm run build

# Type exports
node -e "import('./dist/index.js').then(m => {
  console.log('BUILTIN_KEYWORDS count:', m.BUILTIN_KEYWORDS.length);
  console.log('Has detectKeywords:', typeof m.detectKeywords === 'function');
  console.log('Has createKeywordProcessor:', typeof m.createKeywordProcessor === 'function');
  console.log('Has removeCodeBlocks:', typeof m.removeCodeBlocks === 'function');
})"

# Detection test with code block
node -e "import('./dist/index.js').then(m => {
  const withCode = 'fix this: \`\`\`\nautopilot mode\n\`\`\` and also autopilot my project';
  const result = m.detectKeywords(withCode);
  console.log('Code block test - detected:', result.detected);
  console.log('Should have autopilot:', result.detected.includes('autopilot'));
})"

# Processor enhancement test
node -e "import('./dist/index.js').then(m => {
  const processor = m.createKeywordProcessor();
  const enhanced = processor('autopilot build a REST API');
  console.log('Enhanced starts with mode:', enhanced.includes('[AUTOPILOT MODE]'));
})"
```
</verification>

<success_criteria>
- [ ] npm run build succeeds with no TypeScript errors
- [ ] detectKeywords('autopilot build me') returns { detected: ['autopilot'], hasKeywords: true }
- [ ] detectKeywords('```js\nautopilot\n```') returns { detected: [], hasKeywords: false }
- [ ] createKeywordProcessor() returns function that enhances prompts
- [ ] All exports accessible from src/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-omc-integration/04-02-SUMMARY.md`
</output>
