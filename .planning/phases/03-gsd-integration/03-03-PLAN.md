---
phase: 03-gsd-integration
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/documents/xml/task-generator.ts
  - src/documents/xml/task-parser.ts
  - src/documents/xml/types.ts
  - src/documents/xml/index.ts
  - src/documents/index.ts
autonomous: true

must_haves:
  truths:
    - "Task XML can be generated from Task type input"
    - "Task XML can be parsed back to Task type"
    - "Special characters in task content are properly escaped"
    - "All task types supported (auto, checkpoint:*)"
  artifacts:
    - path: "src/documents/xml/types.ts"
      provides: "Task and checkpoint type definitions"
      exports: ["Task", "TaskType", "CheckpointTask", "AutoTask"]
      min_lines: 40
    - path: "src/documents/xml/task-generator.ts"
      provides: "Task XML generation"
      exports: ["generateTaskXml", "generateTasksSection"]
      min_lines: 60
    - path: "src/documents/xml/task-parser.ts"
      provides: "Task XML parsing"
      exports: ["parseTaskXml", "parseTasksSection"]
      min_lines: 80
    - path: "src/documents/xml/index.ts"
      provides: "XML module exports"
      min_lines: 10
  key_links:
    - from: "src/documents/xml/task-generator.ts"
      to: "src/documents/xml/types.ts"
      via: "import Task type"
      pattern: "import.*Task.*types"
    - from: "src/documents/xml/task-parser.ts"
      to: "src/documents/xml/types.ts"
      via: "import Task type for return"
      pattern: "import.*Task.*types"
---

<objective>
Implement XML task format utilities for PLAN.md task sections.

Purpose: Enable structured task generation and parsing within PLAN.md documents, supporting all task types (auto, checkpoints) with proper escaping.
Output: Bidirectional XML utilities that can generate and parse task sections reliably.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Types from Plan 03-01
@src/documents/types.ts

# Reference task format
@references/get-shit-done/get-shit-done/templates/phase-prompt.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task XML types</name>
  <files>src/documents/xml/types.ts</files>
  <action>
Create src/documents/xml/types.ts with comprehensive task types:

```typescript
/** Task type identifiers */
export type TaskType =
  | 'auto'
  | 'checkpoint:human-verify'
  | 'checkpoint:decision'
  | 'checkpoint:human-action';

/** Base task fields */
interface BaseTask {
  type: TaskType;
  name: string;
}

/** Autonomous task (Claude executes independently) */
export interface AutoTask extends BaseTask {
  type: 'auto';
  files: string[];
  action: string;
  verify: string;
  done: string;
}

/** Human verification checkpoint */
export interface HumanVerifyTask extends BaseTask {
  type: 'checkpoint:human-verify';
  gate: 'blocking';
  whatBuilt: string;
  howToVerify: string;
  resumeSignal: string;
}

/** Decision checkpoint */
export interface DecisionTask extends BaseTask {
  type: 'checkpoint:decision';
  gate: 'blocking';
  decision: string;
  context: string;
  options: DecisionOption[];
  resumeSignal: string;
}

export interface DecisionOption {
  id: string;
  name: string;
  pros: string;
  cons: string;
}

/** Human action checkpoint (rare) */
export interface HumanActionTask extends BaseTask {
  type: 'checkpoint:human-action';
  gate: 'blocking';
  action: string;
  instructions: string;
  resumeSignal: string;
}

/** Union type for all tasks */
export type Task = AutoTask | HumanVerifyTask | DecisionTask | HumanActionTask;

/** Type guard functions */
export function isAutoTask(task: Task): task is AutoTask;
export function isCheckpointTask(task: Task): task is Exclude<Task, AutoTask>;
```
  </action>
  <verify>npx tsc --noEmit src/documents/xml/types.ts</verify>
  <done>Task types cover all GSD task variations, type guards work</done>
</task>

<task type="auto">
  <name>Task 2: Implement XML generation and parsing</name>
  <files>src/documents/xml/task-generator.ts, src/documents/xml/task-parser.ts</files>
  <action>
Create src/documents/xml/task-generator.ts:
- escapeXml(str: string): string - escape &lt; &gt; &amp; &quot; in user content
- generateAutoTaskXml(task: AutoTask): string - template with proper indentation
- generateCheckpointTaskXml(task: CheckpointTask): string - handles all checkpoint variants
- generateTaskXml(task: Task): string - dispatcher based on task.type
- generateTasksSection(tasks: Task[]): string - wraps in &lt;tasks&gt; element

Create src/documents/xml/task-parser.ts:
- unescapeXml(str: string): string - reverse of escapeXml
- parseAutoTask(xml: string): AutoTask - regex-based extraction
- parseCheckpointTask(xml: string): CheckpointTask - handles variants
- parseTaskXml(xml: string): Task - dispatcher based on type attribute
- parseTasksSection(xml: string): Task[] - extracts all &lt;task&gt; elements

Use regex patterns (not DOM parser) - the XML is custom format, not valid HTML/XML.
Pattern for task extraction: /&lt;task\s+type="([^"]+)"[^&gt;]*&gt;([\s\S]*?)&lt;\/task&gt;/g

Handle edge cases:
- Multi-line content in action/verify/done
- Nested XML-like content in code examples (escape properly)
- Empty optional fields (files may be empty for checkpoints)
  </action>
  <verify>npx tsc --noEmit src/documents/xml/*.ts</verify>
  <done>Generator and parser compile, handle all task types, escape/unescape work</done>
</task>

<task type="auto">
  <name>Task 3: Create XML module index and integrate</name>
  <files>src/documents/xml/index.ts, src/documents/index.ts</files>
  <action>
Create src/documents/xml/index.ts:
- Re-export all types from ./types.js
- Re-export generateTaskXml, generateTasksSection from ./task-generator.js
- Re-export parseTaskXml, parseTasksSection from ./task-parser.js

Update src/documents/index.ts:
- Add: export * from './xml/index.js';

Ensure all exports use .js extension for ESM compatibility.
  </action>
  <verify>npx tsc --noEmit && node --loader ts-node/esm -e "import { generateTaskXml, parseTaskXml } from './src/documents/index.js'"</verify>
  <done>XML utilities accessible from documents module, round-trip works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] generateTaskXml() produces valid XML structure
- [ ] parseTaskXml() extracts task data correctly
- [ ] Round-trip: parse(generate(task)) === task for all types
- [ ] Special characters escaped/unescaped correctly
</verification>

<success_criteria>
- All tasks completed
- All task types (auto, checkpoint variants) supported
- XML escaping prevents parsing errors
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-gsd-integration/03-03-SUMMARY.md`
</output>
