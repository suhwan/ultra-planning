---
phase: 08-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/workflow.test.ts
  - tests/helpers/temp-dir.ts
  - tests/helpers/mock-state.ts
  - vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "E2E workflow tests run and pass via `npm test`"
    - "Tests create isolated temp directories that don't interfere with each other"
    - "Tests verify PROJECT.md, ROADMAP.md, PLAN.md generation"
    - "Tests verify state persistence and reading"
    - "Tests verify Task API sync (task mapping and status updates)"
  artifacts:
    - path: "tests/integration/workflow.test.ts"
      provides: "E2E workflow test suite"
      min_lines: 100
    - path: "tests/helpers/temp-dir.ts"
      provides: "Temporary directory fixture"
      exports: ["createTestWorkspace", "cleanupWorkspace"]
    - path: "tests/helpers/mock-state.ts"
      provides: "State factory functions"
      exports: ["createMockState", "createMockPlanFrontmatter"]
    - path: "vitest.config.ts"
      provides: "Vitest configuration"
      contains: "test"
  key_links:
    - from: "tests/integration/workflow.test.ts"
      to: "src/state/state-manager.ts"
      via: "import StateManager"
      pattern: "import.*StateManager.*from"
    - from: "tests/integration/workflow.test.ts"
      to: "src/documents/templates/plan.ts"
      via: "import generatePlanMd"
      pattern: "import.*generatePlanMd.*from"
    - from: "tests/integration/workflow.test.ts"
      to: "src/sync/status-sync.ts"
      via: "import task status functions"
      pattern: "import.*markTaskComplete.*from"
---

<objective>
Create E2E workflow integration tests for the "Todo API" scenario

Purpose: Verify the complete Ultra Planner workflow from project initialization through plan execution, testing all major modules work together correctly.
Output: Working integration test suite with helper fixtures that validates document generation, state management, and task synchronization.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-integration-testing/08-RESEARCH.md

# Key source modules to test
@src/state/state-manager.ts
@src/state/checkpoint.ts
@src/documents/templates/plan.ts
@src/documents/templates/project.ts
@src/documents/templates/roadmap.ts
@src/sync/status-sync.ts
@src/sync/task-mapper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test infrastructure (vitest.config.ts + helpers)</name>
  <files>vitest.config.ts, tests/helpers/temp-dir.ts, tests/helpers/mock-state.ts</files>
  <action>
1. Create `vitest.config.ts` at project root:
   - Set `include: ['tests/**/*.test.ts']`
   - Configure `resolve.alias` for `@/` pointing to `src/`
   - Set `environment: 'node'`
   - Enable `globals: true` for describe/test/expect without imports

2. Create `tests/helpers/temp-dir.ts`:
   - Export `createTestWorkspace()`: Creates unique temp dir using `tmpdir() + Date.now() + Math.random()`
   - Export `cleanupWorkspace(dir: string)`: Removes directory with `rmSync(dir, { recursive: true, force: true })`
   - Use `node:fs`, `node:path`, `node:os` imports

3. Create `tests/helpers/mock-state.ts`:
   - Export `createMockState(overrides?)`: Returns StateData with defaults (phase: 1, currentPlan: '01-01', status: 'active')
   - Export `createMockPlanFrontmatter(overrides?)`: Returns valid PlanFrontmatter for testing
   - Export `createMockTaskDefinition(overrides?)`: Returns TaskDefinition for testing
   - Types should match `src/types.ts` definitions

Note: Use ES module imports (import from 'node:fs', etc.) to match project ESM configuration.
  </action>
  <verify>`npx vitest --help` runs without errors AND `npx tsc --noEmit tests/helpers/*.ts` passes</verify>
  <done>Vitest config exists, temp-dir helper creates/cleans directories, mock-state exports factory functions</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E workflow integration tests</name>
  <files>tests/integration/workflow.test.ts</files>
  <action>
Create comprehensive E2E tests that verify the "Todo API" workflow:

1. **Test Suite: State Management Integration**
   - Test: "should persist and read state via StateManager"
     - Create temp workspace
     - Instantiate StateManager with LOCAL location, overriding cwd to temp dir
     - Write state, read back, verify equality
   - Test: "should create and restore checkpoints"
     - Create state, create checkpoint, modify state
     - Restore checkpoint, verify original state recovered

2. **Test Suite: Document Generation Integration**
   - Test: "should generate valid PROJECT.md"
     - Use mock project metadata
     - Generate document via `generateProjectMd()`
     - Parse with gray-matter, validate frontmatter fields
   - Test: "should generate valid PLAN.md with tasks"
     - Use mock frontmatter and tasks
     - Generate via `generateCompletePlanMd()`
     - Parse and verify tasks array extracted correctly

3. **Test Suite: Task Sync Integration**
   - Test: "should update task status in PLAN.md frontmatter"
     - Create PLAN.md in temp dir
     - Call `markTaskInProgress()`, verify frontmatter updated
     - Call `markTaskComplete()`, verify status changed
   - Test: "should generate task IDs in correct format"
     - Use `generateTaskId()` from task-mapper
     - Verify format: `{phase}-{plan:02d}-{task:02d}`

4. **Test Suite: Full Workflow Simulation**
   - Test: "should simulate complete workflow: init -> plan -> execute"
     - Create PROJECT.md in temp workspace
     - Create ROADMAP.md with phases
     - Create STATE.md tracking current position
     - Generate PLAN.md for phase 1
     - Simulate task execution by updating task states
     - Verify all files exist with correct structure

Use `beforeEach` for workspace creation, `afterEach` for cleanup.
Import from `@/state/`, `@/documents/`, `@/sync/` using path aliases.
  </action>
  <verify>`npm test` runs and all tests pass (vitest run)</verify>
  <done>Workflow tests pass, covering state persistence, document generation, task sync, and full workflow simulation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes with all tests green
- [ ] Tests use isolated temp directories (no file conflicts)
- [ ] Tests cover: StateManager, document generation, task status sync
- [ ] No hardcoded paths (all use path.join)
- [ ] Cleanup runs even if tests fail (afterEach works)
</verification>

<success_criteria>

- Integration test suite exists at `tests/integration/workflow.test.ts`
- Test helpers exist at `tests/helpers/temp-dir.ts` and `tests/helpers/mock-state.ts`
- `npm test` runs successfully with all tests passing
- Tests validate the core workflow: state -> documents -> task sync
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-testing/08-01-SUMMARY.md`
</output>
