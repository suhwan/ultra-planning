---
phase: 02-core-planning
plan: 05
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - .claude/agents/ultraplan-planner.md
autonomous: true

must_haves:
  truths:
    - "Planner displays document summary after generation"
    - "Planner waits for explicit user approval before proceeding"
    - "User can adjust specific sections or restart"
    - "Approved documents trigger next-steps guidance"
  artifacts:
    - path: ".claude/agents/ultraplan-planner.md"
      provides: "Complete planner with review and approval workflow"
      contains: "PHASE 4: REVIEW AND APPROVAL"
      min_lines: 550
  key_links: []
---

<objective>
Add review and approval workflow to the Planner agent.

Purpose: Ensure users can review generated documents and provide explicit approval before any execution begins, preventing premature work on misunderstood requirements.

Output: Final `.claude/agents/ultraplan-planner.md` with complete workflow
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-planning/02-RESEARCH.md
@.planning/phases/02-core-planning/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Review and Approval Phase</name>
  <files>.claude/agents/ultraplan-planner.md</files>
  <action>
Add the review and approval workflow:

1. Summary Display Format:
```markdown
## PHASE 4: REVIEW AND APPROVAL

After generating PROJECT.md, ROADMAP.md, and STATE.md, ALWAYS display:

### Document Summary

```
## Project Summary

**Project:** {project_name}
**Core Value:** {core_value_statement}

**Documents Created:**
- PROJECT.md - {path}
- ROADMAP.md - {path}
- STATE.md - {path}

**Phases:** {N} phases with {M} estimated plans

**Phase Overview:**
1. {Phase 1 name} - {one-line goal}
2. {Phase 2 name} - {one-line goal}
...

**Critical Path:** {critical_path_phases}

**Key Constraints:**
- {constraint_1}
- {constraint_2}

---

**Does this capture your project correctly?**

Options:
- "proceed" or "looks good" - Start planning Phase 1
- "adjust {section}" - Modify specific part
- "restart" - Start over with fresh interview
```
```

2. Approval Gate:
```markdown
### Explicit Approval Required

**CRITICAL:** NEVER proceed without explicit user approval.

Wait for user response. Do NOT:
- Assume silence means approval
- Proceed after showing summary
- Start PLAN.md generation automatically

User must say one of:
- "proceed", "approved", "looks good", "yes" → Continue to Phase 1 planning
- "adjust X" → Modify and re-display
- "restart" → Clear and restart interview
```
  </action>
  <verify>
grep -c "REVIEW AND APPROVAL" .claude/agents/ultraplan-planner.md
grep -c "Explicit Approval" .claude/agents/ultraplan-planner.md
grep -c "NEVER proceed" .claude/agents/ultraplan-planner.md
  </verify>
  <done>Review and approval phase added with summary format and explicit approval gate</done>
</task>

<task type="auto">
  <name>Task 2: Add Adjustment Handling</name>
  <files>.claude/agents/ultraplan-planner.md</files>
  <action>
Add adjustment flow:

1. Adjustment Options:
```markdown
### Handling Adjustments

When user says "adjust {section}":

| Section | Action |
|---------|--------|
| "requirements" | Re-interview about scope, update PROJECT.md |
| "phases" | Re-decompose using goal-backward, update ROADMAP.md |
| "constraints" | Clarify limitations, update PROJECT.md |
| "scope" | Re-discuss boundaries, update both docs |
| "name" | Change project name in all docs |
| specific phase | Modify that phase's goal/criteria |

After adjustment:
1. Update the relevant document(s)
2. Re-display summary
3. Wait for approval again
```

2. Restart Handling:
```markdown
### Restart Flow

When user says "restart":

1. Ask confirmation: "This will discard current documents. Proceed? (yes/no)"
2. If confirmed:
   - Delete generated PROJECT.md, ROADMAP.md, STATE.md
   - Clear .ultraplan/ state
   - Return to PHASE 1: INTERVIEW MODE
3. If declined: Return to summary display
```

3. Cancel Handling:
```markdown
### Cancel Flow

When user says "cancel" or "quit":

1. If documents not yet generated:
   - Simply stop, inform user
2. If documents generated:
   - Ask: "Keep generated documents or delete them?"
   - If keep: Save and exit
   - If delete: Remove documents
```
  </action>
  <verify>
grep -c "Handling Adjustments" .claude/agents/ultraplan-planner.md
grep -c "Restart Flow" .claude/agents/ultraplan-planner.md
  </verify>
  <done>Adjustment, restart, and cancel flows documented</done>
</task>

<task type="auto">
  <name>Task 3: Add Next Steps Guidance</name>
  <files>.claude/agents/ultraplan-planner.md</files>
  <action>
Add next steps after approval:

1. Post-Approval Guidance:
```markdown
### After Approval

When user approves, display:

```
## Ready to Plan

Your project structure is set. Next steps:

1. **Plan Phase 1:** Run `/ultraplan:plan-phase 1`
   - This will create detailed PLAN.md files for Phase 1

2. **Check Status:** Run `/ultraplan:status`
   - See current progress and next actions

3. **Review Documents:**
   - PROJECT.md - Your project definition
   - ROADMAP.md - Phase breakdown
   - STATE.md - Progress tracking

**Tip:** Clear your context window before planning (`/clear`)
for fresh 200k tokens.

---
Proceed with `/ultraplan:plan-phase 1` when ready.
```
```

2. Output Artifacts Summary:
```markdown
### Planner Output Artifacts

By the end of a successful planning session:

**Created Files:**
- `PROJECT.md` - Project definition (root)
- `ROADMAP.md` - Phase breakdown (root)
- `STATE.md` - Progress tracking (root)
- `.ultraplan/config.json` - Configuration
- `.ultraplan/state/` - Session state directory
- `.ultraplan/logs/` - Execution logs directory

**Next Agent:** Phase planning via `/ultraplan:plan-phase N`
```

3. Structured Return:
```markdown
### Planner Return Format

When complete, return structured output:

```yaml
status: complete
documents_created:
  - path: PROJECT.md
    type: project
  - path: ROADMAP.md
    type: roadmap
  - path: STATE.md
    type: state
phases: {N}
estimated_plans: {M}
next_action: "/ultraplan:plan-phase 1"
```
```
  </action>
  <verify>
grep -c "After Approval" .claude/agents/ultraplan-planner.md
grep -c "Next steps" .claude/agents/ultraplan-planner.md
grep -c "plan-phase" .claude/agents/ultraplan-planner.md
  </verify>
  <done>Next steps guidance and structured return format added</done>
</task>

</tasks>

<verification>
1. Review phase section: `grep "REVIEW AND APPROVAL" .claude/agents/ultraplan-planner.md`
2. Explicit approval gate: `grep "NEVER proceed" .claude/agents/ultraplan-planner.md`
3. Adjustment handling: `grep "Handling Adjustments" .claude/agents/ultraplan-planner.md`
4. Next steps guidance: `grep "After Approval" .claude/agents/ultraplan-planner.md`
5. Structured return: `grep "status: complete" .claude/agents/ultraplan-planner.md`
6. File length: `wc -l .claude/agents/ultraplan-planner.md` (should be >= 550)
</verification>

<success_criteria>
- [ ] Review and approval phase section added
- [ ] Summary display format documented
- [ ] Explicit approval gate with NEVER proceed rule
- [ ] Adjustment handling for different sections
- [ ] Restart flow with confirmation
- [ ] Cancel flow with document cleanup option
- [ ] Next steps guidance after approval
- [ ] Structured return format for completion
- [ ] References to next command (/ultraplan:plan-phase)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-planning/02-05-SUMMARY.md`
</output>
