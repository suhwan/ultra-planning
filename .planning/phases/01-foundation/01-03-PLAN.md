---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - .claude/skills/ultraplan/templates/state.md
  - .claude/skills/ultraplan/references/state-protocol.md
autonomous: true

must_haves:
  truths:
    - "STATE.md template exists with progress tracking structure"
    - "Progress bar visualization is documented"
    - "Update protocol defines when/how STATE.md changes"
  artifacts:
    - path: ".claude/skills/ultraplan/templates/state.md"
      provides: "STATE.md generation template"
      contains: "Progress:"
    - path: ".claude/skills/ultraplan/references/state-protocol.md"
      provides: "State update rules and timing"
      contains: "## When to Update"
  key_links:
    - from: ".claude/skills/ultraplan/templates/state.md"
      to: "STATE.md (generated)"
      via: "Template instantiation"
      pattern: "Progress:.*\\[.*\\]"
---

<objective>
Create STATE.md template and define update protocols for progress tracking.

Purpose: STATE.md is the single source of truth for project progress. It enables session continuity (knowing where you left off) and provides visual progress feedback. The update protocol ensures consistency.

Output: STATE.md template and state-protocol.md reference document.
</objective>

<context>
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

Key patterns from research:
- STATE.md is human-readable, git-diffable
- Progress bar: `[##░░░░░░░░]` format (20 chars)
- Session continuity includes: last session, stopped at, resume file
- Derived from filesystem state (SUMMARY.md exists = plan complete)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create STATE.md template</name>
  <files>.claude/skills/ultraplan/templates/state.md</files>
  <action>
    Create `.claude/skills/ultraplan/templates/state.md`:

    ```markdown
    # Project State

    ## Project Reference

    See: PROJECT.md (updated {date})

    **Core value:** {core_value}
    **Current focus:** Phase {current_phase} - {phase_name}

    ## Current Position

    Phase: {current_phase} of {total_phases} ({phase_name})
    Plan: {current_plan} of {plans_in_phase} in current phase
    Status: {status}
    Last activity: {date} - {activity_description}

    Progress: [{progress_bar}] {percentage}%

    ## Performance Metrics

    **Velocity:**
    - Total plans completed: {total_completed}
    - Average duration: {avg_duration}
    - Total execution time: {total_time}

    **By Phase:**

    | Phase | Plans | Total | Avg/Plan |
    |-------|-------|-------|----------|
    | - | - | - | - |

    **Recent Trend:**
    - Last 5 plans: {durations}
    - Trend: {trend_direction}

    *Updated after each plan completion*

    ## Accumulated Context

    ### Decisions

    Decisions are logged in PROJECT.md Key Decisions table.
    Recent decisions affecting current work:

    - {decision_summary}

    ### Pending Todos

    {todos_or_none}

    ### Blockers/Concerns

    - {blocker_or_none}

    ## Session Continuity

    Last session: {datetime}
    Stopped at: {description}
    Resume file: {path_or_none}

    ---
    *State initialized: {date}*
    *Next action: {next_action}*
    ```

    Progress bar format:
    - 20 characters total
    - Use '#' for completed, '░' for remaining
    - Example: `[####░░░░░░░░░░░░░░░░]` = 20%
    - Calculate: completed_plans / total_plans * 20

    Status values: "Ready to plan", "Planning", "In progress", "Verifying", "Complete"
  </action>
  <verify>cat .claude/skills/ultraplan/templates/state.md | grep -E "Progress:|Phase:|Status:"</verify>
  <done>state.md template exists with Progress bar, Phase tracking, Status field, and Session Continuity section</done>
</task>

<task type="auto">
  <name>Task 2: Create state update protocol reference</name>
  <files>.claude/skills/ultraplan/references/state-protocol.md</files>
  <action>
    Create `.claude/skills/ultraplan/references/` directory if needed.

    Create `.claude/skills/ultraplan/references/state-protocol.md`:

    ```markdown
    # STATE.md Update Protocol

    ## When to Update

    STATE.md is updated at these events:

    | Event | Fields Updated |
    |-------|----------------|
    | Project initialized | All fields (initial values) |
    | Phase planning started | Status -> "Planning", Current focus |
    | Plan execution started | Status -> "In progress", Current plan |
    | Plan completed | Progress bar, Plans completed, Metrics |
    | Phase completed | Phase number, Reset current plan |
    | Blocker encountered | Blockers/Concerns section |
    | Decision made | Reference to PROJECT.md decision |
    | Session ended | Session Continuity section |

    ## Progress Calculation

    ```
    total_plans = sum(plans_in_each_phase)
    completed_plans = count(SUMMARY.md files exist)
    percentage = floor(completed_plans / total_plans * 100)
    bar_filled = floor(percentage / 5)  # 20 chars = 5% each
    progress_bar = '#' * bar_filled + '░' * (20 - bar_filled)
    ```

    ## Status Values

    | Status | When |
    |--------|------|
    | Ready to plan | Phase directory exists, no PLAN.md yet |
    | Planning | PLAN.md being created |
    | In progress | Executing tasks from PLAN.md |
    | Verifying | Architect/Critic reviewing |
    | Complete | SUMMARY.md exists for all plans in phase |

    ## Deriving State from Filesystem

    STATE.md should be verifiable against actual files:

    - Phase N complete: `.planning/phases/NN-*/` has all SUMMARY.md files
    - Plan complete: `{phase}-{plan}-SUMMARY.md` exists
    - In progress: PLAN.md exists but no SUMMARY.md

    If STATE.md diverges from filesystem, filesystem is source of truth.

    ## Session Continuity

    On abnormal exit (crash, timeout, user interrupt):
    1. Create `.ultraplan/state/continue.md` with:
       - Last executed task
       - Partial results
       - Next steps
    2. Update STATE.md "Resume file" field

    On next session start:
    1. Check for continue.md
    2. Offer to resume or start fresh
    3. Clear continue.md after successful resume
    ```
  </action>
  <verify>cat .claude/skills/ultraplan/references/state-protocol.md | grep -E "## When to Update|## Progress Calculation"</verify>
  <done>state-protocol.md exists with update triggers, progress calculation formula, status values, and session continuity rules</done>
</task>

</tasks>

<verification>
1. Template exists: `ls .claude/skills/ultraplan/templates/state.md`
2. Protocol exists: `ls .claude/skills/ultraplan/references/state-protocol.md`
3. Progress bar documented: `grep "Progress:" .claude/skills/ultraplan/templates/state.md`
4. Update events documented: `grep -c "Event" .claude/skills/ultraplan/references/state-protocol.md`
</verification>

<success_criteria>
- [ ] `state.md` template has Progress bar with 20-char format
- [ ] `state.md` template has Session Continuity section
- [ ] `state-protocol.md` defines all update trigger events
- [ ] `state-protocol.md` has progress calculation formula
- [ ] `state-protocol.md` defines all status values
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
