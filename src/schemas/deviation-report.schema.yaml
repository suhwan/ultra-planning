# Deviation Report Schema
# Defines executor deviation from original plan

$schema: "http://json-schema.org/draft-07/schema#"
title: DeviationReport
description: Report when executor deviates from the original plan

type: object
required:
  - level
  - taskId
  - timestamp
  - originalPlan
  - actualImplementation
  - reason

properties:
  level:
    type: integer
    enum: [1, 2, 3]
    description: |
      Deviation severity level:
      1 = Informational - Log to DEVIATION.md only
      2 = Requires Approval - Architect quick review before proceeding
      3 = Plan Modification - Trigger plan revision workflow

  taskId:
    type: string
    pattern: "^\\d{2}-\\d{2}-\\d{2}$"
    description: Task identifier where deviation occurred

  timestamp:
    type: string
    format: date-time
    description: ISO 8601 timestamp of deviation report

  originalPlan:
    type: string
    minLength: 10
    maxLength: 1000
    description: What was originally planned for this task

  actualImplementation:
    type: string
    minLength: 10
    maxLength: 1000
    description: What was actually implemented

  reason:
    type: string
    minLength: 20
    maxLength: 500
    description: Reason for the deviation

  impact:
    type: string
    enum:
      - none    # No impact on other tasks
      - minor   # Small adjustments may be needed
      - major   # Significant changes to downstream tasks
    default: none
    description: Impact assessment on the overall plan

  requiresPlanModification:
    type: boolean
    default: false
    description: Whether the plan document needs updating

  affectedTasks:
    type: array
    items:
      type: string
      pattern: "^\\d{2}-\\d{2}-\\d{2}$"
    description: List of downstream tasks affected by this deviation

  architectApproval:
    type: object
    properties:
      approved:
        type: boolean
      approvedAt:
        type: string
        format: date-time
      approvedBy:
        type: string
      notes:
        type: string
    description: Architect approval (for Level 2 deviations)

# Level definitions
x-level-definitions:
  1:
    name: Informational
    description: Minor deviation, no approval needed
    action: Log to DEVIATION.md only
    examples:
      - Using a slightly different library version
      - Minor code style adjustments
      - Additional error handling not in plan

  2:
    name: Requires Approval
    description: Moderate deviation, needs Architect sign-off
    action: Architect quick review before proceeding
    examples:
      - Different algorithm than planned
      - Additional file created not in plan
      - Changed interface signature

  3:
    name: Plan Modification
    description: Major deviation, plan needs update
    action: Trigger plan revision workflow
    examples:
      - Feature split into multiple tasks
      - Dependency discovered requiring new task
      - Blocking issue requiring approach change

examples:
  - level: 1
    taskId: "06-01-02"
    timestamp: "2026-01-31T11:00:00Z"
    originalPlan: "Use bcrypt for password hashing"
    actualImplementation: "Used argon2 for password hashing"
    reason: "argon2 is more secure and recommended for new projects"
    impact: none
    requiresPlanModification: false

  - level: 2
    taskId: "06-01-03"
    timestamp: "2026-01-31T11:30:00Z"
    originalPlan: "Add user validation middleware"
    actualImplementation: "Created validation middleware + added rate limiting"
    reason: "Discovered rate limiting is essential for the validation endpoint"
    impact: minor
    requiresPlanModification: false
    affectedTasks: []
    architectApproval:
      approved: true
      approvedAt: "2026-01-31T11:35:00Z"
      approvedBy: "architect-agent"
      notes: "Rate limiting is a good addition"

  - level: 3
    taskId: "06-01-04"
    timestamp: "2026-01-31T12:00:00Z"
    originalPlan: "Implement OAuth2 login flow"
    actualImplementation: "Started OAuth2 but discovered need for session management first"
    reason: "OAuth2 requires session infrastructure that doesn't exist yet"
    impact: major
    requiresPlanModification: true
    affectedTasks:
      - "06-01-05"
      - "06-01-06"
